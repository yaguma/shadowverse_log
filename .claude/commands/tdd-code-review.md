---
description: TDD開発で生成されたコードの品質をレビューします。セキュリティ、パフォーマンス、SOLID原則、日本語コメント品質などを多角的に評価します。
---

# TDD コードレビュー

TDD開発で生成されたコードの品質を多角的にレビューし、改善点を構造化されたレポートとして出力します。

## レビューモード

このコマンドは3つのレビューモードをサポートしています：

### モード1: 全体レビュー（デフォルト）
- TDD開発で生成された全コードをレビュー
- memo/green-phase/refactor-phaseファイルを参照
- 使用例: `/tdd-code-review`

### モード2: 差分レビュー
- `git diff` で変更されたファイルのみをレビュー
- 使用例: `/tdd-code-review --diff` または `/tdd-code-review --changes`

### モード3: コミットIDレビュー
- 指定されたコミットIDの変更内容をレビュー
- 使用例:
  - `/tdd-code-review --commit abc1234`
  - `/tdd-code-review --commit-range abc1234..def5678`

## 事前準備

レビューコンテキストの準備を行います：

1. **追加ルールの読み込み**
   - `AGENTS.md` ファイルが存在する場合は読み込み
   - `docs/rule` ディレクトリが存在する場合は読み込み
   - `docs/rule/tdd` ディレクトリが存在する場合は読み込み
   - `docs/rule/tdd/code-review` ディレクトリが存在する場合は読み込み
   - 各ディレクトリ内のすべてのファイルを読み込み、追加ルールとして適用

2. **@agent-symbol-searcher でレビュー関連情報を検索し、見つかったファイルを読み込み**
   - 既存のコードスタイルやベストプラクティスを検索し、スタイルガイドをReadツールで読み込み
   - プロジェクト全体のアーキテクチャパターンを特定し、設計文書をReadツールで読み込み
   - セキュリティガイドラインやパフォーマンス基準を確認し、関連ファイルをReadツールで読み込み

3. **関連ファイルを直接読み込み**
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-memo.md` - 開発履歴を確認
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-requirements.md` - 要件定義を確認
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-testcases.md` - テストケース定義を確認
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-green-phase.md` - Greenフェーズの実装を確認
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-refactor-phase.md` - Refactorフェーズの実装を確認

4. **レビュー対象ファイルの特定**
   - モードに応じてレビュー対象ファイルを特定
   - 全体レビュー: TDD開発で生成された全コードファイル
   - 差分レビュー: `git diff --name-only` で変更されたファイル
   - コミットIDレビュー: `git show --name-only {commit_id}` で変更されたファイル

読み込み完了後、準備されたコンテキスト情報を基にコードレビューを開始します。

## 信頼性レベル指示

レビュー指摘には、各内容について元の資料との照合状況を以下の信号でマークしてください：

- 🔵 **青信号**: 元の資料（要件定義・設計文書・ガイドライン）に基づく指摘
- 🟡 **黄信号**: 元の資料から妥当な推測に基づく指摘
- 🔴 **赤信号**: 元の資料にない推測に基づく指摘（一般的なベストプラクティス）

## レビュー観点（7つの主要カテゴリ）

### 1. セキュリティレビュー

以下の観点でセキュリティリスクを評価してください：

- **SQLインジェクション対策**: パラメータ化クエリの使用、エスケープ処理
- **XSS対策**: 出力エスケープ、Content Security Policy
- **CSRF対策**: トークン検証、SameSite Cookie
- **入力値検証**: ホワイトリスト検証、型チェック、長さ制限
- **認証・認可の適切性**: セッション管理、アクセス制御
- **機密情報の取り扱い**: 暗号化、ログへの出力禁止、環境変数管理

### 2. パフォーマンスレビュー

以下の観点でパフォーマンスを評価してください：

- **アルゴリズム計算量**: 時間計算量（O記法）、空間計算量
- **メモリ使用量**: メモリリーク、不要なオブジェクト保持
- **N+1問題**: データベースクエリの効率性
- **不要な処理・ループ**: 冗長な計算、無駄な繰り返し
- **キャッシュ戦略**: 適切なキャッシュの活用
- **非同期処理**: ブロッキング処理の回避

### 3. コード品質レビュー

以下の観点でコード品質を評価してください：

- **命名規則**: 変数名、関数名、クラス名の明確さと一貫性
- **DRY原則の遵守**: コードの重複、共通化の機会
- **複雑度**: 循環的複雑度、ネストの深さ
- **ファイルサイズ**: 800行制限の遵守
- **コードの構造と可読性**: 論理的な構成、適切な分割

### 4. SOLID原則レビュー

以下の原則への準拠を評価してください：

- **単一責任原則 (SRP)**: 1つのクラス/関数は1つの責任のみを持つ
- **オープン・クローズド原則 (OCP)**: 拡張に対して開いていて、修正に対して閉じている
- **リスコフの置換原則 (LSP)**: 派生クラスは基底クラスと置換可能である
- **インターフェース分離原則 (ISP)**: 使用しないメソッドへの依存を強制しない
- **依存性逆転原則 (DIP)**: 抽象に依存し、具象に依存しない

### 5. テスト品質レビュー

以下の観点でテスト品質を評価してください：

- **テストカバレッジ**: 主要パスの網羅、境界値のテスト
- **テストの独立性**: 他のテストへの依存がない
- **エッジケースの網羅**: 異常系、境界条件のテスト
- **モックの適切な使用**: テストコード内のみでモックを使用
- **Given-When-Then形式**: テストの構造が明確
- **テスト名の明確さ**: 何をテストしているか一目で分かる

### 6. 日本語コメント品質レビュー

以下の観点で日本語コメントを評価してください：

- **関数・メソッドレベルコメント**: 機能概要、実装方針、テスト対応の記載
- **処理ブロックレベルコメント**: 入力値検証、データ処理、エラー処理の説明
- **信頼性レベル（🔵🟡🔴）の付与**: 各コメントに信頼性レベルが付与されている
- **コメントの具体性と有用性**: 「何を」だけでなく「なぜ」も説明されている
- **JSDoc形式**: @param, @returns の適切な使用

### 7. エラーハンドリングレビュー

以下の観点でエラーハンドリングを評価してください：

- **入力値検証の完全性**: すべての入力に対する検証
- **エラーメッセージの明確さ**: ユーザーにとって分かりやすいメッセージ
- **例外処理の適切性**: 適切な例外のキャッチと処理
- **リカバリー戦略**: エラー発生時の復旧方法
- **ログ出力**: デバッグに必要な情報のログ

## 問題の重要度分類

発見した問題を以下の重要度で分類してください：

```
🔴 Critical（致命的）: 即時修正必須
  - セキュリティ脆弱性（SQLインジェクション、XSS、認証バイパス等）
  - データ損失リスク（未保存、上書き、削除等）
  - 本番障害の可能性（クラッシュ、無限ループ、メモリリーク等）
  - 機能の完全な欠陥

🟡 Warning（警告）: 早期修正推奨
  - パフォーマンス問題（N+1、非効率なアルゴリズム等）
  - 保守性の問題（複雑すぎるコード、重複等）
  - SOLID原則違反
  - テストカバレッジ不足
  - エラーハンドリング不足

🔵 Info（情報）: 改善推奨
  - コメント不足
  - 命名改善の余地
  - コードスタイルの統一
  - リファクタリングの機会
  - ドキュメント改善
```

## レビューレポート出力形式

レビュー完了後、以下の形式でレポートを出力してください：

```markdown
# コードレビューレポート

**レビュー日時**: [YYYY-MM-DD HH:MM:SS]
**レビューモード**: [全体/差分/コミットID]
**対象ファイル数**: [数]個
**対象機能**: {{feature_name}}
**タスクID**: {{task_id}}

---

## 📊 サマリー

| 観点 | 評価 | Critical | Warning | Info |
|------|------|----------|---------|------|
| セキュリティ | ✅/⚠️/❌ | 0 | 0 | 0 |
| パフォーマンス | ✅/⚠️/❌ | 0 | 0 | 0 |
| コード品質 | ✅/⚠️/❌ | 0 | 0 | 0 |
| SOLID原則 | ✅/⚠️/❌ | 0 | 0 | 0 |
| テスト品質 | ✅/⚠️/❌ | 0 | 0 | 0 |
| 日本語コメント | ✅/⚠️/❌ | 0 | 0 | 0 |
| エラーハンドリング | ✅/⚠️/❌ | 0 | 0 | 0 |

**総合評価**: ✅ 高品質 / ⚠️ 要改善 / ❌ 要修正

---

## 🔴 Critical Issues（即時修正必須）

### C-001: [問題タイトル]
- **カテゴリ**: [セキュリティ/パフォーマンス/etc]
- **ファイル**: [ファイルパス:行番号]
- **問題内容**: [具体的な問題の説明]
- **影響範囲**: [この問題が引き起こす可能性のある影響]
- **推奨修正**: [具体的な修正方法]
- **信頼性レベル**: 🔵/🟡/🔴

---

## 🟡 Warning Issues（早期修正推奨）

### W-001: [問題タイトル]
- **カテゴリ**: [セキュリティ/パフォーマンス/etc]
- **ファイル**: [ファイルパス:行番号]
- **問題内容**: [具体的な問題の説明]
- **推奨修正**: [具体的な修正方法]
- **信頼性レベル**: 🔵/🟡/🔴

---

## 🔵 Info Issues（改善推奨）

### I-001: [問題タイトル]
- **カテゴリ**: [コメント/命名/スタイル/etc]
- **ファイル**: [ファイルパス:行番号]
- **問題内容**: [具体的な問題の説明]
- **推奨改善**: [具体的な改善方法]
- **信頼性レベル**: 🔵/🟡/🔴

---

## ✅ 良い点

レビュー対象コードの優れている点を記載します：

1. **[良い点のタイトル]**: [具体的な説明]
2. **[良い点のタイトル]**: [具体的な説明]

---

## 📝 推奨アクション

優先度順に修正すべき項目をリストアップします：

### 最優先（Critical対応）
1. [具体的なアクション]
2. [具体的なアクション]

### 高優先（Warning対応）
1. [具体的なアクション]
2. [具体的なアクション]

### 中優先（Info対応）
1. [具体的なアクション]
2. [具体的なアクション]

---

## 次のステップ

[品質判定に基づく次のステップを記載]
```

## レビュー結果の保存

レビュー完了後、以下の手順でレビュー結果を保存してください：

1. **保存先ディレクトリの作成**
   - `docs/code-reviews/{要件名}/{{task_id}}/` ディレクトリを作成（存在しない場合）

2. **レビューレポートファイルの作成**
   - ファイル名: `{feature_name}-review-{YYYYMMDD-HHMMSS}.md`
   - 上記のレポート形式でファイルを作成

3. **メモファイルへの記録**
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-memo.md` にレビュー実施の記録を追記

## 品質判定基準

```
✅ 高品質:
- Critical問題: 0件
- セキュリティ脆弱性: なし
- パフォーマンス重大課題: なし
- 日本語コメント: 十分（関数レベル・処理ブロックレベルともに存在）
- テストカバレッジ: 主要パスを網羅

⚠️ 要改善:
- Critical問題: 1件以上
- または Warning問題: 5件以上
- または 日本語コメント不足
- または テストカバレッジ不足
```

## 次のステップ表示

レビュー結果に応じて次のステップを表示してください：

### Critical問題がある場合
```
⚠️ Critical問題が検出されました。即時修正が必要です。

次のお勧めステップ:
1. `/tdd-code-review-fix` でレビュー結果に基づいて修正を実行
2. 修正後、再度 `/tdd-code-review` でレビューを実行
```

### Warning問題のみの場合
```
⚠️ Warning問題が検出されました。早期修正を推奨します。

次のお勧めステップ:
1. `/tdd-code-review-fix` でレビュー結果に基づいて修正を実行
2. または `/tdd-verify-complete` で完全性検証に進む（修正は後で対応）
```

### 問題なしの場合
```
✅ レビュー完了。重大な問題は検出されませんでした。

次のお勧めステップ: `/tdd-verify-complete` で完全性検証に進んでください。
```

## TODO更新パターン

```
- 現在のTODO「コードレビュー」を「completed」にマーク
- レビュー結果の概要をTODO内容に記録
- Critical/Warning問題がある場合は「コードレビュー修正」をTODOに追加
- 次のフェーズをTODOに追加
```

## 注意事項

- **この工程では修正を行わない**: レビューと記録に専念する
- **客観的な評価**: 感情的な表現を避け、事実に基づいた指摘を行う
- **具体的な指摘**: 抽象的な指摘ではなく、ファイル名・行番号・具体的なコードを示す
- **建設的なフィードバック**: 問題点だけでなく、良い点も記載する
- **優先度の明確化**: 全ての問題を同列に扱わず、重要度で分類する
