---
description: 承認された要件定義書に基づいて、ゲーム開発向け技術設計文書を生成する。システムアーキテクチャ、ゲームメカニクス、データフロー、UI設計、データスキーマを含む包括的な設計を行う。
---

# game-design

## 目的

承認された要件定義書に基づいて、ゲーム開発向け技術設計文書を生成する。システムアーキテクチャ、ゲームメカニクス、データフロー、UI設計、データスキーマを含む包括的な設計を行う。

## 前提条件

- `docs/spec/` に要件定義書が存在する
- 要件がユーザによって承認されている
- 対象プラットフォーム・ゲームエンジンが明確になっている

## 事前準備

1. **追加ルールの読み込み**
   - `docs/rule` ディレクトリが存在する場合は読み込み
   - `docs/rule/kairo` ディレクトリが存在する場合は読み込み
   - `docs/rule/game-design` ディレクトリが存在する場合は読み込み
   - 各ディレクトリ内のすべてのファイルを読み込み、追加ルールとして適用

## 実行内容

**【信頼性レベル指示】**:
各項目について、元の資料（EARS要件定義書・設計文書含む）との照合状況を以下の信号でコメントしてください：

- 🔵 **青信号**: EARS要件定義書・設計文書を参考にしてほぼ推測していない場合
- 🟡 **黄信号**: EARS要件定義書・設計文書から妥当な推測の場合
- 🔴 **赤信号**: EARS要件定義書・設計文書にない推測の場合

2. **技術スタック定義の読み込み**
   - `docs/tech-stack.md` が存在する場合は読み込み
   - 存在しない場合は `CLAUDE.md` から技術スタックセクションを読み込み
   - どちらも存在しない場合は `.claude/commands/tech-stack.md` のデフォルト定義を使用
   - **ゲームエンジン判定**: Unity / Godot / Unreal Engine / その他を特定
   - **プログラミング言語判定**: C# / GDScript / C++ / Lua / Python 等を特定

3. **要件の分析**
   - @agent-symbol-searcher で要件定義書を検索し、見つかったファイルをReadツールで読み込み
   - @agent-symbol-searcher で関連する既存設計文書を確認し、見つかったファイルをReadツールで読み込み
   - 読み込んだ技術スタック定義に基づいて技術選択を決定
   - 機能要件と非機能要件を整理する
   - ゲームシステムの境界を明確にする

4. **アーキテクチャ設計**
   - システム全体のアーキテクチャを決定
   - レイヤー構造の設計（Presentation / Application / Domain / Infrastructure）
   - コアシステムの分割と責務の定義
   - シーン（ステート）構成の設計

5. **データフロー図の作成**
   - Mermaid記法でゲームフローを可視化
   - プレイヤーインタラクションの流れ
   - システム間のデータの流れ
   - 状態遷移図（シーン遷移、ゲームステート遷移）

6. **コアシステム設計**
   - ゲーム固有のコアシステムを設計（例: カードシステム、戦闘システム、インベントリシステム等）
   - 各システムのクラス図・責務を定義
   - システム間の依存関係を明確化

7. **ゲームメカニクス設計**
   - コアゲームループの定義
   - ゲームルールの明文化
   - 勝利/敗北条件
   - 計算式・数値バランスの基礎設計

8. **バランス設計**
   - パラメータ設計の方針
   - 難易度曲線の設計
   - 経済バランス（通貨・リソース）
   - 調整ガイドライン

9. **UI設計（階層化）**
   - 画面一覧と画面遷移図を作成
   - 共通UIコンポーネントの定義
   - デザイン規約（カラーパレット、フォント等）
   - 各画面の詳細設計（ワイヤーフレーム、UI要素、状態、アニメーション、イベント）
   - 入力システム設計（キーバインド、コントローラー対応）
   - アクセシビリティ要件

10. **データスキーマの設計**
    - セーブデータ構造（JSON形式）
    - マスターデータ構造（JSON/ScriptableObject形式）
    - データのロード/セーブタイミング

11. **言語固有インターフェース定義（オプション）**
    - NEVER 対象言語がインターフェース定義不要の場合は生成しない
    - Unity (C#) の場合: `interfaces.cs`
    - Godot (GDScript) の場合: `interfaces.gd`
    - Unreal Engine (C++) の場合: `interfaces.h`

12. **オーディオ設計（オプション）**
    - NEVER 要件にオーディオ要件がない場合は生成しない
    - BGM/SE設計
    - サウンドイベント定義
    - ボリューム設定

13. **ファイルの作成**
    - `docs/design/{要件名}/` ディレクトリに以下を作成：
      - `architecture.md` - システムアーキテクチャ
      - `core-systems.md` - コアシステム設計
      - `dataflow.md` - ゲームフロー・データフロー図
      - `game-mechanics.md` - ゲームメカニクス設計
      - `balance-design.md` - バランス設計
      - `ui-design/overview.md` - UI設計概要
      - `ui-design/screens/{画面名}.md` - 各画面詳細設計
      - `ui-design/input-system.md` - 入力システム設計
      - `data-schema.md` - データスキーマ
      - `interfaces.{拡張子}` - インターフェース定義（オプション）
      - `audio-design.md` - オーディオ設計（オプション）

## 出力フォーマット例

### architecture.md

```markdown
# システムアーキテクチャ設計

## システム概要

{ゲームの概要説明}

## アーキテクチャパターン

- パターン: {選択したパターン（例: Clean Architecture, MVC等）}
- 理由: {選択理由}

## レイヤー構造

\`\`\`
┌─────────────────────────────────────────────┐
│          Presentation Layer                 │
│  (UI/View/MonoBehaviour Components)         │
│  - SceneControllers                         │
│  - UIViews                                  │
│  - AnimationControllers                     │
└─────────────────────────────────────────────┘
                    ↓↑
┌─────────────────────────────────────────────┐
│         Application Layer                   │
│  (Game Logic/State Management)              │
│  - GameManager                              │
│  - StateManager                             │
│  - EventBus                                 │
└─────────────────────────────────────────────┘
                    ↓↑
┌─────────────────────────────────────────────┐
│           Domain Layer                      │
│  (Business Logic/Core Systems)              │
│  - {CoreSystem1}                            │
│  - {CoreSystem2}                            │
└─────────────────────────────────────────────┘
                    ↓↑
┌─────────────────────────────────────────────┐
│      Infrastructure Layer                   │
│  (Data Access/External Systems)             │
│  - SaveDataRepository                       │
│  - ConfigDataLoader                         │
│  - RandomGenerator                          │
└─────────────────────────────────────────────┘
\`\`\`

## コンポーネント図

\`\`\`mermaid
graph TB
    subgraph "Presentation"
        UI[UIManager]
        Scene[SceneController]
    end

    subgraph "Application"
        GM[GameManager]
        SM[StateManager]
        EB[EventBus]
    end

    subgraph "Domain"
        Sys1[{CoreSystem1}]
        Sys2[{CoreSystem2}]
    end

    subgraph "Infrastructure"
        SaveRepo[SaveDataRepository]
        Config[ConfigDataLoader]
    end

    UI --> GM
    Scene --> GM
    GM --> SM
    SM --> Sys1
    SM --> Sys2
    Sys1 --> SaveRepo
    Sys1 --> Config
\`\`\`

## シーン構成

| シーン名 | 説明 | 主要な要素 |
|---------|------|-----------|
| **BootScene** | 初期化・ロード画面 | - 設定データ読み込み<br>- セーブデータ確認 |
| **TitleScene** | タイトル画面 | - 新規ゲーム<br>- コンティニュー<br>- 設定 |
| **{GameScene}** | メインゲーム画面 | - {主要要素} |
| **ResultScene** | リザルト画面 | - スコア表示<br>- 報酬獲得 |

## シーン遷移図

\`\`\`mermaid
stateDiagram-v2
    [*] --> BootScene
    BootScene --> TitleScene
    TitleScene --> {GameScene}: 新規ゲーム
    TitleScene --> {GameScene}: コンティニュー
    {GameScene} --> ResultScene: クリア/敗北
    ResultScene --> TitleScene
\`\`\`
```

### core-systems.md

```markdown
# コアシステム設計

## システム一覧

| システム名 | 責務 | 依存システム |
|-----------|------|-------------|
| {System1} | {責務の説明} | - |
| {System2} | {責務の説明} | {System1} |

## {System1} 詳細設計

### 責務

{システムの責務を説明}

### クラス図

\`\`\`mermaid
classDiagram
    class I{System1} {
        <<interface>>
        +Method1()
        +Method2()
    }

    class {System1}Impl {
        -field1
        -field2
        +Method1()
        +Method2()
    }

    I{System1} <|.. {System1}Impl
\`\`\`

### 主要メソッド

| メソッド名 | 引数 | 戻り値 | 説明 |
|-----------|------|--------|------|
| Method1 | param1: Type | ReturnType | {説明} |
```

### dataflow.md

```markdown
# データフロー図

## ゲーム全体のフロー

\`\`\`mermaid
flowchart TD
    Start[ゲーム起動] --> LoadConfig[設定データ読み込み]
    LoadConfig --> LoadSave{セーブデータ存在?}
    LoadSave -->|Yes| LoadData[セーブデータ読み込み]
    LoadSave -->|No| NewGame[新規ゲームデータ作成]
    LoadData --> Title[タイトル画面]
    NewGame --> Title

    Title --> GameStart[ゲーム開始]
    GameStart --> MainLoop[メインループ]
    MainLoop --> CheckEnd{終了条件?}
    CheckEnd -->|No| MainLoop
    CheckEnd -->|Yes| Result[リザルト画面]
    Result --> Save[セーブ]
    Save --> Title
\`\`\`

## {特定機能}のデータフロー

\`\`\`mermaid
sequenceDiagram
    participant Player
    participant UI
    participant System1
    participant System2
    participant Repository

    Player->>UI: アクション
    UI->>System1: 処理リクエスト
    System1->>System2: データ取得
    System2-->>System1: データ返却
    System1->>Repository: データ保存
    System1-->>UI: 結果返却
    UI-->>Player: 画面更新
\`\`\`
```

### game-mechanics.md

```markdown
# ゲームメカニクス設計

## コアゲームループ

\`\`\`mermaid
flowchart LR
    A[プレイヤー入力] --> B[状態更新]
    B --> C[結果判定]
    C --> D[フィードバック]
    D --> A
\`\`\`

## 基本ルール

### ゲーム目標
{プレイヤーが達成すべき目標}

### 基本的な遊び方
1. {ステップ1}
2. {ステップ2}
3. {ステップ3}

## 勝利条件

| 条件名 | 説明 | 判定タイミング |
|--------|------|---------------|
| {条件1} | {説明} | {タイミング} |

## 敗北条件

| 条件名 | 説明 | 判定タイミング |
|--------|------|---------------|
| {条件1} | {説明} | {タイミング} |

## 計算式

### {計算名1}

\`\`\`
結果 = 基礎値 × 係数 + ボーナス
\`\`\`

| パラメータ | 説明 | 範囲 |
|-----------|------|------|
| 基礎値 | {説明} | {範囲} |
| 係数 | {説明} | {範囲} |
| ボーナス | {説明} | {範囲} |

## ゲームシステム相互作用

\`\`\`mermaid
graph LR
    A[{System1}] -->|影響| B[{System2}]
    B -->|フィードバック| C[{System3}]
    C -->|結果| A
\`\`\`
```

### balance-design.md

```markdown
# バランス設計

## 設計方針

{バランス設計の基本方針}

## 難易度曲線

\`\`\`
難易度
  ↑
  │    ╭───╮
  │   ╱     ╲    ╭──
  │  ╱       ╲__╱
  │ ╱
  │╱
  └──────────────────→ 進行度
      序盤   中盤   終盤
\`\`\`

### 序盤（0-33%）
- 目標: {目標}
- 難易度: {低/中/高}
- 重点: {チュートリアル/基本操作の習得}

### 中盤（34-66%）
- 目標: {目標}
- 難易度: {低/中/高}
- 重点: {戦略の深化/システムの拡張}

### 終盤（67-100%）
- 目標: {目標}
- 難易度: {低/中/高}
- 重点: {マスタリー/チャレンジ}

## パラメータ設計

### 基本パラメータ

| パラメータ | 初期値 | 最小値 | 最大値 | 増加率 | 備考 |
|-----------|--------|--------|--------|--------|------|
| {param1} | {value} | {min} | {max} | {rate} | {note} |

### 経済バランス

| リソース名 | 獲得手段 | 消費手段 | 期待獲得量/時間 |
|-----------|----------|----------|-----------------|
| {resource1} | {獲得方法} | {消費方法} | {量} |

## 調整ガイドライン

### 調整の優先順位
1. {最優先項目}
2. {次点項目}
3. {その他}

### 調整時の注意点
- {注意点1}
- {注意点2}
```

### ui-design/overview.md

```markdown
# UI設計概要

## 画面一覧

| 画面ID | 画面名 | 説明 | 詳細ファイル |
|--------|--------|------|-------------|
| SCR-001 | タイトル画面 | ゲーム起動時の初期画面 | [title.md](screens/title.md) |
| SCR-002 | {画面名} | {説明} | [{file}.md](screens/{file}.md) |

## 画面遷移図

\`\`\`mermaid
stateDiagram-v2
    [*] --> SCR_001_Title
    SCR_001_Title --> SCR_002_{Screen}: {トリガー}
    SCR_002_{Screen} --> SCR_001_Title: {トリガー}
\`\`\`

## 共通UIコンポーネント

### ボタン
- **プライマリボタン**: 確定アクション（決定、開始など）
- **セカンダリボタン**: キャンセル、戻るなどの副次アクション
- **危険ボタン**: 削除など不可逆アクション（確認ダイアログ必須）

### ダイアログ
- **確認ダイアログ**: ユーザーの意思確認が必要な場合
- **情報ダイアログ**: 情報提示（閉じるボタンのみ）
- **エラーダイアログ**: エラー表示と対処法の提示

### トランジション
- **フェードイン/アウト**: 画面遷移時のデフォルト
- **スライドイン/アウト**: サブ画面の表示/非表示

## デザイン規約

### カラーパレット

| 用途 | カラーコード | 説明 |
|------|-------------|------|
| プライマリ | #XXXXXX | メインカラー |
| セカンダリ | #XXXXXX | サブカラー |
| 背景 | #XXXXXX | 背景色 |
| テキスト | #XXXXXX | 通常テキスト |
| エラー | #XXXXXX | エラー表示 |
| 成功 | #XXXXXX | 成功表示 |

### フォント設定

| 用途 | フォント | サイズ | ウェイト |
|------|---------|--------|---------|
| 見出し | {font} | {size}px | Bold |
| 本文 | {font} | {size}px | Regular |
| キャプション | {font} | {size}px | Light |

### 余白・間隔

| 名称 | 値 | 用途 |
|------|-----|------|
| xs | 4px | 極小間隔 |
| sm | 8px | 小間隔 |
| md | 16px | 標準間隔 |
| lg | 24px | 大間隔 |
| xl | 32px | 極大間隔 |
```

### ui-design/screens/{画面名}.md

```markdown
# {画面名} 詳細設計

## 基本情報

| 項目 | 値 |
|------|-----|
| 画面ID | SCR-XXX |
| 親画面 | {遷移元画面} |
| 子画面 | {遷移先画面} |

## ワイヤーフレーム

\`\`\`
┌─────────────────────────────────────┐
│              ヘッダー                │
├─────────────────────────────────────┤
│                                     │
│           メインコンテンツ           │
│                                     │
├─────────────────────────────────────┤
│              フッター                │
└─────────────────────────────────────┘
\`\`\`

## UI要素

| 要素ID | 種類 | 説明 | 状態 |
|--------|------|------|------|
| btn-{action} | ボタン | {説明} | 有効/無効 |
| txt-{name} | テキスト | {説明} | - |
| img-{name} | 画像 | {説明} | - |

## 状態遷移

### 初期状態
- {初期状態の説明}

### ローディング状態
- {ローディング中の表示}

### エラー状態
- {エラー時の表示と対処}

### 操作可能状態
- {通常時の状態}

## アニメーション

| トリガー | アニメーション | 時間 | イージング |
|----------|---------------|------|-----------|
| 画面表示時 | フェードイン | 0.3s | ease-out |
| ボタンホバー | スケール拡大 | 0.1s | ease-in-out |
| ボタン押下 | スケール縮小 | 0.05s | linear |

## イベント

| イベント名 | トリガー | 処理内容 |
|-----------|----------|----------|
| On{Action}Clicked | {ボタン名}押下 | {処理内容} |

## アクセシビリティ

- [ ] キーボード操作対応
- [ ] スクリーンリーダー対応
- [ ] 色覚多様性対応
- [ ] フォーカス表示
```

### ui-design/input-system.md

```markdown
# 入力システム設計

## 対応入力デバイス

| デバイス | 対応状況 | 備考 |
|----------|----------|------|
| キーボード + マウス | 必須 | PC版 |
| ゲームパッド | 必須/オプション | Xbox/PlayStation/Nintendo対応 |
| タッチスクリーン | オプション | モバイル版対応時 |

## キーバインド設定

### デフォルトキーバインド

| アクション | キーボード | ゲームパッド | 備考 |
|-----------|-----------|-------------|------|
| 決定 | Enter / Space | A / ○ | - |
| キャンセル | Escape | B / × | - |
| 移動（上） | W / ↑ | 左スティック↑ / D-Pad↑ | - |
| 移動（下） | S / ↓ | 左スティック↓ / D-Pad↓ | - |
| 移動（左） | A / ← | 左スティック← / D-Pad← | - |
| 移動（右） | D / → | 左スティック→ / D-Pad→ | - |
| ポーズ | Escape / P | Start | - |

### カスタマイズ可能なアクション

| アクション | デフォルト | カスタマイズ可 |
|-----------|-----------|---------------|
| {action1} | {default} | ○ |

### リマップ不可のアクション

| アクション | キー | 理由 |
|-----------|------|------|
| スクリーンショット | F12 | システム予約 |

## 入力の優先度

1. **UI入力** - ダイアログ表示中はUI入力が最優先
2. **ゲーム入力** - 通常のゲームプレイ時
3. **システム入力** - ポーズ、スクリーンショット等

## 同時入力の処理

| 状況 | 処理方法 |
|------|----------|
| 反対方向の同時入力 | 後から入力された方を優先 / 打ち消し |
| 複数ボタン同時押し | {処理方法} |

## 入力バッファ

| 設定項目 | 値 | 説明 |
|----------|-----|------|
| バッファ時間 | {ms} | 入力を保持する時間 |
| 先行入力許可 | {有/無} | アクション終了前の入力受付 |
```

### data-schema.md

```markdown
# データスキーマ設計

## セーブデータ構造

### SaveData.json

\`\`\`json
{
  "version": "1.0.0",
  "lastSaved": "2024-01-01T00:00:00Z",
  "playerData": {
    "name": "string",
    "level": 1,
    "experience": 0
  },
  "progressData": {
    "currentStage": 1,
    "unlockedItems": []
  },
  "settingsData": {
    "masterVolume": 1.0,
    "bgmVolume": 1.0,
    "seVolume": 1.0
  }
}
\`\`\`

### フィールド説明

| フィールド | 型 | 説明 | デフォルト値 |
|-----------|-----|------|-------------|
| version | string | セーブデータバージョン | "1.0.0" |
| lastSaved | string (ISO8601) | 最終保存日時 | - |
| playerData.name | string | プレイヤー名 | "" |
| playerData.level | int | プレイヤーレベル | 1 |

## マスターデータ構造

### {MasterData1}.json

\`\`\`json
[
  {
    "id": "item_001",
    "name": "アイテム名",
    "description": "説明文",
    "parameters": {
      "param1": 10,
      "param2": 20
    }
  }
]
\`\`\`

### フィールド説明

| フィールド | 型 | 説明 | 必須 |
|-----------|-----|------|------|
| id | string | 一意識別子 | ○ |
| name | string | 表示名 | ○ |
| description | string | 説明文 | ○ |

## データフロー

### ロードタイミング

| データ種別 | タイミング | 備考 |
|-----------|-----------|------|
| マスターデータ | ゲーム起動時 | 全データをメモリに保持 |
| セーブデータ | タイトル画面表示時 | 存在確認のみ |
| セーブデータ（詳細） | ゲーム開始時 | 選択されたスロットを読み込み |

### セーブタイミング

| タイミング | トリガー | 備考 |
|-----------|----------|------|
| 自動セーブ | {トリガー} | {間隔} |
| 手動セーブ | ポーズメニューから | - |
| ゲーム終了時 | タイトルに戻る時 | 確認ダイアログあり |
```

### audio-design.md（オプション）

```markdown
# オーディオ設計

## BGM設計

| ID | 名称 | 使用シーン | ループ | 備考 |
|----|------|-----------|--------|------|
| bgm_001 | タイトルBGM | タイトル画面 | ○ | - |
| bgm_002 | メインBGM | ゲームプレイ中 | ○ | - |
| bgm_003 | リザルトBGM | リザルト画面 | ○ | - |

## SE設計

| ID | 名称 | トリガー | 備考 |
|----|------|----------|------|
| se_001 | 決定音 | ボタン押下 | - |
| se_002 | キャンセル音 | キャンセル操作 | - |
| se_003 | {効果音名} | {トリガー} | - |

## サウンドイベント

| イベント名 | 再生するサウンド | 条件 |
|-----------|-----------------|------|
| OnButtonClick | se_001 | - |
| OnCancel | se_002 | - |

## ボリューム設定

| カテゴリ | デフォルト値 | 範囲 | 備考 |
|----------|-------------|------|------|
| マスター | 1.0 | 0.0-1.0 | 全体音量 |
| BGM | 0.8 | 0.0-1.0 | - |
| SE | 1.0 | 0.0-1.0 | - |
| Voice | 1.0 | 0.0-1.0 | ボイスがある場合 |
```

## 実行後の確認

- @agent-symbol-searcher で作成した設計と既存システムとの整合性を確認
- 作成したファイルの一覧を表示
- 設計の主要なポイントをサマリーで表示
- ユーザに確認を促すメッセージを表示
