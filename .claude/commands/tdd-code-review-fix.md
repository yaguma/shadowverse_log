---
description: コードレビュー結果に基づいてコードを修正します。レビューレポートを読み込み、問題点を優先度順に修正します。
---

# TDD コードレビュー修正

コードレビュー結果に基づいてコードを修正します。

## 目的

`/tdd-code-review` で生成されたレビューレポートを読み込み、検出された問題を優先度順に修正します。

## 事前準備

修正コンテキストの準備を行います：

1. **追加ルールの読み込み**
   - `AGENTS.md` ファイルが存在する場合は読み込み
   - `docs/rule` ディレクトリが存在する場合は読み込み
   - `docs/rule/tdd` ディレクトリが存在する場合は読み込み
   - `docs/rule/tdd/code-review-fix` ディレクトリが存在する場合は読み込み
   - 各ディレクトリ内のすべてのファイルを読み込み、追加ルールとして適用

2. **レビュー結果ファイルの読み込み**
   - `docs/code-reviews/{要件名}/{{task_id}}/` ディレクトリから最新のレビューファイルを読み込み
   - または、引数で指定されたレビューファイルパスを読み込み
   - 使用例:
     - `/tdd-code-review-fix` - 最新のレビューファイルを自動検出
     - `/tdd-code-review-fix --file docs/code-reviews/xxx/TASK-0001/feature-review-20250102-120000.md`

3. **関連ファイルを直接読み込み**
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-memo.md` - 開発履歴を確認
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-requirements.md` - 要件定義を確認
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-testcases.md` - テストケース定義を確認
   - 問題が指摘されたソースファイル
   - 関連するテストファイル

読み込み完了後、準備されたコンテキスト情報を基に修正作業を開始します。

## 修正量の判定基準

各レビュー指摘について、以下のいずれかに該当する場合は「大規模修正」と判定します：

| 基準 | 閾値 | 説明 |
|------|------|------|
| 影響ファイル数 | 3ファイル以上 | 複数ファイルにまたがる修正が必要 |
| 推定変更行数 | 100行以上 | レビュー指摘の「推奨修正」から推定 |
| アーキテクチャ変更 | 該当 | インターフェース変更、新クラス追加、依存関係変更など |
| テスト追加要求 | 5件以上 | 新規テストケースの追加が大量に必要 |

### 判定ロジック

```
1. レビュー指摘から以下の情報を抽出：
   - 影響ファイル数
   - 推定変更行数（「推奨修正」の内容から推定）
   - アーキテクチャ変更の有無
   - 必要なテスト追加数

2. いずれかの閾値を超えた場合、「大規模修正」としてマーク

3. 大規模修正の場合はユーザに確認を求める（後述）
```

### 重要な制約

- **🔴 Critical問題はIssue作成不可**：Critical問題は即時対応が必須のため、Issue作成オプションは提供しません
- **🟡 Warning問題**：Issue作成オプションを提供
- **🔵 Info問題**：Issue作成オプションを提供

## 信頼性レベル指示

修正作業では、各修正内容について元の資料との照合状況を以下の信号でコメントしてください：

- 🔵 **青信号**: 元の資料（レビュー指摘・要件定義・設計文書）に基づく修正
- 🟡 **黄信号**: 元の資料から妥当な推測に基づく修正
- 🔴 **赤信号**: 元の資料にない推測に基づく修正（一般的なベストプラクティス）

## 修正の優先順位

以下の優先順位で問題を修正してください：

### 最優先: 🔴 Critical（致命的）問題

**即時修正必須**の問題を最初に対応します：

- セキュリティ脆弱性
- データ損失リスク
- 本番障害の可能性
- 機能の完全な欠陥

### 高優先: 🟡 Warning（警告）問題

Critical問題の修正完了後、以下の問題に対応します：

- パフォーマンス問題
- 保守性の問題
- SOLID原則違反
- テストカバレッジ不足
- エラーハンドリング不足

### 中優先: 🔵 Info（情報）問題

Critical/Warning問題の修正完了後、必要に応じて以下の問題に対応します：

- コメント不足
- 命名改善
- コードスタイル統一
- リファクタリングの機会

## 修正手順

### 1. レビューレポートの分析

```
1. レビューレポートから問題リストを抽出
2. 問題を優先度（Critical → Warning → Info）でソート
3. 各問題の依存関係を確認（先に修正すべき問題を特定）
4. 修正計画を立案
```

### 1.5. 修正量の事前判定

各問題について修正量を判定します：

```
1. レビューレポートから問題リストを抽出
2. 各問題について以下を分析：
   - 影響ファイル数（問題説明と推奨修正から特定）
   - 推定変更行数（推奨修正の内容から推定）
   - アーキテクチャ変更の有無
   - 必要なテスト追加数
3. 判定基準に基づき「大規模修正」をマーク
4. 大規模修正の問題をリストアップ
```

**音声通知**: 大規模修正が検出された場合「大規模な修正が{N}件あるのだ」

### 1.6. 大規模修正のユーザ確認

**🔴 Critical問題は必須修正のため、このステップをスキップ**

Warning/Info問題で「大規模修正」と判定されたものについて、AskUserQuestionツールを使用してユーザに確認を求めます：

```markdown
## 📊 大規模修正の確認

### 問題詳細
- **問題ID**: {issue_id}
- **問題タイトル**: {issue_title}
- **重要度**: {severity}

### 修正規模の見積もり
- **影響ファイル数**: {affected_files}個
- **推定変更行数**: 約{estimated_lines}行
- **アーキテクチャ変更**: {is_architecture_change}
- **必要なテスト追加**: {required_tests}件

この問題にどのように対応しますか？
```

**選択肢**:
1. **今すぐ修正する** - この場で修正を行います
2. **Issueを作成して後で対応** - GitHub Issueを作成し、後日対応します
3. **スキップする** - 今回は対応せず、理由を記録します

#### Issue作成を選択した場合

1. `gh issue create` でIssueを作成
2. 作成されたIssue番号とURLを記録
3. 修正サマリーの「Issue作成」列に追加
4. 次の問題に進む

**音声通知**: 「イシュー{番号}を作成したのだ」

#### スキップを選択した場合

1. スキップ理由をユーザに入力してもらう（AskUserQuestion使用）
2. 修正サマリーの「スキップ」列に追加
3. 「未対応の問題」セクションに理由を記録
4. 次の問題に進む

### 2. Critical問題の修正

各Critical問題に対して以下を実行：

```
1. 問題箇所のファイルと行番号を特定
2. 問題の根本原因を分析
3. 修正方針を決定（レビュー指摘の「推奨修正」を参考）
4. コードを修正
5. 修正内容に日本語コメントを追加（信頼性レベル付き）
6. Taskツールを使用してテストを実行し、既存機能が壊れていないことを確認
7. 次の問題に進む
```

### 3. Warning問題の修正

Critical問題の修正完了後、同様の手順でWarning問題を修正：

```
1. 問題箇所を特定
2. 修正方針を決定
3. コードを修正
4. テスト実行で確認
5. 次の問題に進む
```

### 4. Info問題の修正（任意）

必要に応じてInfo問題を修正：

```
1. 優先度の高いInfo問題を選択
2. コメント追加、命名改善等を実施
3. コードスタイルの統一
```

## 修正時の日本語コメント要件

修正したコードには以下の日本語コメントを追加してください：

### 修正箇所のコメント

```javascript
/**
 * 【修正内容】: [レビュー指摘ID]への対応
 * 【修正理由】: [なぜこの修正が必要だったか]
 * 【修正前】: [修正前の問題点]
 * 【修正後】: [修正後の改善点]
 * 🔵🟡🔴 信頼性レベル: [この修正が元資料のどの程度に基づいているか]
 */
function fixedFunction() {
  // 【修正ポイント】: [具体的な修正内容の説明]
}
```

### セキュリティ修正のコメント

```javascript
// 【セキュリティ修正】: [C-001] SQLインジェクション対策 🔵
// 【修正前】: 文字列連結でクエリを構築していた
// 【修正後】: パラメータ化クエリを使用
const result = await db.query('SELECT * FROM users WHERE id = $1', [userId]);
```

### パフォーマンス修正のコメント

```javascript
// 【パフォーマンス修正】: [W-003] N+1問題の解消 🔵
// 【修正前】: ループ内で個別クエリを実行していた
// 【修正後】: JOINを使用して1回のクエリで取得
const users = await db.query(`
  SELECT u.*, p.name as profile_name
  FROM users u
  LEFT JOIN profiles p ON u.id = p.user_id
`);
```

## Issue作成テンプレート

大規模修正でIssue作成を選択した場合、以下のテンプレートでIssueを作成します：

### Issue作成コマンド

```bash
gh issue create \
  --title "[Code Review] {issue_id}: {issue_title}" \
  --body "$(cat <<'EOF'
## 📋 概要

コードレビュー（`/tdd-code-review`）で検出された問題の対応タスクです。

## 🔍 元のレビュー指摘

- **問題ID**: {issue_id}
- **カテゴリ**: {category}
- **重要度**: {severity}
- **検出日時**: {review_datetime}
- **レビューレポート**: `{review_report_path}`

### 問題内容

{problem_description}

### 影響範囲

- **対象ファイル**:
{affected_files_list}

### 推奨修正

{recommended_fix}

## 📊 修正規模の見積もり

| 項目 | 値 |
|------|-----|
| 影響ファイル数 | {affected_files}個 |
| 推定変更行数 | 約{estimated_lines}行 |
| アーキテクチャ変更 | {is_architecture_change} |
| 必要なテスト追加 | {required_tests}件 |

## ✅ 受け入れ基準

- [ ] 指摘された問題が解消されている
- [ ] 既存のテストが全て通る
- [ ] 新規テストが追加されている（必要な場合）
- [ ] `/tdd-code-review` で再レビューし、問題が検出されない

## 🔗 関連情報

- **元タスク**: {original_task_id}
- **対象機能**: {feature_name}

## 📝 備考

このIssueは `/tdd-code-review-fix` コマンド実行時に自動生成されました。
EOF
)" \
  --label "code-review" \
  --label "refactoring" \
  --label "{severity}"
```

### ラベル

- `code-review`: コードレビューから派生したIssue
- `refactoring`: リファクタリング対象
- `{severity}`: `warning` または `info`（Criticalは対象外）

## 修正完了後のアクション

### 1. テストの実行

```
- Taskツールを使用して全テストを実行
- 全てのテストが成功することを確認
- 修正によって新たなテスト失敗が発生していないことを確認
```

### 2. 修正サマリーの出力

以下の形式で修正サマリーを出力してください：

```markdown
# コードレビュー修正サマリー

**修正日時**: [YYYY-MM-DD HH:MM:SS]
**対象レビュー**: [レビューファイルパス]
**対象機能**: {{feature_name}}
**タスクID**: {{task_id}}

---

## 📊 修正結果

| 重要度 | 検出数 | 修正完了 | Issue作成 | スキップ |
|--------|--------|----------|-----------|----------|
| 🔴 Critical | 0 | 0 | - | 0 |
| 🟡 Warning | 0 | 0 | 0 | 0 |
| 🔵 Info | 0 | 0 | 0 | 0 |

**テスト結果**: ✅ 全て成功 / ⚠️ 一部失敗

**備考**: Critical問題はIssue作成不可（必須修正）のため「-」表記

---

## 修正内容詳細

### 🔴 Critical修正

#### C-001: [問題タイトル] → ✅ 修正完了
- **ファイル**: [ファイルパス:行番号]
- **修正内容**: [具体的な修正内容]
- **確認方法**: [修正が正しいことの確認方法]

### 🟡 Warning修正

#### W-001: [問題タイトル] → ✅ 修正完了
- **ファイル**: [ファイルパス:行番号]
- **修正内容**: [具体的な修正内容]

### 🔵 Info修正

#### I-001: [問題タイトル] → ✅ 修正完了
- **ファイル**: [ファイルパス:行番号]
- **修正内容**: [具体的な修正内容]

---

## 🎫 作成されたIssue（該当時のみ）

| 問題ID | タイトル | Issue番号 | リンク |
|--------|---------|-----------|--------|
| W-005 | [問題タイトル] | #42 | [Link](https://github.com/{owner}/{repo}/issues/42) |
| I-001 | [問題タイトル] | #43 | [Link](https://github.com/{owner}/{repo}/issues/43) |

**備考**: これらの問題は別途Issueとして対応予定です。レビューループでは「対応済み」として扱われます。

---

## 未対応の問題（スキップ・該当時のみ）

### [問題ID]: [問題タイトル]
- **理由**: [対応しなかった理由]
- **今後の対応**: [将来の対応予定]

---

## 次のステップ

[品質判定に基づく次のステップを記載]
```

### 3. メモファイルの更新

`docs/implements/{要件名}/{{task_id}}/{feature_name}-memo.md` に修正記録を追記：

```markdown
## コードレビュー修正 ([日時])

### 修正結果
- Critical: [数]件修正完了
- Warning: [数]件修正完了
- Info: [数]件修正完了

### 主な修正内容
1. [修正内容1]
2. [修正内容2]

### テスト結果
[テスト実行結果]
```

## 品質判定基準

```
✅ 修正完了:
- Critical問題: 全て解消
- テスト: 全て成功
- 修正内容: 適切にコメントで記録
- メモファイル: 更新完了

⚠️ 追加修正必要:
- Critical問題が残存
- テスト失敗がある
- 修正が不完全
```

## 次のステップ表示

修正結果に応じて次のステップを表示してください：

### 全ての問題を修正完了した場合
```
✅ 修正完了。全ての問題が解消されました。

次のお勧めステップ:
1. `/tdd-code-review` で再レビューを実行し、品質を確認
2. または `/tdd-verify-complete` で完全性検証に進む
```

### Critical問題が残存する場合
```
⚠️ Critical問題が残存しています。追加修正が必要です。

残存するCritical問題:
[残存問題のリスト]

引き続き `/tdd-code-review-fix` で修正を続行してください。
```

### Warning問題のみ残存する場合
```
⚠️ Warning問題が残存しています。

残存するWarning問題:
[残存問題のリスト]

次のお勧めステップ:
1. 引き続き `/tdd-code-review-fix` で修正
2. または `/tdd-verify-complete` で完全性検証に進む（後で対応）
```

## TODO更新パターン

```
- 現在のTODO「コードレビュー修正」を「completed」にマーク
- 修正結果の概要をTODO内容に記録
- 残存問題がある場合は「追加修正」をTODOに追加
- 次のフェーズ（再レビューまたは完全性検証）をTODOに追加
```

## 注意事項

- **段階的な修正**: 一度に多くの修正を行わず、1つずつ確実に修正する
- **テストの継続実行**: 各修正後にテストを実行し、既存機能が壊れていないことを確認
- **コメントの追加**: 修正箇所には必ず日本語コメントで修正内容を記録
- **レビュー指摘への準拠**: レビュー指摘の「推奨修正」を尊重しつつ、より良い方法があれば採用
- **未対応問題の記録**: 対応しなかった問題がある場合は、理由と今後の対応を明記
