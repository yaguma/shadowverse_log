/**
 * JSONデータからD1用のシードSQLファイルを生成するスクリプト
 * Usage: node scripts/generate-seed-sql.mjs
 *
 * 生成されたSQLファイルは以下のコマンドで本番環境に適用:
 *   pnpm run db:seed:prod
 */

import { existsSync, readFileSync, writeFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const PROJECT_ROOT = dirname(__dirname);
const DATA_DIR = join(PROJECT_ROOT, '..', '..', 'data', 'json');
const OUTPUT_FILE = join(PROJECT_ROOT, 'src', 'db', 'migrations', 'seed-data.sql');

function loadJsonFile(filename) {
  const filePath = join(DATA_DIR, filename);
  if (!existsSync(filePath)) {
    console.error(`Error: JSON file not found: ${filePath}`);
    return null;
  }
  const content = readFileSync(filePath, 'utf-8');
  return JSON.parse(content);
}

function escapeString(str) {
  if (str === null || str === undefined) return 'NULL';
  return `'${String(str).replace(/'/g, "''")}'`;
}

function generateDeckMasterInserts(data) {
  const lines = ['-- deck_master data', 'DELETE FROM deck_master;'];

  for (const item of data) {
    const sql = `INSERT INTO deck_master (id, class_name, deck_name, sort_order, created_at, updated_at) VALUES (${escapeString(item.id)}, ${escapeString(item.className)}, ${escapeString(item.deckName)}, ${parseInt(item.sortOrder, 10)}, datetime('now'), datetime('now'));`;
    lines.push(sql);
  }

  return lines.join('\n');
}

function generateMyDecksInserts(data) {
  const lines = ['', '-- my_decks data', 'DELETE FROM my_decks;'];

  for (const item of data) {
    const isActive = item.isActive ? 1 : 0;
    const createdAt = item.createdAt ? escapeString(item.createdAt) : "datetime('now')";
    // deckIdは必須（NOT NULL制約）
    const deckId = escapeString(item.deckId);
    const sql = `INSERT INTO my_decks (id, user_id, deck_id, deck_code, deck_name, is_active, created_at, updated_at) VALUES (${escapeString(item.id)}, NULL, ${deckId}, ${escapeString(item.deckCode)}, ${escapeString(item.deckName)}, ${isActive}, ${createdAt}, datetime('now'));`;
    lines.push(sql);
  }

  return lines.join('\n');
}

function generateBattleLogsInserts(data) {
  const lines = ['', '-- battle_logs data', 'DELETE FROM battle_logs;'];

  for (const item of data) {
    const season = item.season !== null && item.season !== undefined ? item.season : 'NULL';
    const sql = `INSERT INTO battle_logs (id, user_id, date, battle_type, rank, group_name, my_deck_id, turn, result, opponent_deck_id, season, created_at, updated_at) VALUES (${escapeString(item.id)}, NULL, ${escapeString(item.date)}, ${escapeString(item.battleType)}, ${escapeString(item.rank)}, ${escapeString(item.group)}, ${escapeString(item.myDeckId)}, ${escapeString(item.turn)}, ${escapeString(item.result)}, ${escapeString(item.opponentDeckId)}, ${season}, datetime('now'), datetime('now'));`;
    lines.push(sql);
  }

  return lines.join('\n');
}

function main() {
  console.log('=== Generate Seed SQL ===');
  console.log(`Data directory: ${DATA_DIR}`);
  console.log(`Output file: ${OUTPUT_FILE}`);
  console.log('');

  const sqlParts = [
    '-- Shadowverse Battle Log - Seed Data',
    '-- Generated by: node scripts/generate-seed-sql.mjs',
    `-- Generated at: ${new Date().toISOString()}`,
    '-- Note: D1 does not support BEGIN TRANSACTION syntax',
    '',
  ];

  // deck-master
  const deckMasterData = loadJsonFile('deck-master.json');
  if (deckMasterData) {
    sqlParts.push(generateDeckMasterInserts(deckMasterData));
    console.log(`deck_master: ${deckMasterData.length} records`);
  }

  // my-decks
  const myDecksData = loadJsonFile('my-decks.json');
  if (myDecksData) {
    sqlParts.push(generateMyDecksInserts(myDecksData));
    console.log(`my_decks: ${myDecksData.length} records`);
  }

  // battle-logs
  const battleLogsData = loadJsonFile('battle-logs.json');
  if (battleLogsData) {
    sqlParts.push(generateBattleLogsInserts(battleLogsData));
    console.log(`battle_logs: ${battleLogsData.length} records`);
  }

  sqlParts.push('');

  const sqlContent = sqlParts.join('\n');
  writeFileSync(OUTPUT_FILE, sqlContent, 'utf-8');

  console.log('');
  console.log(`SQL file generated: ${OUTPUT_FILE}`);
  console.log(`File size: ${(sqlContent.length / 1024).toFixed(2)} KB`);
  console.log('');
  console.log('To apply to production:');
  console.log('  pnpm run db:seed:prod');
  console.log('');
  console.log('Done!');
}

main();
