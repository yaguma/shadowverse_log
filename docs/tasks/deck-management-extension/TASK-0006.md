# TASK-0006: DeckMaster API - POST 実装

**タスクID**: TASK-0006
**タスクタイプ**: TDD
**推定工数**: 2時間
**フェーズ**: Phase 2 - デッキ種別管理機能
**信頼性レベル**: 🔵 *api-endpoints.md 2.2より、REQ-EXT-001〜005*

## 関連文書
- [技術設計書](../../design/deck-management-extension/README.md)
- [APIエンドポイント定義](../../design/deck-management-extension/api-endpoints.md)
- [要件定義](../../design/deck-management-extension/requirements.md)

## タスク概要
DeckMasterの新規登録APIを実装する。className、deckNameのバリデーション、sortOrderの自動採番、UUIDの自動生成を行う。

## 依存タスク
- **前提タスク**: [TASK-0003](TASK-0003.md) - DeckMasterスキーマ定義、[TASK-0004](TASK-0004.md) - DeckMasterリポジトリ実装
- **後続タスク**: [TASK-0009](TASK-0009.md) - DeckStore拡張

## 完了条件
- [x] POST /api/deck-master エンドポイントが動作すること
- [x] className、deckNameのバリデーションが機能すること
- [x] sortOrderが自動採番（max+1）されること
- [x] UUIDが自動生成されること
- [x] 全テストがパスすること

---
## 実装詳細

### リクエスト形式
```json
{
  "className": "ウィッチ",
  "deckName": "秘術ウィッチ"
}
```

### レスポンス形式（成功時: 201 Created）
```json
{
  "success": true,
  "data": {
    "id": "generated-uuid",
    "className": "ウィッチ",
    "deckName": "秘術ウィッチ",
    "sortOrder": 10,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z"
  },
  "meta": {
    "timestamp": "2024-01-01T00:00:00.000Z"
  }
}
```

### バリデーションルール

| フィールド | ルール | エラーコード |
|-----------|--------|-------------|
| className | 必須、有効なクラス名のみ | VALIDATION_ERROR |
| deckName | 必須、1〜50文字 | VALIDATION_ERROR |

### 有効なクラス名一覧
- エルフ
- ロイヤル
- ウィッチ
- ドラゴン
- ネクロマンサー
- ヴァンパイア
- ビショップ
- ネメシス

### sortOrder採番ロジック
```sql
SELECT COALESCE(MAX(sort_order), 0) + 1 as next_sort_order
FROM deck_master
```

---
## 単体テスト要件

### テストファイル
`packages/api/src/__tests__/deck-master.post.test.ts`

### テストケース

#### 正常系
1. **正常登録で201 Created**
   - 入力: { className: "ウィッチ", deckName: "秘術ウィッチ" }
   - 期待: 201 Created、UUIDが生成される

2. **sortOrderが最大値+1で採番**
   - 入力: 既存データあり（sortOrder: 5）で新規登録
   - 期待: 新規データのsortOrderが6

3. **データ0件時のsortOrderは1**
   - 入力: データ0件で新規登録
   - 期待: sortOrderが1

#### バリデーションエラー
4. **deckName空でValidationError**
   - 入力: { className: "ウィッチ", deckName: "" }
   - 期待: 400 Bad Request、error.code: "VALIDATION_ERROR"

5. **deckName51文字でValidationError**
   - 入力: { className: "ウィッチ", deckName: "a".repeat(51) }
   - 期待: 400 Bad Request

6. **className空でValidationError**
   - 入力: { className: "", deckName: "テスト" }
   - 期待: 400 Bad Request

7. **無効なclassNameでValidationError**
   - 入力: { className: "無効クラス", deckName: "テスト" }
   - 期待: 400 Bad Request

8. **リクエストボディなしでValidationError**
   - 入力: POST /api/deck-master（ボディなし）
   - 期待: 400 Bad Request

---
## 実装手順

### Red Phase（失敗するテストを書く）
1. テストファイル `deck-master.post.test.ts` を作成
2. 上記テストケースを実装
3. テスト実行 → 失敗確認

### Green Phase（テストを通す最小実装）
1. コントローラーにcreateメソッド追加
2. サービスにcreateメソッド追加
3. バリデータにcreateスキーマ追加
4. リポジトリにinsertメソッド追加（必要に応じて）
5. テスト実行 → 成功確認

### Refactor Phase（リファクタリング）
1. クラス名定数の共通化
2. バリデーションメッセージの国際化対応検討
3. テスト実行 → 成功確認

---
## 信頼性レベルサマリー

| 項目 | レベル | 出典 |
|------|--------|------|
| APIエンドポイント仕様 | 🔵 | api-endpoints.md 2.2 |
| バリデーションルール | 🔵 | REQ-EXT-001〜005 |
| sortOrder採番ロジック | 🔵 | api-endpoints.md |
| レスポンス形式 | 🔵 | api-endpoints.md |
