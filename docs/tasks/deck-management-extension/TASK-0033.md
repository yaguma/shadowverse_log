# TASK-0033: å¯¾æˆ¦å±¥æ­´UIæ”¹å–„E2Eãƒ†ã‚¹ãƒˆ

## ã‚¿ã‚¹ã‚¯æƒ…å ±

- **ã‚¿ã‚¹ã‚¯ID**: TASK-0033
- **ã‚¿ã‚¤ãƒ—**: TDD
- **æ¨å®šå·¥æ•°**: 2æ™‚é–“
- **ãƒ•ã‚§ãƒ¼ã‚º**: Phase 6 - å¯¾æˆ¦å±¥æ­´UIæ”¹å–„
- **ä¿¡é ¼æ€§**: ğŸ”µ
- **ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0032
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0034
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: [x] å®Œäº†

---

## æ¦‚è¦

å¯¾æˆ¦å±¥æ­´UIæ”¹å–„ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„ãƒ»ç›¸æ‰‹ãƒ‡ãƒƒã‚­ã‚½ãƒ¼ãƒˆï¼‰ã®E2Eãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚

---

## å®Ÿè£…å†…å®¹

### 1. E2Eãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

`packages/frontend/e2e/battle-log-ui-improvements.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('å¯¾æˆ¦å±¥æ­´UIæ”¹å–„', () => {
  test.describe('BattleLogDialog ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„', () => {
    test.beforeEach(async ({ page }) => {
      await page.goto('/battle-logs');
      await page.click('button:has-text("å¯¾æˆ¦ã‚’è¨˜éŒ²")');
      await expect(page.locator('[role="dialog"]')).toBeVisible();
    });

    test.describe('ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤º', () => {
      test.beforeEach(async ({ page }) => {
        await page.setViewportSize({ width: 1024, height: 768 });
      });

      test('ã‚·ãƒ¼ã‚ºãƒ³ã¨å¯¾æˆ¦æ—¥ãŒæ¨ªä¸¦ã³ã§è¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
        const seasonLabel = page.locator('label:has-text("ã‚·ãƒ¼ã‚ºãƒ³")');
        const dateLabel = page.locator('label:has-text("å¯¾æˆ¦æ—¥")');

        const seasonBox = await seasonLabel.boundingBox();
        const dateBox = await dateLabel.boundingBox();

        expect(seasonBox).not.toBeNull();
        expect(dateBox).not.toBeNull();

        if (seasonBox && dateBox) {
          // Yåº§æ¨™ãŒã»ã¼åŒã˜ï¼ˆè¨±å®¹èª¤å·®10pxï¼‰
          expect(Math.abs(seasonBox.y - dateBox.y)).toBeLessThan(10);
        }
      });

      test('ã‚¿ãƒ¼ãƒ³ã¨å‹æ•—ãŒæ¨ªä¸¦ã³ã§è¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
        const turnLabel = page.locator('label:has-text("ã‚¿ãƒ¼ãƒ³")');
        const resultLabel = page.locator('label:has-text("å‹æ•—")');

        const turnBox = await turnLabel.boundingBox();
        const resultBox = await resultLabel.boundingBox();

        expect(turnBox).not.toBeNull();
        expect(resultBox).not.toBeNull();

        if (turnBox && resultBox) {
          expect(Math.abs(turnBox.y - resultBox.y)).toBeLessThan(10);
        }
      });
    });

    test.describe('ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º', () => {
      test.beforeEach(async ({ page }) => {
        await page.setViewportSize({ width: 375, height: 667 });
      });

      test('ã‚·ãƒ¼ã‚ºãƒ³ã¨å¯¾æˆ¦æ—¥ãŒç¸¦ä¸¦ã³ã§è¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
        const seasonLabel = page.locator('label:has-text("ã‚·ãƒ¼ã‚ºãƒ³")');
        const dateLabel = page.locator('label:has-text("å¯¾æˆ¦æ—¥")');

        const seasonBox = await seasonLabel.boundingBox();
        const dateBox = await dateLabel.boundingBox();

        expect(seasonBox).not.toBeNull();
        expect(dateBox).not.toBeNull();

        if (seasonBox && dateBox) {
          // å¯¾æˆ¦æ—¥ãŒã‚·ãƒ¼ã‚ºãƒ³ã‚ˆã‚Šä¸‹ã«è¡¨ç¤ºã•ã‚Œã‚‹
          expect(dateBox.y).toBeGreaterThan(seasonBox.y + 20);
        }
      });
    });

    test.describe('è©³ç´°è¨­å®š', () => {
      test('è©³ç´°è¨­å®šãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦è¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
        const details = page.locator('details summary');
        await expect(details).toContainText('è©³ç´°è¨­å®š');
      });

      test('è©³ç´°è¨­å®šã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å±•é–‹ã•ã‚Œã‚‹', async ({ page }) => {
        const details = page.locator('details summary');
        await details.click();

        // ãƒ©ãƒ³ã‚¯é¸æŠãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        await expect(page.locator('label:has-text("ãƒ©ãƒ³ã‚¯")')).toBeVisible();
        await expect(page.locator('label:has-text("ã‚°ãƒ«ãƒ¼ãƒ—")')).toBeVisible();
        await expect(page.locator('label:has-text("å¯¾æˆ¦ç¨®åˆ¥")')).toBeVisible();
      });
    });
  });

  test.describe('ç›¸æ‰‹ãƒ‡ãƒƒã‚­é¸æŠè‚¢ã‚½ãƒ¼ãƒˆ', () => {
    test.beforeEach(async ({ page }) => {
      // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå¯¾æˆ¦å±¥æ­´ã‚’ç™»éŒ²ã—ã¦ã‹ã‚‰ç¢ºèªï¼‰
      await page.goto('/battle-logs');
    });

    test('ç›¸æ‰‹ãƒ‡ãƒƒã‚­é¸æŠè‚¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
      await page.click('button:has-text("å¯¾æˆ¦ã‚’è¨˜éŒ²")');
      await expect(page.locator('[role="dialog"]')).toBeVisible();

      const opponentSelect = page.locator('select[name="opponentDeckId"]');
      await expect(opponentSelect).toBeVisible();

      // é¸æŠè‚¢ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
      const options = opponentSelect.locator('option');
      const optionCount = await options.count();
      expect(optionCount).toBeGreaterThan(1); // ã€Œé¸æŠã—ã¦ãã ã•ã„ã€+ ãƒ‡ãƒƒã‚­é¸æŠè‚¢
    });

    test('æœ€è¿‘ä½¿ç”¨ã—ãŸãƒ‡ãƒƒã‚­ãŒä¸Šä½ã«è¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
      // äº‹å‰æ¡ä»¶: ã™ã§ã«å¯¾æˆ¦å±¥æ­´ãŒå­˜åœ¨ã—ã€ç‰¹å®šã®ãƒ‡ãƒƒã‚­ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹

      await page.click('button:has-text("å¯¾æˆ¦ã‚’è¨˜éŒ²")');
      await expect(page.locator('[role="dialog"]')).toBeVisible();

      const opponentSelect = page.locator('select[name="opponentDeckId"]');
      const options = opponentSelect.locator('option');

      // æœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã€Œé¸æŠã—ã¦ãã ã•ã„ã€ã®æ¬¡ï¼‰ãŒæœ€è¿‘ä½¿ç”¨ã•ã‚ŒãŸãƒ‡ãƒƒã‚­
      // ã“ã®ãƒ†ã‚¹ãƒˆã¯å®Ÿéš›ã®å¯¾æˆ¦å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã«ä¾å­˜ã™ã‚‹
      const firstDeckOption = options.nth(1);
      const firstDeckText = await firstDeckOption.textContent();

      // ä½¿ç”¨å›æ•°ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆä¾‹: "ãƒ‡ãƒƒã‚­å (5å›)"ï¼‰
      // ã¾ãŸã¯å˜ã«ãƒ‡ãƒƒã‚­åã®ã¿
      expect(firstDeckText).toBeTruthy();
    });

    test('å¯¾æˆ¦å±¥æ­´ãŒãªã„å ´åˆã¯sortOrderé †ã§è¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
      // å¯¾æˆ¦å±¥æ­´ãŒãªã„çŠ¶æ…‹ï¼ˆã¾ãŸã¯æ–°ã—ã„ãƒ‡ãƒƒã‚­ãƒã‚¹ã‚¿ãƒ¼ã®ã¿ã®çŠ¶æ…‹ï¼‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      // ã“ã®ãƒ†ã‚¹ãƒˆã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ…‹ã«ä¾å­˜

      await page.click('button:has-text("å¯¾æˆ¦ã‚’è¨˜éŒ²")');
      await expect(page.locator('[role="dialog"]')).toBeVisible();

      // é¸æŠè‚¢ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      const opponentSelect = page.locator('select[name="opponentDeckId"]');
      await expect(opponentSelect).toBeVisible();
    });
  });

  test.describe('ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ãƒ•ãƒ­ãƒ¼', () => {
    test('ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„å¾Œã‚‚æ­£å¸¸ã«å¯¾æˆ¦å±¥æ­´ã‚’ç™»éŒ²ã§ãã‚‹', async ({ page }) => {
      await page.goto('/battle-logs');

      // åˆæœŸã®å¯¾æˆ¦å±¥æ­´æ•°ã‚’è¨˜éŒ²
      const initialCount = await page.locator('[data-testid="battle-log-row"]').count();

      // å¯¾æˆ¦ã‚’è¨˜éŒ²
      await page.click('button:has-text("å¯¾æˆ¦ã‚’è¨˜éŒ²")');
      await expect(page.locator('[role="dialog"]')).toBeVisible();

      // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
      await page.selectOption('select[name="myDeckId"]', { index: 1 });
      await page.selectOption('select[name="opponentDeckId"]', { index: 1 });
      await page.selectOption('select[name="turn"]', 'å…ˆæ”»');
      await page.selectOption('select[name="result"]', 'å‹ã¡');

      // ä¿å­˜
      await page.click('button:has-text("ä¿å­˜")');

      // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ã‚‹ã“ã¨ã‚’ç¢ºèª
      await expect(page.locator('[role="dialog"]')).not.toBeVisible();

      // å¯¾æˆ¦å±¥æ­´ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      await page.waitForSelector('[data-testid="battle-log-row"]');
      const newCount = await page.locator('[data-testid="battle-log-row"]').count();
      expect(newCount).toBe(initialCount + 1);
    });
  });
});
```

### 2. ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£è¿½åŠ 

`packages/frontend/e2e/utils/dialog-helpers.ts`:

```typescript
import { Page, expect } from '@playwright/test';

/**
 * BattleLogDialogã‚’é–‹ããƒ˜ãƒ«ãƒ‘ãƒ¼
 */
export async function openBattleLogDialog(page: Page): Promise<void> {
  await page.click('button:has-text("å¯¾æˆ¦ã‚’è¨˜éŒ²")');
  await expect(page.locator('[role="dialog"]')).toBeVisible();
}

/**
 * BattleLogDialogã‚’é–‰ã˜ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
export async function closeBattleLogDialog(page: Page): Promise<void> {
  await page.click('button:has-text("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")');
  await expect(page.locator('[role="dialog"]')).not.toBeVisible();
}

/**
 * è¦ç´ ã®ä½ç½®ã‚’æ¯”è¼ƒã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
export async function compareElementPositions(
  page: Page,
  selector1: string,
  selector2: string
): Promise<{ sameRow: boolean; element1Above: boolean }> {
  const box1 = await page.locator(selector1).boundingBox();
  const box2 = await page.locator(selector2).boundingBox();

  if (!box1 || !box2) {
    throw new Error('è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }

  return {
    sameRow: Math.abs(box1.y - box2.y) < 10,
    element1Above: box1.y < box2.y - 10,
  };
}
```

### 3. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£

`packages/frontend/e2e/fixtures/responsive-fixtures.ts`:

```typescript
import { test as base } from '@playwright/test';

interface ResponsiveFixtures {
  setDesktopViewport: () => Promise<void>;
  setMobileViewport: () => Promise<void>;
  setTabletViewport: () => Promise<void>;
}

export const test = base.extend<ResponsiveFixtures>({
  setDesktopViewport: async ({ page }, use) => {
    const setDesktop = async () => {
      await page.setViewportSize({ width: 1280, height: 800 });
    };
    await use(setDesktop);
  },

  setMobileViewport: async ({ page }, use) => {
    const setMobile = async () => {
      await page.setViewportSize({ width: 375, height: 667 });
    };
    await use(setMobile);
  },

  setTabletViewport: async ({ page }, use) => {
    const setTablet = async () => {
      await page.setViewportSize({ width: 768, height: 1024 });
    };
    await use(setTablet);
  },
});

export { expect } from '@playwright/test';
```

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### E2Eãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | èª¬æ˜ | æœŸå¾…çµæœ |
|---|---|---|
| ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—æ¨ªä¸¦ã³ | ã‚·ãƒ¼ã‚ºãƒ³ãƒ»å¯¾æˆ¦æ—¥ã®é…ç½® | åŒã˜è¡Œã«è¡¨ç¤ºã•ã‚Œã‚‹ |
| ãƒ¢ãƒã‚¤ãƒ«ç¸¦ä¸¦ã³ | ã‚·ãƒ¼ã‚ºãƒ³ãƒ»å¯¾æˆ¦æ—¥ã®é…ç½® | ç¸¦ã«ä¸¦ã‚“ã§è¡¨ç¤ºã•ã‚Œã‚‹ |
| è©³ç´°è¨­å®šæŠ˜ã‚ŠãŸãŸã¿ | è©³ç´°è¨­å®šã®åˆæœŸçŠ¶æ…‹ | æŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ã‚‹ |
| è©³ç´°è¨­å®šå±•é–‹ | è©³ç´°è¨­å®šã‚¯ãƒªãƒƒã‚¯å¾Œ | ãƒ©ãƒ³ã‚¯ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»ç¨®åˆ¥ãŒè¡¨ç¤ºã•ã‚Œã‚‹ |
| ç›¸æ‰‹ãƒ‡ãƒƒã‚­é¸æŠè‚¢ | é¸æŠè‚¢ã®è¡¨ç¤º | é¸æŠè‚¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ |
| æœ€è¿‘ä½¿ç”¨ã‚½ãƒ¼ãƒˆ | ç›¸æ‰‹ãƒ‡ãƒƒã‚­ã®é †åº | æœ€è¿‘ä½¿ç”¨é †ã§è¡¨ç¤ºã•ã‚Œã‚‹ |
| ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å®Œäº† | ç™»éŒ²ãƒ•ãƒ­ãƒ¼ | æ­£å¸¸ã«ç™»éŒ²ã§ãã‚‹ |

---

## å®Œäº†æ¡ä»¶

- [ ] E2Eãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
- [ ] ç›¸æ‰‹ãƒ‡ãƒƒã‚­ã‚½ãƒ¼ãƒˆãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
- [ ] ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
- [ ] ã™ã¹ã¦ã®E2Eãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹

---

## å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pnpm exec playwright test e2e/battle-log-ui-improvements.spec.ts

# UIãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
pnpm exec playwright test e2e/battle-log-ui-improvements.spec.ts --ui

# ç‰¹å®šã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚µã‚¤ã‚ºã§ãƒ†ã‚¹ãƒˆ
pnpm exec playwright test e2e/battle-log-ui-improvements.spec.ts --project=Mobile\ Chrome
```

---

## æ¤œè¨¼æ‰‹é †

1. `packages/frontend/e2e/battle-log-ui-improvements.spec.ts` ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
2. `pnpm exec playwright test e2e/battle-log-ui-improvements.spec.ts` ã§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã‹ç¢ºèª
3. ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªï¼ˆ`playwright-report/index.html`ï¼‰

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [TASK-0031: BattleLogDialogãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„](./TASK-0031.md)
- [TASK-0032: ç›¸æ‰‹ãƒ‡ãƒƒã‚­é¸æŠè‚¢ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½å®Ÿè£…](./TASK-0032.md)
