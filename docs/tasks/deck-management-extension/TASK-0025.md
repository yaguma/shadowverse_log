# TASK-0025: Statistics API - ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§å–å¾—å®Ÿè£…

## ã‚¿ã‚¹ã‚¯æƒ…å ±

- **ã‚¿ã‚¹ã‚¯ID**: TASK-0025
- **ã‚¿ã‚¤ãƒ—**: TDD
- **æ¨å®šå·¥æ•°**: 2æ™‚é–“
- **ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±è¨ˆç”»é¢æ©Ÿèƒ½æ‹¡å¼µ
- **ä¿¡é ¼æ€§**: ğŸ”µï¼ˆapi-endpoints.md 4.1ã‚ˆã‚Šã€REQ-EXT-203ã€œ205ï¼‰
- **ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0004
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0027
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: [ ] æœªå®Œäº†

---

## æ¦‚è¦

ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ã‚’å–å¾—ã™ã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã€‚å¯¾æˆ¦å±¥æ­´ã‹ã‚‰é‡è¤‡ã‚’æ’é™¤ã—ãŸã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ã‚’é™é †ã§è¿”ã™ã€‚

---

## å®Ÿè£…å†…å®¹

### 1. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 

`packages/api/src/functions/getSeasons.ts`:

```typescript
import { Hono } from 'hono';
import { createBlobStorageClient } from '../storage/blobStorageClient';

const app = new Hono();

/**
 * GET /api/statistics/seasons
 * ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ã‚’å–å¾—
 */
app.get('/api/statistics/seasons', async (c) => {
  try {
    const blobClient = createBlobStorageClient();
    const battleLogs = await blobClient.getBattleLogs();

    // ã‚·ãƒ¼ã‚ºãƒ³ã‚’æŠ½å‡ºã—ã¦é‡è¤‡æ’é™¤
    const seasons = [...new Set(battleLogs.map((log) => log.season))];

    // é™é †ã‚½ãƒ¼ãƒˆï¼ˆæœ€æ–°ãŒå…ˆé ­ï¼‰
    const sortedSeasons = seasons.sort((a, b) => b - a);

    return c.json({
      success: true,
      data: {
        seasons: sortedSeasons,
      },
      meta: {
        timestamp: new Date().toISOString(),
        requestId: crypto.randomUUID(),
      },
    });
  } catch (error) {
    console.error('Failed to get seasons:', error);
    return c.json(
      {
        success: false,
        error: {
          code: 'INTERNAL_ERROR',
          message: 'ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
        },
        meta: {
          timestamp: new Date().toISOString(),
          requestId: crypto.randomUUID(),
        },
      },
      500
    );
  }
});

export default app;
```

### 2. å‹å®šç¾©è¿½åŠ 

`packages/shared/src/types/statistics.ts`:

```typescript
/**
 * ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ãƒ¬ã‚¹ãƒãƒ³ã‚¹
 */
export interface SeasonsResponse {
  seasons: number[];
}

/**
 * ã‚·ãƒ¼ã‚ºãƒ³çµ±è¨ˆ
 */
export interface SeasonStatistics {
  season: number;
  overall: {
    totalGames: number;
    wins: number;
    losses: number;
    winRate: number;
  };
  byMyDeck: DeckStatistics[];
  byOpponentDeck: DeckStatistics[];
  byTurn: TurnStatistics;
}

interface DeckStatistics {
  deckId: string;
  deckName: string;
  totalGames: number;
  wins: number;
  losses: number;
  winRate: number;
}

interface TurnStatistics {
  å…ˆæ”»: {
    totalGames: number;
    wins: number;
    losses: number;
    winRate: number;
  };
  å¾Œæ”»: {
    totalGames: number;
    wins: number;
    losses: number;
    winRate: number;
  };
}
```

### 3. BattleLogå‹ã«seasonãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ï¼ˆå¿…è¦ãªå ´åˆï¼‰

`packages/shared/src/types/index.ts`:

```typescript
export interface BattleLog {
  id: string;
  date: string;
  season: number; // ã‚·ãƒ¼ã‚ºãƒ³ç•ªå·ã‚’è¿½åŠ 
  battleType: BattleType;
  rank: Rank;
  group: Group;
  myDeckId: string;
  turn: Turn;
  result: BattleResult;
  opponentDeckId: string;
}
```

### 4. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¿½åŠ 

`packages/api/src/index.ts`:

```typescript
import { Hono } from 'hono';
import getSeasonsRoute from './functions/getSeasons';

const app = new Hono();

// æ—¢å­˜ã®ãƒ«ãƒ¼ãƒˆ
// ...

// ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ãƒ«ãƒ¼ãƒˆè¿½åŠ 
app.route('/', getSeasonsRoute);

export default app;
```

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆVitestï¼‰

`packages/api/src/functions/__tests__/getSeasons.test.ts`:

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { Hono } from 'hono';
import getSeasonsRoute from '../getSeasons';

// BlobStorageClientã®ãƒ¢ãƒƒã‚¯
vi.mock('../../storage/blobStorageClient', () => ({
  createBlobStorageClient: vi.fn(),
}));

import { createBlobStorageClient } from '../../storage/blobStorageClient';

describe('GET /api/statistics/seasons', () => {
  let app: Hono;

  beforeEach(() => {
    app = new Hono();
    app.route('/', getSeasonsRoute);
    vi.clearAllMocks();
  });

  describe('æ­£å¸¸ç³»', () => {
    it('ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ãŒé™é †ã§è¿”ã•ã‚Œã‚‹', async () => {
      const mockBattleLogs = [
        { id: '1', season: 3, date: '2025/01/01' },
        { id: '2', season: 1, date: '2024/11/01' },
        { id: '3', season: 2, date: '2024/12/01' },
        { id: '4', season: 3, date: '2025/01/02' }, // é‡è¤‡ã‚·ãƒ¼ã‚ºãƒ³
      ];

      vi.mocked(createBlobStorageClient).mockReturnValue({
        getBattleLogs: vi.fn().mockResolvedValue(mockBattleLogs),
      } as any);

      const res = await app.request('/api/statistics/seasons');
      const json = await res.json();

      expect(res.status).toBe(200);
      expect(json.success).toBe(true);
      expect(json.data.seasons).toEqual([3, 2, 1]); // é™é †ã€é‡è¤‡æ’é™¤
    });

    it('å¯¾æˆ¦å±¥æ­´0ä»¶æ™‚ã¯ç©ºé…åˆ—ãŒè¿”ã•ã‚Œã‚‹', async () => {
      vi.mocked(createBlobStorageClient).mockReturnValue({
        getBattleLogs: vi.fn().mockResolvedValue([]),
      } as any);

      const res = await app.request('/api/statistics/seasons');
      const json = await res.json();

      expect(res.status).toBe(200);
      expect(json.success).toBe(true);
      expect(json.data.seasons).toEqual([]);
    });

    it('æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ãŒå…ˆé ­ã«æ¥ã‚‹', async () => {
      const mockBattleLogs = [
        { id: '1', season: 10 },
        { id: '2', season: 5 },
        { id: '3', season: 15 },
      ];

      vi.mocked(createBlobStorageClient).mockReturnValue({
        getBattleLogs: vi.fn().mockResolvedValue(mockBattleLogs),
      } as any);

      const res = await app.request('/api/statistics/seasons');
      const json = await res.json();

      expect(json.data.seasons[0]).toBe(15); // æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ãŒå…ˆé ­
    });
  });

  describe('ç•°å¸¸ç³»', () => {
    it('å–å¾—ã‚¨ãƒ©ãƒ¼æ™‚ã¯500ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹', async () => {
      vi.mocked(createBlobStorageClient).mockReturnValue({
        getBattleLogs: vi.fn().mockRejectedValue(new Error('DB Error')),
      } as any);

      const res = await app.request('/api/statistics/seasons');
      const json = await res.json();

      expect(res.status).toBe(500);
      expect(json.success).toBe(false);
      expect(json.error.code).toBe('INTERNAL_ERROR');
    });
  });

  describe('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼', () => {
    it('metaã«timestampã¨requestIdãŒå«ã¾ã‚Œã‚‹', async () => {
      vi.mocked(createBlobStorageClient).mockReturnValue({
        getBattleLogs: vi.fn().mockResolvedValue([]),
      } as any);

      const res = await app.request('/api/statistics/seasons');
      const json = await res.json();

      expect(json.meta.timestamp).toBeDefined();
      expect(json.meta.requestId).toBeDefined();
    });
  });
});
```

---

## å®Œäº†æ¡ä»¶

- [ ] `GET /api/statistics/seasons` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ãŒé™é †ã§ã‚½ãƒ¼ãƒˆã•ã‚Œã¦è¿”ã•ã‚Œã‚‹
- [ ] é‡è¤‡ã‚·ãƒ¼ã‚ºãƒ³ãŒæ’é™¤ã•ã‚Œã¦ã„ã‚‹
- [ ] å¯¾æˆ¦å±¥æ­´0ä»¶æ™‚ã¯ç©ºé…åˆ—ãŒè¿”ã•ã‚Œã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼æ™‚ã¯é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦æˆåŠŸã™ã‚‹

---

## å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# TDDãƒ•ãƒ­ãƒ¼
/tsumiki:tdd-red           # ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
/tsumiki:tdd-green         # æœ€å°å®Ÿè£…ï¼ˆæˆåŠŸï¼‰
/tsumiki:tdd-refactor      # ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
/tsumiki:tdd-verify-complete  # å“è³ªç¢ºèª
```

---

## æ¤œè¨¼æ‰‹é †

1. `packages/api/src/functions/getSeasons.ts` ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
2. `pnpm test` ã§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã‹ç¢ºèª
3. APIã‚’å®Ÿè¡Œã—ã¦æ­£ã—ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã‹ç¢ºèª:
   ```bash
   curl http://localhost:8787/api/statistics/seasons
   ```
4. å‹ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã™ã‚‹ã‹ç¢ºèª

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­è¨ˆ api-endpoints.md 4.1](../../design/deck-management-extension/api-endpoints.md)
- [è¦ä»¶å®šç¾© REQ-EXT-203ã€œ205](../../spec/deck-management-extension-requirements.md)
