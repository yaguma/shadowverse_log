# TASK-0016: MyDeck API - DELETE å®Ÿè£…

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

- **ã‚¿ã‚¹ã‚¯ID**: TASK-0016
- **ã‚¿ã‚¤ãƒˆãƒ«**: MyDeck API - DELETE å®Ÿè£…
- **ã‚¿ã‚¤ãƒ—**: TDD
- **æ¨å®šå·¥æ•°**: 2æ™‚é–“
- **ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ä½¿ç”¨ãƒ‡ãƒƒã‚­ç®¡ç†æ©Ÿèƒ½
- **ä¿¡é ¼æ€§**: ğŸ”µï¼ˆapi-endpoints.md 3.3ã‚ˆã‚Šã€REQ-EXT-108, REQ-EXT-402ï¼‰
- **ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0002, TASK-0004
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0017
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: [ ] æœªç€æ‰‹

---

## è¦ä»¶

### æ©Ÿèƒ½è¦ä»¶

- DELETE /api/my-decks/:id ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…
- battle_logs ã‹ã‚‰ã®å‚ç…§ãƒã‚§ãƒƒã‚¯
- å‚ç…§ã‚ã‚Šæ™‚ã¯ 409 DeleteConstraintError ã‚’è¿”ã™
- å‚ç…§ãªã—æ™‚ã¯ 204 No Content ã‚’è¿”ã™

### é–¢é€£è¦ä»¶ID

- REQ-EXT-108: å‰Šé™¤åˆ¶ç´„ãƒã‚§ãƒƒã‚¯
- REQ-EXT-402: å‚ç…§æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼

---

## å®Ÿè£…è©³ç´°

### 1. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `DELETE /api/my-decks/:id`

**ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `id`: å‰Šé™¤å¯¾è±¡ã®MyDeck ID

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
// æˆåŠŸæ™‚: 204 No Content
// (ãƒœãƒ‡ã‚£ãªã—)

// å‚ç…§ã‚ã‚Šæ™‚: 409 Conflict
interface DeleteConstraintErrorResponse {
  success: false;
  error: {
    code: 'DELETE_CONSTRAINT_ERROR';
    message: string;
    details: {
      referencedBy: 'battle_logs';
      count: number;  // å‚ç…§ã—ã¦ã„ã‚‹å¯¾æˆ¦å±¥æ­´ã®ä»¶æ•°
    };
  };
  meta: {
    timestamp: string;
  };
}

// å­˜åœ¨ã—ãªã„å ´åˆ: 404 Not Found
interface NotFoundErrorResponse {
  success: false;
  error: {
    code: 'MY_DECK_NOT_FOUND';
    message: string;
  };
  meta: {
    timestamp: string;
  };
}
```

### 2. å‚ç…§ãƒã‚§ãƒƒã‚¯å®Ÿè£…

```typescript
// packages/api/src/services/myDeckService.ts

/**
 * MyDeckãŒbattle_logsã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
 */
export async function checkMyDeckReferences(
  myDeckId: string
): Promise<{ isReferenced: boolean; count: number }> {
  const battleLogs = await getBattleLogs();
  const referencingLogs = battleLogs.filter(
    (log) => log.myDeckId === myDeckId
  );

  return {
    isReferenced: referencingLogs.length > 0,
    count: referencingLogs.length,
  };
}
```

### 3. APIãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…

```typescript
// packages/api/src/functions/myDecks/deleteMyDeck.ts

import { Hono } from 'hono';
import { checkMyDeckReferences, deleteMyDeckById, getMyDeckById } from '../../services/myDeckService';

export const deleteMyDeck = new Hono().delete('/:id', async (c) => {
  const id = c.req.param('id');

  // MyDeckå­˜åœ¨ç¢ºèª
  const myDeck = await getMyDeckById(id);
  if (!myDeck) {
    return c.json({
      success: false,
      error: {
        code: 'MY_DECK_NOT_FOUND',
        message: `MyDeck ID: ${id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`,
      },
      meta: { timestamp: new Date().toISOString() },
    }, 404);
  }

  // å‚ç…§ãƒã‚§ãƒƒã‚¯
  const { isReferenced, count } = await checkMyDeckReferences(id);
  if (isReferenced) {
    return c.json({
      success: false,
      error: {
        code: 'DELETE_CONSTRAINT_ERROR',
        message: `ã“ã®ãƒ‡ãƒƒã‚­ã¯${count}ä»¶ã®å¯¾æˆ¦å±¥æ­´ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“`,
        details: {
          referencedBy: 'battle_logs',
          count,
        },
      },
      meta: { timestamp: new Date().toISOString() },
    }, 409);
  }

  // å‰Šé™¤å®Ÿè¡Œ
  await deleteMyDeckById(id);

  return c.body(null, 204);
});
```

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§

| No | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æœŸå¾…çµæœ | å„ªå…ˆåº¦ |
|----|-------------|----------|--------|
| 1 | å‚ç…§ãªã—ã§å‰Šé™¤ | 204 No Content | é«˜ |
| 2 | å‚ç…§ã‚ã‚Šã§å‰Šé™¤è©¦è¡Œ | 409 Conflict | é«˜ |
| 3 | å­˜åœ¨ã—ãªã„IDã§å‰Šé™¤è©¦è¡Œ | 404 Not Found | é«˜ |
| 4 | å‰Šé™¤å¾Œã«ä¸€è¦§ã‹ã‚‰æ¶ˆãˆã‚‹ã“ã¨ | ä¸€è¦§ã«å«ã¾ã‚Œãªã„ | é«˜ |
| 5 | å‚ç…§ä»¶æ•°ãŒæ­£ã—ãè¿”ã•ã‚Œã‚‹ | countå€¤ãŒæ­£ç¢º | ä¸­ |

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹

```typescript
// packages/api/src/functions/myDecks/__tests__/deleteMyDeck.test.ts

import { describe, it, expect, beforeEach, afterEach } from 'vitest';

describe('DELETE /api/my-decks/:id', () => {
  let testMyDeckId: string;

  beforeEach(async () => {
    // ãƒ†ã‚¹ãƒˆç”¨MyDeckã‚’ä½œæˆ
    const response = await app.request('/api/my-decks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        deckId: 'deck-001',
        deckName: 'ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒƒã‚­',
      }),
    });
    const body = await response.json();
    testMyDeckId = body.data.id;
  });

  describe('æ­£å¸¸ç³»', () => {
    it('å‚ç…§ãªã—ã§204 No ContentãŒè¿”ã‚‹', async () => {
      const response = await app.request(`/api/my-decks/${testMyDeckId}`, {
        method: 'DELETE',
      });

      expect(response.status).toBe(204);
      expect(await response.text()).toBe('');
    });

    it('å‰Šé™¤å¾Œã«ä¸€è¦§ã‹ã‚‰æ¶ˆãˆã‚‹ã“ã¨', async () => {
      // å‰Šé™¤å®Ÿè¡Œ
      await app.request(`/api/my-decks/${testMyDeckId}`, {
        method: 'DELETE',
      });

      // ä¸€è¦§å–å¾—
      const listResponse = await app.request('/api/my-decks');
      const body = await listResponse.json();

      const deleted = body.data.find(
        (deck: any) => deck.id === testMyDeckId
      );
      expect(deleted).toBeUndefined();
    });
  });

  describe('ç•°å¸¸ç³»', () => {
    it('å‚ç…§ã‚ã‚Šã§409 ConflictãŒè¿”ã‚‹', async () => {
      // å¯¾æˆ¦å±¥æ­´ã‚’ä½œæˆã—ã¦å‚ç…§ã‚’æŒãŸã›ã‚‹
      await createBattleLogWithMyDeck(testMyDeckId);

      const response = await app.request(`/api/my-decks/${testMyDeckId}`, {
        method: 'DELETE',
      });

      expect(response.status).toBe(409);
      const body = await response.json();
      expect(body.success).toBe(false);
      expect(body.error.code).toBe('DELETE_CONSTRAINT_ERROR');
      expect(body.error.details.referencedBy).toBe('battle_logs');
      expect(body.error.details.count).toBeGreaterThan(0);
    });

    it('å­˜åœ¨ã—ãªã„IDã§404 Not FoundãŒè¿”ã‚‹', async () => {
      const response = await app.request('/api/my-decks/non-existent-id', {
        method: 'DELETE',
      });

      expect(response.status).toBe(404);
      const body = await response.json();
      expect(body.error.code).toBe('MY_DECK_NOT_FOUND');
    });
  });
});
```

---

## å®Œäº†æ¡ä»¶

- [ ] DELETE /api/my-decks/:id ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] battle_logsã‹ã‚‰ã®å‚ç…§ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] å‚ç…§ã‚ã‚Šæ™‚ã«409 ConflictãŒè¿”ã•ã‚Œã‚‹
- [ ] å‚ç…§ãªã—æ™‚ã«204 No ContentãŒè¿”ã•ã‚Œã‚‹
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒæˆåŠŸã™ã‚‹
- [ ] ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# TDDãƒ•ãƒ­ãƒ¼
/tsumiki:tdd-red           # ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
/tsumiki:tdd-green         # æœ€å°å®Ÿè£…ï¼ˆæˆåŠŸï¼‰
/tsumiki:tdd-refactor      # ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
/tsumiki:tdd-verify-complete  # å“è³ªç¢ºèª
```

---

## æ¤œè¨¼æ‰‹é †

1. ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆRedï¼‰
2. æœ€å°é™ã®å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆGreenï¼‰
3. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã‚‚ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
4. `pnpm test` ã§å…¨ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
5. `pnpm lint` ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª
6. `pnpm type-check` ã§å‹ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª

---

## å‚è€ƒè³‡æ–™

- [api-endpoints.md - 3.3 DELETE /api/my-decks/:id](../../../docs/design/deck-management-extension/api-endpoints.md)
- [architecture.md - 5.1 DeckStore](../../../docs/design/deck-management-extension/architecture.md)
