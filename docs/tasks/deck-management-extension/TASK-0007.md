# TASK-0007: DeckMaster API - PUT 実装

**タスクID**: TASK-0007
**タスクタイプ**: TDD
**推定工数**: 2時間
**フェーズ**: Phase 2 - デッキ種別管理機能
**信頼性レベル**: 🔵 *api-endpoints.md 2.3より、REQ-EXT-006〜007*

## 関連文書
- [技術設計書](../../design/deck-management-extension/README.md)
- [APIエンドポイント定義](../../design/deck-management-extension/api-endpoints.md)
- [要件定義](../../design/deck-management-extension/requirements.md)

## タスク概要
DeckMasterの更新APIを実装する。deckNameのみ更新可能とし、classNameは変更不可。updated_atの自動更新を行う。

## 依存タスク
- **前提タスク**: [TASK-0003](TASK-0003.md) - DeckMasterスキーマ定義、[TASK-0004](TASK-0004.md) - DeckMasterリポジトリ実装
- **後続タスク**: [TASK-0009](TASK-0009.md) - DeckStore拡張

## 完了条件
- [ ] PUT /api/deck-master/:id エンドポイントが動作すること
- [ ] deckNameのみ更新できること
- [ ] classNameは更新されないこと
- [ ] updated_atが自動更新されること
- [ ] 存在しないIDで404エラーが返ること
- [ ] 全テストがパスすること

---
## 実装詳細

### リクエスト形式
```json
{
  "deckName": "新しいデッキ名"
}
```

### レスポンス形式（成功時: 200 OK）
```json
{
  "success": true,
  "data": {
    "id": "existing-uuid",
    "className": "ウィッチ",
    "deckName": "新しいデッキ名",
    "sortOrder": 5,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  },
  "meta": {
    "timestamp": "2024-01-15T10:30:00.000Z"
  }
}
```

### エラーレスポンス（404 Not Found）
```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "指定されたデッキ種別が見つかりません"
  }
}
```

### バリデーションルール

| フィールド | ルール | エラーコード |
|-----------|--------|-------------|
| deckName | 必須、1〜50文字 | VALIDATION_ERROR |
| className | リクエストに含まれていても無視 | - |

### 更新ロジック
- deckNameのみ更新対象
- updated_atは現在時刻で自動更新
- classNameがリクエストに含まれていても無視（変更不可）
- sortOrderは変更不可（別APIで対応予定）

---
## 単体テスト要件

### テストファイル
`packages/api/src/__tests__/deck-master.put.test.ts`

### テストケース

#### 正常系
1. **正常更新で200 OK**
   - 入力: PUT /api/deck-master/:id { deckName: "新名称" }
   - 期待: 200 OK、deckNameが更新される

2. **updated_atが更新される**
   - 入力: 更新リクエスト
   - 期待: updated_atが更新前より後の時刻

3. **classNameは更新されない**
   - 入力: { deckName: "新名称", className: "別クラス" }
   - 期待: classNameは元のまま

#### エラー系
4. **deckName空でValidationError**
   - 入力: { deckName: "" }
   - 期待: 400 Bad Request、error.code: "VALIDATION_ERROR"

5. **deckName51文字でValidationError**
   - 入力: { deckName: "a".repeat(51) }
   - 期待: 400 Bad Request

6. **存在しないIDで404 Not Found**
   - 入力: PUT /api/deck-master/non-existent-id
   - 期待: 404 Not Found、error.code: "NOT_FOUND"

7. **リクエストボディなしでValidationError**
   - 入力: PUT /api/deck-master/:id（ボディなし）
   - 期待: 400 Bad Request

8. **無効なUUID形式で400 Bad Request**
   - 入力: PUT /api/deck-master/invalid-uuid-format
   - 期待: 400 Bad Request

---
## 実装手順

### Red Phase（失敗するテストを書く）
1. テストファイル `deck-master.put.test.ts` を作成
2. 上記テストケースを実装
3. テスト実行 → 失敗確認

### Green Phase（テストを通す最小実装）
1. コントローラーにupdateメソッド追加
2. サービスにupdateメソッド追加
3. バリデータにupdateスキーマ追加
4. リポジトリにupdateメソッド追加（必要に応じて）
5. テスト実行 → 成功確認

### Refactor Phase（リファクタリング）
1. 共通エラーハンドリングの整理
2. 更新ロジックの明確化
3. テスト実行 → 成功確認

---
## 信頼性レベルサマリー

| 項目 | レベル | 出典 |
|------|--------|------|
| APIエンドポイント仕様 | 🔵 | api-endpoints.md 2.3 |
| バリデーションルール | 🔵 | REQ-EXT-006〜007 |
| className変更不可 | 🔵 | REQ-EXT-007 |
| レスポンス形式 | 🔵 | api-endpoints.md |
