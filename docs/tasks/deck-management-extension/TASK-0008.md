# TASK-0008: DeckMaster API - DELETE 実装

**タスクID**: TASK-0008
**タスクタイプ**: TDD
**推定工数**: 2時間
**フェーズ**: Phase 2 - デッキ種別管理機能
**信頼性レベル**: 🔵 *api-endpoints.md 2.4より、REQ-EXT-008, REQ-EXT-401*

## 関連文書
- [技術設計書](../../design/deck-management-extension/README.md)
- [APIエンドポイント定義](../../design/deck-management-extension/api-endpoints.md)
- [要件定義](../../design/deck-management-extension/requirements.md)

## タスク概要
DeckMasterの削除APIを実装する。battle_logsからの参照チェックを行い、参照がある場合は削除を拒否する。

## 依存タスク
- **前提タスク**: [TASK-0002](TASK-0002.md) - battle_logsテーブル定義、[TASK-0004](TASK-0004.md) - DeckMasterリポジトリ実装
- **後続タスク**: [TASK-0009](TASK-0009.md) - DeckStore拡張

## 完了条件
- [ ] DELETE /api/deck-master/:id エンドポイントが動作すること
- [ ] battle_logsからの参照チェックが機能すること
- [ ] 参照ありで409 Conflictが返ること
- [ ] 参照なしで204 No Contentが返ること
- [ ] 全テストがパスすること

---
## 実装詳細

### レスポンス形式（成功時: 204 No Content）
レスポンスボディなし

### エラーレスポンス（409 Conflict）
```json
{
  "success": false,
  "error": {
    "code": "DELETE_CONSTRAINT_ERROR",
    "message": "このデッキ種別は対戦履歴で使用されているため削除できません",
    "details": {
      "usageCount": 15
    }
  }
}
```

### エラーレスポンス（404 Not Found）
```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "指定されたデッキ種別が見つかりません"
  }
}
```

### 参照チェックロジック
```sql
SELECT COUNT(*) as usage_count
FROM battle_logs
WHERE player1_deck_master_id = :id
   OR player2_deck_master_id = :id
```

### 削除可否判定
1. IDでDeckMasterを検索
2. 存在しない場合 → 404 Not Found
3. battle_logsで参照チェック
4. 参照あり（usageCount > 0） → 409 Conflict
5. 参照なし → DELETE実行 → 204 No Content

---
## 単体テスト要件

### テストファイル
`packages/api/src/__tests__/deck-master.delete.test.ts`

### テストケース

#### 正常系
1. **参照なしで204 No Content**
   - 入力: DELETE /api/deck-master/:id（参照なし）
   - 期待: 204 No Content、レスポンスボディなし

2. **削除後に一覧から消える**
   - 入力: 削除後にGET /api/deck-master
   - 期待: 削除したデータが一覧に含まれない

#### エラー系
3. **参照ありで409 Conflict**
   - 入力: DELETE /api/deck-master/:id（battle_logsで参照あり）
   - 期待: 409 Conflict、error.code: "DELETE_CONSTRAINT_ERROR"

4. **存在しないIDで404 Not Found**
   - 入力: DELETE /api/deck-master/non-existent-id
   - 期待: 404 Not Found、error.code: "NOT_FOUND"

5. **無効なUUID形式で400 Bad Request**
   - 入力: DELETE /api/deck-master/invalid-uuid-format
   - 期待: 400 Bad Request

6. **409エラーにusageCountが含まれる**
   - 入力: DELETE /api/deck-master/:id（15件参照あり）
   - 期待: error.details.usageCount: 15

---
## 実装手順

### Red Phase（失敗するテストを書く）
1. テストファイル `deck-master.delete.test.ts` を作成
2. 上記テストケースを実装
3. テスト実行 → 失敗確認

### Green Phase（テストを通す最小実装）
1. コントローラーにdeleteメソッド追加
2. サービスにdeleteメソッド追加
3. サービスにcheckReferenceメソッド追加
4. リポジトリにdeleteメソッド追加（必要に応じて）
5. リポジトリにcountReferenceメソッド追加
6. テスト実行 → 成功確認

### Refactor Phase（リファクタリング）
1. エラークラスの整理（DeleteConstraintError）
2. 参照チェックロジックの共通化
3. テスト実行 → 成功確認

---
## 信頼性レベルサマリー

| 項目 | レベル | 出典 |
|------|--------|------|
| APIエンドポイント仕様 | 🔵 | api-endpoints.md 2.4 |
| 参照チェックロジック | 🔵 | REQ-EXT-008, REQ-EXT-401 |
| エラーコード | 🔵 | api-endpoints.md |
| レスポンス形式 | 🔵 | api-endpoints.md |
