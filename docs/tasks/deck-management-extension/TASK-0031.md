# TASK-0031: BattleLogDialogレイアウト改善

## タスク情報

- **タスクID**: TASK-0031
- **タイプ**: TDD
- **推定工数**: 2時間
- **フェーズ**: Phase 6 - 対戦履歴UI改善
- **信頼性**: 🔵（REQ-EXT-301より）
- **依存タスク**: TASK-0030
- **後続タスク**: TASK-0032
- **ステータス**: [ ] 未完了

---

## 概要

BattleLogDialogのレイアウトを改善し、シーズンと対戦日を横並びレイアウトに変更する。モバイルではレスポンシブ対応で縦並びになるようにする。

---

## 実装内容

### 1. BattleLogDialogのレイアウト改善

`packages/frontend/src/components/battle-log/BattleLogDialog.tsx`:

```typescript
import { useState, useEffect } from 'react';
import { Dialog } from '@headlessui/react';
import { XMarkIcon } from '@heroicons/react/24/outline';
import type { BattleLogInput } from '@shadowverse-log/shared';

interface BattleLogDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onSaved?: () => void;
  defaultSeason?: number;
  editData?: BattleLogInput;
}

export const BattleLogDialog = ({
  isOpen,
  onClose,
  onSaved,
  defaultSeason,
  editData,
}: BattleLogDialogProps) => {
  const [formData, setFormData] = useState<BattleLogInput>({
    season: defaultSeason ?? getCurrentSeason(),
    date: getTodayString(),
    myDeckId: '',
    opponentDeckId: '',
    turn: '先攻',
    result: '勝ち',
    battleType: 'ランクマッチ',
    rank: '-',
    group: '-',
  });

  // ... 既存のロジック

  return (
    <Dialog open={isOpen} onClose={onClose} className="relative z-50">
      {/* オーバーレイ */}
      <div className="fixed inset-0 bg-black/30" aria-hidden="true" />

      {/* ダイアログコンテナ */}
      <div className="fixed inset-0 flex items-center justify-center p-4">
        <Dialog.Panel className="w-full max-w-lg bg-white rounded-lg shadow-xl">
          {/* ヘッダー */}
          <div className="flex items-center justify-between px-6 py-4 border-b">
            <Dialog.Title className="text-lg font-semibold">
              {editData ? '対戦履歴を編集' : '対戦を記録'}
            </Dialog.Title>
            <button
              onClick={onClose}
              className="p-1 rounded-md hover:bg-gray-100 transition-colors"
            >
              <XMarkIcon className="h-5 w-5 text-gray-500" />
            </button>
          </div>

          {/* フォーム */}
          <form onSubmit={handleSubmit} className="px-6 py-4 space-y-4">
            {/* シーズンと対戦日: 横並びレイアウト（モバイルは縦並び） */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* シーズン */}
              <div>
                <label
                  htmlFor="season"
                  className="block text-sm font-medium text-gray-700 mb-1"
                >
                  シーズン
                </label>
                <select
                  id="season"
                  name="season"
                  value={formData.season}
                  onChange={handleChange}
                  className="
                    w-full px-3 py-2 border border-gray-300 rounded-md
                    focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                  "
                >
                  {availableSeasons.map((season) => (
                    <option key={season} value={season}>
                      シーズン {season}
                    </option>
                  ))}
                </select>
              </div>

              {/* 対戦日 */}
              <div>
                <label
                  htmlFor="date"
                  className="block text-sm font-medium text-gray-700 mb-1"
                >
                  対戦日
                </label>
                <input
                  type="date"
                  id="date"
                  name="date"
                  value={formData.date}
                  onChange={handleChange}
                  className="
                    w-full px-3 py-2 border border-gray-300 rounded-md
                    focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                  "
                />
              </div>
            </div>

            {/* 使用デッキ */}
            <div>
              <label
                htmlFor="myDeckId"
                className="block text-sm font-medium text-gray-700 mb-1"
              >
                使用デッキ
              </label>
              <select
                id="myDeckId"
                name="myDeckId"
                value={formData.myDeckId}
                onChange={handleChange}
                required
                className="
                  w-full px-3 py-2 border border-gray-300 rounded-md
                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                "
              >
                <option value="">選択してください</option>
                {myDecks.map((deck) => (
                  <option key={deck.id} value={deck.id}>
                    {deck.deckName}
                  </option>
                ))}
              </select>
            </div>

            {/* 相手デッキ */}
            <div>
              <label
                htmlFor="opponentDeckId"
                className="block text-sm font-medium text-gray-700 mb-1"
              >
                相手デッキ
              </label>
              <select
                id="opponentDeckId"
                name="opponentDeckId"
                value={formData.opponentDeckId}
                onChange={handleChange}
                required
                className="
                  w-full px-3 py-2 border border-gray-300 rounded-md
                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                "
              >
                <option value="">選択してください</option>
                {opponentDecks.map((deck) => (
                  <option key={deck.id} value={deck.id}>
                    {deck.deckName}
                  </option>
                ))}
              </select>
            </div>

            {/* ターンと勝敗: 横並びレイアウト */}
            <div className="grid grid-cols-2 gap-4">
              {/* ターン */}
              <div>
                <label
                  htmlFor="turn"
                  className="block text-sm font-medium text-gray-700 mb-1"
                >
                  ターン
                </label>
                <select
                  id="turn"
                  name="turn"
                  value={formData.turn}
                  onChange={handleChange}
                  className="
                    w-full px-3 py-2 border border-gray-300 rounded-md
                    focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                  "
                >
                  <option value="先攻">先攻</option>
                  <option value="後攻">後攻</option>
                </select>
              </div>

              {/* 勝敗 */}
              <div>
                <label
                  htmlFor="result"
                  className="block text-sm font-medium text-gray-700 mb-1"
                >
                  勝敗
                </label>
                <select
                  id="result"
                  name="result"
                  value={formData.result}
                  onChange={handleChange}
                  className="
                    w-full px-3 py-2 border border-gray-300 rounded-md
                    focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                  "
                >
                  <option value="勝ち">勝ち</option>
                  <option value="負け">負け</option>
                </select>
              </div>
            </div>

            {/* 対戦タイプ詳細（折りたたみ可能） */}
            <details className="border rounded-md">
              <summary className="px-3 py-2 cursor-pointer text-sm font-medium text-gray-700 hover:bg-gray-50">
                詳細設定（ランク・グループ・対戦種別）
              </summary>
              <div className="px-3 py-3 space-y-4 border-t">
                {/* 対戦種別 */}
                <div>
                  <label htmlFor="battleType" className="block text-sm font-medium text-gray-700 mb-1">
                    対戦種別
                  </label>
                  <select
                    id="battleType"
                    name="battleType"
                    value={formData.battleType}
                    onChange={handleChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                  >
                    <option value="ランクマッチ">ランクマッチ</option>
                    <option value="対戦台">対戦台</option>
                    <option value="ロビー大会">ロビー大会</option>
                  </select>
                </div>

                {/* ランク・グループ */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label htmlFor="rank" className="block text-sm font-medium text-gray-700 mb-1">
                      ランク
                    </label>
                    <select
                      id="rank"
                      name="rank"
                      value={formData.rank}
                      onChange={handleChange}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    >
                      <option value="-">-</option>
                      <option value="サファイア">サファイア</option>
                      <option value="ダイアモンド">ダイアモンド</option>
                      <option value="ルビー">ルビー</option>
                      <option value="トパーズ">トパーズ</option>
                    </select>
                  </div>
                  <div>
                    <label htmlFor="group" className="block text-sm font-medium text-gray-700 mb-1">
                      グループ
                    </label>
                    <select
                      id="group"
                      name="group"
                      value={formData.group}
                      onChange={handleChange}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    >
                      <option value="-">-</option>
                      <option value="A">A</option>
                      <option value="AA">AA</option>
                      <option value="AAA">AAA</option>
                      <option value="Master">Master</option>
                    </select>
                  </div>
                </div>
              </div>
            </details>
          </form>

          {/* フッター */}
          <div className="flex justify-end gap-3 px-6 py-4 border-t bg-gray-50">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
            >
              キャンセル
            </button>
            <button
              type="submit"
              form="battle-log-form"
              disabled={isSubmitting}
              className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50"
            >
              {isSubmitting ? '保存中...' : '保存'}
            </button>
          </div>
        </Dialog.Panel>
      </div>
    </Dialog>
  );
};
```

### 2. レスポンシブブレークポイント確認

Tailwind CSSのブレークポイント:
- `md`: 768px以上で横並び
- デフォルト（md未満）: 縦並び

---

## テスト要件

### 単体テスト（Vitest）

`packages/frontend/src/components/battle-log/__tests__/BattleLogDialog.test.tsx`:

```typescript
import { render, screen } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import { BattleLogDialog } from '../BattleLogDialog';

describe('BattleLogDialog レイアウト', () => {
  const defaultProps = {
    isOpen: true,
    onClose: vi.fn(),
    onSaved: vi.fn(),
  };

  describe('デスクトップレイアウト', () => {
    it('シーズンと対戦日が同じ行に配置される（grid-cols-2）', () => {
      render(<BattleLogDialog {...defaultProps} />);

      const seasonField = screen.getByLabelText('シーズン');
      const dateField = screen.getByLabelText('対戦日');

      // 親要素がgridであることを確認
      const parent = seasonField.closest('.grid');
      expect(parent).toHaveClass('md:grid-cols-2');
    });
  });

  describe('レイアウト要素の存在確認', () => {
    it('シーズンフィールドが表示される', () => {
      render(<BattleLogDialog {...defaultProps} />);
      expect(screen.getByLabelText('シーズン')).toBeInTheDocument();
    });

    it('対戦日フィールドが表示される', () => {
      render(<BattleLogDialog {...defaultProps} />);
      expect(screen.getByLabelText('対戦日')).toBeInTheDocument();
    });

    it('ターンと勝敗が横並びで表示される', () => {
      render(<BattleLogDialog {...defaultProps} />);

      const turnField = screen.getByLabelText('ターン');
      const resultField = screen.getByLabelText('勝敗');

      const turnParent = turnField.closest('.grid');
      expect(turnParent).toHaveClass('grid-cols-2');

      const resultParent = resultField.closest('.grid');
      expect(resultParent).toHaveClass('grid-cols-2');
    });
  });

  describe('詳細設定', () => {
    it('詳細設定が折りたたまれている', () => {
      render(<BattleLogDialog {...defaultProps} />);

      const details = screen.getByText('詳細設定（ランク・グループ・対戦種別）');
      expect(details).toBeInTheDocument();
    });
  });
});
```

### レスポンシブテスト（Playwright）

`packages/frontend/e2e/battle-log-dialog-responsive.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('BattleLogDialog レスポンシブレイアウト', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/battle-logs');
    await page.click('button:has-text("対戦を記録")');
    await expect(page.locator('[role="dialog"]')).toBeVisible();
  });

  test('デスクトップ: シーズンと対戦日が横並び', async ({ page }) => {
    // デスクトップサイズに設定
    await page.setViewportSize({ width: 1024, height: 768 });

    const seasonField = page.locator('label:has-text("シーズン")').locator('..');
    const dateField = page.locator('label:has-text("対戦日")').locator('..');

    // 横並びを確認（Y座標が同じ）
    const seasonBox = await seasonField.boundingBox();
    const dateBox = await dateField.boundingBox();

    if (seasonBox && dateBox) {
      // Y座標が同じ（許容誤差5px）
      expect(Math.abs(seasonBox.y - dateBox.y)).toBeLessThan(5);
    }
  });

  test('モバイル: シーズンと対戦日が縦並び', async ({ page }) => {
    // モバイルサイズに設定
    await page.setViewportSize({ width: 375, height: 667 });

    const seasonField = page.locator('label:has-text("シーズン")').locator('..');
    const dateField = page.locator('label:has-text("対戦日")').locator('..');

    // 縦並びを確認（Y座標が異なる）
    const seasonBox = await seasonField.boundingBox();
    const dateBox = await dateField.boundingBox();

    if (seasonBox && dateBox) {
      // Y座標が異なる（dateがseasonより下）
      expect(dateBox.y).toBeGreaterThan(seasonBox.y + seasonBox.height - 10);
    }
  });
});
```

---

## 完了条件

- [ ] シーズンと対戦日が横並びレイアウトになっている（デスクトップ）
- [ ] モバイルではシーズンと対戦日が縦並びになる
- [ ] ターンと勝敗が横並びになっている
- [ ] 詳細設定が折りたたみ可能になっている
- [ ] 単体テストがすべて成功する
- [ ] レスポンシブテストが成功する

---

## 実行コマンド

```bash
# TDDフロー
/tsumiki:tdd-red           # テスト実装（失敗）
/tsumiki:tdd-green         # 最小実装（成功）
/tsumiki:tdd-refactor      # リファクタリング
/tsumiki:tdd-verify-complete  # 品質確認
```

---

## 検証手順

1. `packages/frontend/src/components/battle-log/BattleLogDialog.tsx` が更新されているか確認
2. `pnpm test` でテストが成功するか確認
3. 手動確認:
   - デスクトップでシーズンと対戦日が横並びになっているか
   - モバイルで縦並びになっているか（DevToolsでモバイルビューをシミュレート）

---

## 関連ドキュメント

- [要件定義 REQ-EXT-301](../../spec/deck-management-extension-requirements.md)
- [TASK-0030: 統計画面E2Eテスト](./TASK-0030.md)
