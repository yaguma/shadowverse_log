# TASK-0002: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0002
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 2æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - åŸºç›¤ãƒ»å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *architecture.mdã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/deck-management-extension/requirements.md)
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/deck-management-extension/architecture.md)
- **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©**: [ğŸ“ interfaces.ts](../../design/deck-management-extension/interfaces.ts)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ãƒ‡ãƒƒã‚­ç®¡ç†æ©Ÿèƒ½ã§ä½¿ç”¨ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã€‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã¨å‰Šé™¤åˆ¶ç´„ã‚¨ãƒ©ãƒ¼ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã€ãŠã‚ˆã³ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ•ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0001](TASK-0001.md) - å…±é€šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãƒ»å‹å®šç¾©ã®å®Ÿè£…
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0005ã€œTASK-0008ï¼ˆPhase 2ã‚¿ã‚¹ã‚¯ï¼‰

## å®Œäº†æ¡ä»¶

- [ ] ValidationErrorã®ãƒ‘ãƒ¼ã‚¹é–¢æ•°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] DeleteConstraintErrorã®ãƒ‘ãƒ¼ã‚¹é–¢æ•°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ—¥æœ¬èªå¤‰æ›é–¢æ•°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ•ãƒƒã‚¯ï¼ˆuseApiErrorï¼‰ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒãƒ‘ã‚¹ã—ã¦ã„ã‚‹
- [ ] TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨

---

## å®Ÿè£…è©³ç´°

### 1. ValidationErrorãƒ‘ãƒ¼ã‚¹é–¢æ•° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *interfaces.ts REQ-EXT-403å¯¾å¿œ*

APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ValidationErrorå‹ã¸ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã€‚

```typescript
/**
 * APIã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒValidationErrorã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹
 */
export function isValidationError(error: unknown): error is ValidationError {
  return (
    typeof error === 'object' &&
    error !== null &&
    'code' in error &&
    (error as ValidationError).code === 'VALIDATION_ERROR'
  );
}

/**
 * ValidationErrorã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ¥ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹
 */
export function getValidationErrorMessages(error: ValidationError): Record<string, string> {
  const messages: Record<string, string> = {};
  for (const detail of error.details) {
    messages[detail.field] = translateValidationConstraint(detail.constraint, detail.value);
  }
  return messages;
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/shared/src/utils/error-handling.ts`ï¼ˆæ–°è¦ä½œæˆï¼‰

---

### 2. DeleteConstraintErrorãƒ‘ãƒ¼ã‚¹é–¢æ•° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *interfaces.ts REQ-EXT-401, REQ-EXT-402å¯¾å¿œ*

APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰DeleteConstraintErrorå‹ã¸ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã€‚

```typescript
/**
 * APIã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒDeleteConstraintErrorã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹
 */
export function isDeleteConstraintError(error: unknown): error is DeleteConstraintError {
  return (
    typeof error === 'object' &&
    error !== null &&
    'code' in error &&
    (error as DeleteConstraintError).code === 'DELETE_CONSTRAINT_ERROR'
  );
}

/**
 * DeleteConstraintErrorã‹ã‚‰å‚ç…§æ•°ã‚’å–å¾—ã™ã‚‹
 */
export function getReferenceCount(error: DeleteConstraintError): number {
  return error.details.referenceCount;
}

/**
 * DeleteConstraintErrorã‹ã‚‰ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã‚’å–å¾—ã™ã‚‹
 */
export function getEntityType(error: DeleteConstraintError): "deckMaster" | "myDeck" {
  return error.details.entityType;
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/shared/src/utils/error-handling.ts`

---

### 3. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ—¥æœ¬èªå¤‰æ›é–¢æ•° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£è¦ä»¶ã¨ã—ã¦ç¢ºå®š*

ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªã«å¤‰æ›ã™ã‚‹é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹ã€‚

```typescript
/**
 * ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶ç´„ã‚’æ—¥æœ¬èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›ã™ã‚‹
 */
export function translateValidationConstraint(constraint: string, value: unknown): string {
  const translations: Record<string, string> = {
    'required': 'å¿…é ˆé …ç›®ã§ã™',
    'minLength': `${value}æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„`,
    'maxLength': `${value}æ–‡å­—ä»¥ä¸‹ã§å…¥åŠ›ã—ã¦ãã ã•ã„`,
    'invalidClassName': 'ç„¡åŠ¹ãªã‚¯ãƒ©ã‚¹åã§ã™',
  };
  return translations[constraint] ?? `ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: ${constraint}`;
}

/**
 * å‰Šé™¤åˆ¶ç´„ã‚¨ãƒ©ãƒ¼ã‚’æ—¥æœ¬èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›ã™ã‚‹
 */
export function translateDeleteConstraintError(error: DeleteConstraintError): string {
  const entityTypeLabels: Record<string, string> = {
    'deckMaster': 'ãƒ‡ãƒƒã‚­ç¨®åˆ¥',
    'myDeck': 'ä½¿ç”¨ãƒ‡ãƒƒã‚­',
  };
  const entityLabel = entityTypeLabels[error.details.entityType] ?? error.details.entityType;
  return `ã“ã®${entityLabel}ã¯${error.details.referenceCount}ä»¶ã®å¯¾æˆ¦å±¥æ­´ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“`;
}

/**
 * APIã‚¨ãƒ©ãƒ¼ã‚’æ—¥æœ¬èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›ã™ã‚‹
 */
export function translateApiError(error: unknown): string {
  if (isValidationError(error)) {
    const messages = Object.values(getValidationErrorMessages(error));
    return messages.join('ã€');
  }
  if (isDeleteConstraintError(error)) {
    return translateDeleteConstraintError(error);
  }
  if (typeof error === 'object' && error !== null && 'message' in error) {
    return (error as { message: string }).message;
  }
  return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/shared/src/utils/error-handling.ts`

---

### 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ•ãƒƒã‚¯ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ—¢å­˜Reactãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã*

Reactç”¨ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ•ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã€‚

```typescript
import { useState, useCallback } from 'react';
import { translateApiError, isValidationError, getValidationErrorMessages } from '@shadowverse-log/shared';
import type { ValidationError } from '@shadowverse-log/shared';

interface UseApiErrorReturn {
  error: string | null;
  fieldErrors: Record<string, string>;
  setError: (error: unknown) => void;
  clearError: () => void;
  isValidationError: boolean;
}

export function useApiError(): UseApiErrorReturn {
  const [error, setErrorState] = useState<string | null>(null);
  const [fieldErrors, setFieldErrors] = useState<Record<string, string>>({});
  const [isValidation, setIsValidation] = useState(false);

  const setError = useCallback((err: unknown) => {
    const message = translateApiError(err);
    setErrorState(message);

    if (isValidationError(err)) {
      setFieldErrors(getValidationErrorMessages(err as ValidationError));
      setIsValidation(true);
    } else {
      setFieldErrors({});
      setIsValidation(false);
    }
  }, []);

  const clearError = useCallback(() => {
    setErrorState(null);
    setFieldErrors({});
    setIsValidation(false);
  }, []);

  return {
    error,
    fieldErrors,
    setError,
    clearError,
    isValidationError: isValidation,
  };
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/frontend/src/hooks/useApiError.ts`ï¼ˆæ–°è¦ä½œæˆï¼‰

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### isValidationErroré–¢æ•°ã®ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *å‹ã‚¬ãƒ¼ãƒ‰é–¢æ•°ã®ãƒ†ã‚¹ãƒˆ*

**Given**: ValidationErrorã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä¸ãˆã‚‰ã‚Œã‚‹
**When**: isValidationErroré–¢æ•°ã‚’å‘¼ã³å‡ºã™
**Then**: trueãŒè¿”ã•ã‚Œã‚‹

**Given**: ValidationErrorã§ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä¸ãˆã‚‰ã‚Œã‚‹
**When**: isValidationErroré–¢æ•°ã‚’å‘¼ã³å‡ºã™
**Then**: falseãŒè¿”ã•ã‚Œã‚‹

---

### getValidationErrorMessagesé–¢æ•°ã®ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›ã®ãƒ†ã‚¹ãƒˆ*

**Given**: detailsã«è¤‡æ•°ã®ã‚¨ãƒ©ãƒ¼ã‚’å«ã‚€ValidationErrorãŒä¸ãˆã‚‰ã‚Œã‚‹
**When**: getValidationErrorMessagesé–¢æ•°ã‚’å‘¼ã³å‡ºã™
**Then**: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã”ã¨ã®æ—¥æœ¬èªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹

---

### isDeleteConstraintErroré–¢æ•°ã®ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *å‹ã‚¬ãƒ¼ãƒ‰é–¢æ•°ã®ãƒ†ã‚¹ãƒˆ*

**Given**: DeleteConstraintErrorã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä¸ãˆã‚‰ã‚Œã‚‹
**When**: isDeleteConstraintErroré–¢æ•°ã‚’å‘¼ã³å‡ºã™
**Then**: trueãŒè¿”ã•ã‚Œã‚‹

---

### getReferenceCounté–¢æ•°ã®ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *å‚ç…§æ•°å–å¾—ã®ãƒ†ã‚¹ãƒˆ*

**Given**: referenceCount=5ã®DeleteConstraintErrorãŒä¸ãˆã‚‰ã‚Œã‚‹
**When**: getReferenceCounté–¢æ•°ã‚’å‘¼ã³å‡ºã™
**Then**: 5ãŒè¿”ã•ã‚Œã‚‹

---

### translateDeleteConstraintErroré–¢æ•°ã®ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ—¥æœ¬èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›ã®ãƒ†ã‚¹ãƒˆ*

**Given**: entityType=deckMaster, referenceCount=3ã®DeleteConstraintErrorãŒä¸ãˆã‚‰ã‚Œã‚‹
**When**: translateDeleteConstraintErroré–¢æ•°ã‚’å‘¼ã³å‡ºã™
**Then**: "ã“ã®ãƒ‡ãƒƒã‚­ç¨®åˆ¥ã¯3ä»¶ã®å¯¾æˆ¦å±¥æ­´ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“"ãŒè¿”ã•ã‚Œã‚‹

---

### translateApiErroré–¢æ•°ã®ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *çµ±åˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›ã®ãƒ†ã‚¹ãƒˆ*

**Given**: ValidationErrorãŒä¸ãˆã‚‰ã‚Œã‚‹
**When**: translateApiErroré–¢æ•°ã‚’å‘¼ã³å‡ºã™
**Then**: æ—¥æœ¬èªã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹

**Given**: DeleteConstraintErrorãŒä¸ãˆã‚‰ã‚Œã‚‹
**When**: translateApiErroré–¢æ•°ã‚’å‘¼ã³å‡ºã™
**Then**: æ—¥æœ¬èªã®å‰Šé™¤åˆ¶ç´„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹

**Given**: ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä¸ãˆã‚‰ã‚Œã‚‹
**When**: translateApiErroré–¢æ•°ã‚’å‘¼ã³å‡ºã™
**Then**: "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"ãŒè¿”ã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ
1. `/tsumiki:tdd-requirements TASK-0002` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

### è©³ç´°æ‰‹é †

1. **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ**: `packages/shared/src/utils/__tests__/error-handling.test.ts`
2. **å‹ã‚¬ãƒ¼ãƒ‰é–¢æ•°ã®ãƒ†ã‚¹ãƒˆä½œæˆ**: isValidationError, isDeleteConstraintError
3. **å‹ã‚¬ãƒ¼ãƒ‰é–¢æ•°ã®å®Ÿè£…**: æœ€å°å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹
4. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›é–¢æ•°ã®ãƒ†ã‚¹ãƒˆä½œæˆ**: å„translateé–¢æ•°
5. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›é–¢æ•°ã®å®Ÿè£…**: æœ€å°å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹
6. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ•ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆä½œæˆ**: useApiError
7. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ•ãƒƒã‚¯ã®å®Ÿè£…**: æœ€å°å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹
8. **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**: ã‚³ãƒ¼ãƒ‰å“è³ªã®æ”¹å–„
9. **çµ±åˆãƒ†ã‚¹ãƒˆ**: å…¨ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 10é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 10é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ªï¼ˆã™ã¹ã¦ã®è¨­è¨ˆãŒarchitecture.mdã¨interfaces.tsã«åŸºã¥ãï¼‰
