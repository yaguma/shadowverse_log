# TASK-0005: DeckMaster API - GETï¼ˆä½¿ç”¨å±¥æ­´ä»˜ãï¼‰å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0005
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 2æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - ãƒ‡ãƒƒã‚­ç¨®åˆ¥ç®¡ç†æ©Ÿèƒ½
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *api-endpoints.md 2.1ã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸
- [æŠ€è¡“è¨­è¨ˆæ›¸](../../design/deck-management-extension/README.md)
- [APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©](../../design/deck-management-extension/api-endpoints.md)
- [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³](../../design/deck-management-extension/dataflow.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦
DeckMasterã®ä¸€è¦§å–å¾—APIã‚’å®Ÿè£…ã™ã‚‹ã€‚includeUsageãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ä½¿ç”¨å±¥æ­´ä»˜ããƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã€æœ€è¿‘ä½¿ç”¨é †ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯
- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0004](TASK-0004.md) - DeckMasterãƒªãƒã‚¸ãƒˆãƒªå®Ÿè£…
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: [TASK-0009](TASK-0009.md) - DeckStoreæ‹¡å¼µ

## å®Œäº†æ¡ä»¶
- [ ] GET /api/deck-master ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‹•ä½œã™ã‚‹ã“ã¨
- [ ] includeUsage=falseæ™‚ã«sortOrderé †ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã§ãã‚‹ã“ã¨
- [ ] includeUsage=trueæ™‚ã«lastUsedDateé™é †ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã§ãã‚‹ã“ã¨
- [ ] å¯¾æˆ¦å±¥æ­´0ä»¶æ™‚ã¯sortOrderé †ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ã“ã¨
- [ ] å…¨ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ã“ã¨

---
## å®Ÿè£…è©³ç´°

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
packages/api/src/
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ deck-master.ts           # ãƒ«ãƒ¼ãƒˆå®šç¾©ï¼ˆæ–°è¦ï¼‰
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ deck-master.controller.ts # ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆæ–°è¦ï¼‰
â”œâ”€â”€ services/
â”‚   â””â”€â”€ deck-master.service.ts    # ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆæ–°è¦ï¼‰
â””â”€â”€ validators/
    â””â”€â”€ deck-master.validator.ts  # ãƒãƒªãƒ‡ãƒ¼ã‚¿ï¼ˆæ–°è¦ï¼‰
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

#### includeUsage=false
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "className": "ã‚¦ã‚£ãƒƒãƒ",
      "deckName": "ç§˜è¡“ã‚¦ã‚£ãƒƒãƒ",
      "sortOrder": 1,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "meta": {
    "timestamp": "2024-01-01T00:00:00.000Z",
    "count": 1
  }
}
```

#### includeUsage=true
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "className": "ã‚¦ã‚£ãƒƒãƒ",
      "deckName": "ç§˜è¡“ã‚¦ã‚£ãƒƒãƒ",
      "sortOrder": 1,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "usageCount": 15,
      "lastUsedDate": "2024-01-15T10:30:00.000Z"
    }
  ],
  "meta": {
    "timestamp": "2024-01-01T00:00:00.000Z",
    "count": 1
  }
}
```

### SQLã‚¯ã‚¨ãƒªï¼ˆä½¿ç”¨å±¥æ­´ä»˜ãï¼‰
```sql
SELECT
  dm.*,
  COUNT(bl.id) as usage_count,
  MAX(bl.battle_date) as last_used_date
FROM deck_master dm
LEFT JOIN battle_logs bl ON
  dm.class_name = bl.player1_class
  OR dm.class_name = bl.player2_class
GROUP BY dm.id
ORDER BY
  CASE WHEN MAX(bl.battle_date) IS NULL THEN 1 ELSE 0 END,
  MAX(bl.battle_date) DESC,
  dm.sort_order ASC
```

---
## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
`packages/api/src/__tests__/deck-master.get.test.ts`

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

#### æ­£å¸¸ç³»
1. **includeUsage=falseã§sortOrderé †ã«å–å¾—**
   - å…¥åŠ›: GET /api/deck-master?includeUsage=false
   - æœŸå¾…: sortOrderæ˜‡é †ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã€usageCount/lastUsedDateãªã—

2. **includeUsage=trueã§lastUsedDateé™é †ã«å–å¾—**
   - å…¥åŠ›: GET /api/deck-master?includeUsage=true
   - æœŸå¾…: lastUsedDateé™é †ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã€usageCount/lastUsedDateã‚ã‚Š

3. **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œ**
   - å…¥åŠ›: GET /api/deck-master
   - æœŸå¾…: includeUsage=falseã¨åŒç­‰ã®å‹•ä½œ

#### å¢ƒç•Œå€¤ãƒ»ç•°å¸¸ç³»
4. **ãƒ‡ãƒ¼ã‚¿0ä»¶æ™‚ã«ç©ºé…åˆ—**
   - å…¥åŠ›: GET /api/deck-masterï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰
   - æœŸå¾…: { data: [], meta: { count: 0 } }

5. **å¯¾æˆ¦å±¥æ­´0ä»¶æ™‚ã¯sortOrderé †ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**
   - å…¥åŠ›: GET /api/deck-master?includeUsage=trueï¼ˆå¯¾æˆ¦å±¥æ­´ãªã—ï¼‰
   - æœŸå¾…: sortOrderé †ã€usageCount=0ã€lastUsedDate=null

6. **ç„¡åŠ¹ãªincludeUsageå€¤**
   - å…¥åŠ›: GET /api/deck-master?includeUsage=invalid
   - æœŸå¾…: 400 Bad Request ã¾ãŸã¯ falseã¨ã—ã¦å‡¦ç†

---
## å®Ÿè£…æ‰‹é †

### Red Phaseï¼ˆå¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ãï¼‰
1. ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« `deck-master.get.test.ts` ã‚’ä½œæˆ
2. ä¸Šè¨˜ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å®Ÿè£…
3. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â†’ å¤±æ•—ç¢ºèª

### Green Phaseï¼ˆãƒ†ã‚¹ãƒˆã‚’é€šã™æœ€å°å®Ÿè£…ï¼‰
1. ãƒ«ãƒ¼ãƒˆå®šç¾© `deck-master.ts` ã‚’ä½œæˆ
2. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ `deck-master.controller.ts` ã‚’ä½œæˆ
3. ã‚µãƒ¼ãƒ“ã‚¹ `deck-master.service.ts` ã‚’ä½œæˆ
4. ãƒãƒªãƒ‡ãƒ¼ã‚¿ `deck-master.validator.ts` ã‚’ä½œæˆ
5. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â†’ æˆåŠŸç¢ºèª

### Refactor Phaseï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰
1. é‡è¤‡ã‚³ãƒ¼ãƒ‰ã®æŠ½å‡º
2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€
3. å‹å®šç¾©ã®æ•´ç†
4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â†’ æˆåŠŸç¢ºèª

---
## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

| é …ç›® | ãƒ¬ãƒ™ãƒ« | å‡ºå…¸ |
|------|--------|------|
| APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜ | ğŸ”µ | api-endpoints.md 2.1 |
| ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ | ğŸ”µ | api-endpoints.md 2.1 |
| SQLã‚¯ã‚¨ãƒª | ğŸ”µ | design/deck-management-extension |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | ğŸ”µ | api-endpoints.md |
