# TASK-0015: MyDeck API - POST å®Ÿè£…

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

- **ã‚¿ã‚¹ã‚¯ID**: TASK-0015
- **ã‚¿ã‚¤ãƒˆãƒ«**: MyDeck API - POST å®Ÿè£…
- **ã‚¿ã‚¤ãƒ—**: TDD
- **æ¨å®šå·¥æ•°**: 2æ™‚é–“
- **ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ä½¿ç”¨ãƒ‡ãƒƒã‚­ç®¡ç†æ©Ÿèƒ½
- **ä¿¡é ¼æ€§**: ğŸ”µï¼ˆapi-endpoints.md 3.2ã‚ˆã‚Šã€REQ-EXT-101ã€œ107ï¼‰
- **ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0003, TASK-0004
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0017
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: [ ] æœªç€æ‰‹

---

## è¦ä»¶

### æ©Ÿèƒ½è¦ä»¶

- POST /api/my-decks ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…
- deckId, deckName å¿…é ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- deckCode ä»»æ„ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼‰
- isActive = true å›ºå®š
- UUID è‡ªå‹•ç”Ÿæˆ

### é–¢é€£è¦ä»¶ID

- REQ-EXT-101: ãƒã‚¤ãƒ‡ãƒƒã‚­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ‹¡å¼µ
- REQ-EXT-102: isActiveãƒ•ãƒ©ã‚°å¿…é ˆåŒ–
- REQ-EXT-103: deckCodeæ ¼ç´ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
- REQ-EXT-104: classNameæ ¼ç´ï¼ˆDeckMasterã‹ã‚‰å–å¾—ï¼‰
- REQ-EXT-105: DeckMasterå‚ç…§æ•´åˆæ€§
- REQ-EXT-106: UUIDè‡ªå‹•ç”Ÿæˆ
- REQ-EXT-107: createdAtè‡ªå‹•è¨­å®š

---

## å®Ÿè£…è©³ç´°

### 1. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/my-decks`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**:
```typescript
interface CreateMyDeckRequest {
  deckId: string;      // å¿…é ˆ: DeckMasterã®ID
  deckName: string;    // å¿…é ˆ: ãƒ‡ãƒƒã‚­å
  deckCode?: string;   // ä»»æ„: ãƒ‡ãƒƒã‚­ã‚³ãƒ¼ãƒ‰
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
// æˆåŠŸæ™‚: 201 Created
interface CreateMyDeckResponse {
  success: true;
  data: {
    id: string;          // UUIDè‡ªå‹•ç”Ÿæˆ
    deckId: string;
    deckName: string;
    deckCode: string;    // ç©ºæ–‡å­—åˆ—ã®å ´åˆã‚ã‚Š
    className: string;   // DeckMasterã‹ã‚‰å–å¾—
    isActive: true;
    createdAt: string;   // ISO 8601å½¢å¼
  };
  meta: {
    timestamp: string;
  };
}

// ã‚¨ãƒ©ãƒ¼æ™‚: 400 Bad Request / 404 Not Found
interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
  };
  meta: {
    timestamp: string;
  };
}
```

### 2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…

```typescript
// packages/api/src/validators/myDeckValidator.ts

import { z } from 'zod';

export const createMyDeckSchema = z.object({
  deckId: z.string().min(1, 'deckIdã¯å¿…é ˆã§ã™'),
  deckName: z.string().min(1, 'deckNameã¯å¿…é ˆã§ã™'),
  deckCode: z.string().optional().default(''),
});

export type CreateMyDeckInput = z.infer<typeof createMyDeckSchema>;
```

### 3. APIãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…

```typescript
// packages/api/src/functions/myDecks/postMyDeck.ts

import { Hono } from 'hono';
import { zValidator } from '@hono/zod-validator';
import { v4 as uuidv4 } from 'uuid';
import { createMyDeckSchema } from '../../validators/myDeckValidator';

export const postMyDeck = new Hono().post(
  '/',
  zValidator('json', createMyDeckSchema),
  async (c) => {
    const input = c.req.valid('json');

    // DeckMasterå­˜åœ¨ç¢ºèª
    const deckMaster = await getDeckMasterById(input.deckId);
    if (!deckMaster) {
      return c.json({
        success: false,
        error: {
          code: 'DECK_MASTER_NOT_FOUND',
          message: `deckId: ${input.deckId} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`,
        },
        meta: { timestamp: new Date().toISOString() },
      }, 404);
    }

    // MyDeckä½œæˆ
    const newMyDeck = {
      id: uuidv4(),
      deckId: input.deckId,
      deckName: input.deckName,
      deckCode: input.deckCode || '',
      className: deckMaster.className,
      isActive: true,
      createdAt: new Date().toISOString(),
    };

    // ä¿å­˜å‡¦ç†
    await saveMyDeck(newMyDeck);

    return c.json({
      success: true,
      data: newMyDeck,
      meta: { timestamp: new Date().toISOString() },
    }, 201);
  }
);
```

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§

| No | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æœŸå¾…çµæœ | å„ªå…ˆåº¦ |
|----|-------------|----------|--------|
| 1 | æ­£å¸¸ãªå…¥åŠ›ã§ç™»éŒ² | 201 Createdã€UUIDç”Ÿæˆ | é«˜ |
| 2 | deckNameç©ºã§ç™»éŒ² | 400 ValidationError | é«˜ |
| 3 | deckIdç©ºã§ç™»éŒ² | 400 ValidationError | é«˜ |
| 4 | deckCodeç©ºã§ç™»éŒ² | 201 Createdã€deckCodeç©ºæ–‡å­— | é«˜ |
| 5 | å­˜åœ¨ã—ãªã„deckIdã§ç™»éŒ² | 404 DECK_MASTER_NOT_FOUND | é«˜ |
| 6 | isActiveãŒtrueã§è¨­å®šã•ã‚Œã‚‹ | isActive: true | ä¸­ |
| 7 | createdAtãŒè‡ªå‹•è¨­å®šã•ã‚Œã‚‹ | ISO 8601å½¢å¼ | ä¸­ |
| 8 | classNameãŒDeckMasterã‹ã‚‰å–å¾—ã•ã‚Œã‚‹ | æ­£ã—ã„className | ä¸­ |

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹

```typescript
// packages/api/src/functions/myDecks/__tests__/postMyDeck.test.ts

import { describe, it, expect, beforeEach } from 'vitest';

describe('POST /api/my-decks', () => {
  describe('æ­£å¸¸ç³»', () => {
    it('æ­£å¸¸ãªå…¥åŠ›ã§201 CreatedãŒè¿”ã‚‹', async () => {
      const response = await app.request('/api/my-decks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          deckId: 'deck-001',
          deckName: 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒƒã‚­',
          deckCode: 'ABC123',
        }),
      });

      expect(response.status).toBe(201);
      const body = await response.json();
      expect(body.success).toBe(true);
      expect(body.data.id).toMatch(/^[0-9a-f-]{36}$/); // UUIDå½¢å¼
      expect(body.data.isActive).toBe(true);
    });

    it('deckCodeç©ºã§ç™»éŒ²æˆåŠŸ', async () => {
      const response = await app.request('/api/my-decks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          deckId: 'deck-001',
          deckName: 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒƒã‚­',
        }),
      });

      expect(response.status).toBe(201);
      const body = await response.json();
      expect(body.data.deckCode).toBe('');
    });
  });

  describe('ç•°å¸¸ç³»', () => {
    it('deckNameç©ºã§ValidationError', async () => {
      const response = await app.request('/api/my-decks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          deckId: 'deck-001',
          deckName: '',
        }),
      });

      expect(response.status).toBe(400);
      const body = await response.json();
      expect(body.success).toBe(false);
      expect(body.error.code).toBe('VALIDATION_ERROR');
    });

    it('å­˜åœ¨ã—ãªã„deckIdã§ã‚¨ãƒ©ãƒ¼', async () => {
      const response = await app.request('/api/my-decks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          deckId: 'non-existent-id',
          deckName: 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒƒã‚­',
        }),
      });

      expect(response.status).toBe(404);
      const body = await response.json();
      expect(body.error.code).toBe('DECK_MASTER_NOT_FOUND');
    });
  });
});
```

---

## å®Œäº†æ¡ä»¶

- [ ] POST /api/my-decks ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] deckId, deckNameå¿…é ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] deckCodeä»»æ„ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼‰ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] isActive = true å›ºå®šãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] UUIDè‡ªå‹•ç”ŸæˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒæˆåŠŸã™ã‚‹
- [ ] ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# TDDãƒ•ãƒ­ãƒ¼
/tsumiki:tdd-red           # ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
/tsumiki:tdd-green         # æœ€å°å®Ÿè£…ï¼ˆæˆåŠŸï¼‰
/tsumiki:tdd-refactor      # ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
/tsumiki:tdd-verify-complete  # å“è³ªç¢ºèª
```

---

## æ¤œè¨¼æ‰‹é †

1. ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆRedï¼‰
2. æœ€å°é™ã®å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆGreenï¼‰
3. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã‚‚ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
4. `pnpm test` ã§å…¨ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
5. `pnpm lint` ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª
6. `pnpm type-check` ã§å‹ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª

---

## å‚è€ƒè³‡æ–™

- [api-endpoints.md - 3.2 POST /api/my-decks](../../../docs/design/deck-management-extension/api-endpoints.md)
- [architecture.md - 5.1 DeckStore](../../../docs/design/deck-management-extension/architecture.md)
- [Hono Documentation](https://hono.dev/)
- [Zod Documentation](https://zod.dev/)
