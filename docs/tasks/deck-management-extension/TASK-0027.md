# TASK-0027: StatisticsStoreæ‹¡å¼µï¼ˆã‚·ãƒ¼ã‚ºãƒ³é¸æŠçŠ¶æ…‹ï¼‰

## ã‚¿ã‚¹ã‚¯æƒ…å ±

- **ã‚¿ã‚¹ã‚¯ID**: TASK-0027
- **ã‚¿ã‚¤ãƒ—**: TDD
- **æ¨å®šå·¥æ•°**: 2æ™‚é–“
- **ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±è¨ˆç”»é¢æ©Ÿèƒ½æ‹¡å¼µ
- **ä¿¡é ¼æ€§**: ğŸ”µï¼ˆarchitecture.md 5.2ã‚ˆã‚Šï¼‰
- **ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0025, TASK-0026
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0028
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: [ ] æœªå®Œäº†

---

## æ¦‚è¦

StatisticsStoreã«ã‚·ãƒ¼ã‚ºãƒ³é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã€‚ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ã®å–å¾—ã€ã‚·ãƒ¼ã‚ºãƒ³é¸æŠçŠ¶æ…‹ã®ç®¡ç†ã€ã‚·ãƒ¼ã‚ºãƒ³åˆ¥çµ±è¨ˆã®å†å–å¾—æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚

---

## å®Ÿè£…å†…å®¹

### 1. StatisticsStoreæ‹¡å¼µ

`packages/frontend/src/store/statisticsStore.ts`:

```typescript
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';
import { statisticsApi } from '@/api/statisticsApi';
import type { SeasonStatistics } from '@shadowverse-log/shared';

interface StatisticsState {
  // æ—¢å­˜ã®çŠ¶æ…‹
  statistics: SeasonStatistics | null;
  isLoading: boolean;
  error: string | null;

  // æ–°è¦è¿½åŠ : ã‚·ãƒ¼ã‚ºãƒ³é–¢é€£çŠ¶æ…‹
  selectedSeason: number | null;
  availableSeasons: number[];
  isSeasonsLoading: boolean;

  // æ—¢å­˜ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  fetchStatistics: () => Promise<void>;

  // æ–°è¦è¿½åŠ : ã‚·ãƒ¼ã‚ºãƒ³é–¢é€£ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  fetchSeasons: () => Promise<void>;
  setSelectedSeason: (season: number) => void;
  fetchStatisticsBySeason: (season: number) => Promise<void>;
}

export const useStatisticsStore = create<StatisticsState>()(
  devtools(
    (set, get) => ({
      // åˆæœŸçŠ¶æ…‹
      statistics: null,
      isLoading: false,
      error: null,
      selectedSeason: null,
      availableSeasons: [],
      isSeasonsLoading: false,

      /**
       * ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ã‚’å–å¾—
       */
      fetchSeasons: async () => {
        set({ isSeasonsLoading: true, error: null });
        try {
          const response = await statisticsApi.getSeasons();
          if (response.success && response.data) {
            const seasons = response.data.seasons;
            set({
              availableSeasons: seasons,
              isSeasonsLoading: false,
              // æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ã‚’è‡ªå‹•é¸æŠ
              selectedSeason: seasons.length > 0 ? seasons[0] : null,
            });

            // æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ã®çµ±è¨ˆã‚’è‡ªå‹•å–å¾—
            if (seasons.length > 0) {
              get().fetchStatisticsBySeason(seasons[0]);
            }
          } else {
            set({
              error: response.error?.message ?? 'ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
              isSeasonsLoading: false,
            });
          }
        } catch (error) {
          set({
            error: 'ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
            isSeasonsLoading: false,
          });
        }
      },

      /**
       * é¸æŠã‚·ãƒ¼ã‚ºãƒ³ã‚’å¤‰æ›´
       */
      setSelectedSeason: (season: number) => {
        set({ selectedSeason: season });
        // ã‚·ãƒ¼ã‚ºãƒ³å¤‰æ›´æ™‚ã«çµ±è¨ˆã‚’å†å–å¾—
        get().fetchStatisticsBySeason(season);
      },

      /**
       * ã‚·ãƒ¼ã‚ºãƒ³åˆ¥çµ±è¨ˆã‚’å–å¾—
       */
      fetchStatisticsBySeason: async (season: number) => {
        set({ isLoading: true, error: null });
        try {
          const response = await statisticsApi.getStatistics(season);
          if (response.success && response.data) {
            set({
              statistics: response.data,
              isLoading: false,
            });
          } else {
            set({
              error: response.error?.message ?? 'çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
              isLoading: false,
            });
          }
        } catch (error) {
          set({
            error: 'çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
            isLoading: false,
          });
        }
      },

      /**
       * çµ±è¨ˆã‚’å–å¾—ï¼ˆæ—¢å­˜ãƒ¡ã‚½ãƒƒãƒ‰ - å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ç¶­æŒï¼‰
       */
      fetchStatistics: async () => {
        const { selectedSeason } = get();
        if (selectedSeason !== null) {
          await get().fetchStatisticsBySeason(selectedSeason);
        } else {
          // ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ã‚’å–å¾—ï¼ˆè‡ªå‹•ã§æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ã®çµ±è¨ˆã‚‚å–å¾—ã•ã‚Œã‚‹ï¼‰
          await get().fetchSeasons();
        }
      },
    }),
    { name: 'statistics-store' }
  )
);
```

### 2. APIé–¢æ•°è¿½åŠ 

`packages/frontend/src/api/statisticsApi.ts`:

```typescript
import { apiClient } from './apiClient';
import type { ApiResponse, SeasonsResponse, SeasonStatistics } from '@shadowverse-log/shared';

export const statisticsApi = {
  /**
   * ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ã‚’å–å¾—
   */
  getSeasons: async (): Promise<ApiResponse<SeasonsResponse>> => {
    const response = await apiClient.get<ApiResponse<SeasonsResponse>>(
      '/api/statistics/seasons'
    );
    return response.data;
  },

  /**
   * çµ±è¨ˆã‚’å–å¾—ï¼ˆã‚·ãƒ¼ã‚ºãƒ³æŒ‡å®šï¼‰
   */
  getStatistics: async (season?: number): Promise<ApiResponse<SeasonStatistics>> => {
    const params = season !== undefined ? `?season=${season}` : '';
    const response = await apiClient.get<ApiResponse<SeasonStatistics>>(
      `/api/statistics${params}`
    );
    return response.data;
  },
};
```

### 3. ã‚»ãƒ¬ã‚¯ã‚¿è¿½åŠ ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰

`packages/frontend/src/store/statisticsStore.ts` ã«ã‚»ãƒ¬ã‚¯ã‚¿ã‚’è¿½åŠ :

```typescript
// ã‚»ãƒ¬ã‚¯ã‚¿ï¼ˆãƒ¡ãƒ¢åŒ–ã®ãŸã‚ã«åˆ†é›¢ï¼‰
export const selectStatistics = (state: StatisticsState) => state.statistics;
export const selectSelectedSeason = (state: StatisticsState) => state.selectedSeason;
export const selectAvailableSeasons = (state: StatisticsState) => state.availableSeasons;
export const selectIsLoading = (state: StatisticsState) => state.isLoading;
export const selectIsSeasonsLoading = (state: StatisticsState) => state.isSeasonsLoading;
export const selectError = (state: StatisticsState) => state.error;
```

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆVitestï¼‰

`packages/frontend/src/store/__tests__/statisticsStore.test.ts`:

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { useStatisticsStore } from '../statisticsStore';
import { statisticsApi } from '@/api/statisticsApi';

vi.mock('@/api/statisticsApi', () => ({
  statisticsApi: {
    getSeasons: vi.fn(),
    getStatistics: vi.fn(),
  },
}));

describe('StatisticsStore', () => {
  beforeEach(() => {
    // ã‚¹ãƒˆã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
    useStatisticsStore.setState({
      statistics: null,
      isLoading: false,
      error: null,
      selectedSeason: null,
      availableSeasons: [],
      isSeasonsLoading: false,
    });
    vi.clearAllMocks();
  });

  describe('fetchSeasons', () => {
    it('ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ãŒå–å¾—ãƒ»ä¿å­˜ã•ã‚Œã‚‹', async () => {
      vi.mocked(statisticsApi.getSeasons).mockResolvedValue({
        success: true,
        data: { seasons: [5, 4, 3, 2, 1] },
        meta: { timestamp: '', requestId: '' },
      });
      vi.mocked(statisticsApi.getStatistics).mockResolvedValue({
        success: true,
        data: { season: 5, overall: { totalGames: 10, wins: 5, losses: 5, winRate: 50 } } as any,
        meta: { timestamp: '', requestId: '' },
      });

      await useStatisticsStore.getState().fetchSeasons();

      const state = useStatisticsStore.getState();
      expect(state.availableSeasons).toEqual([5, 4, 3, 2, 1]);
      expect(state.isSeasonsLoading).toBe(false);
    });

    it('æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ãŒè‡ªå‹•é¸æŠã•ã‚Œã‚‹', async () => {
      vi.mocked(statisticsApi.getSeasons).mockResolvedValue({
        success: true,
        data: { seasons: [5, 4, 3] },
        meta: { timestamp: '', requestId: '' },
      });
      vi.mocked(statisticsApi.getStatistics).mockResolvedValue({
        success: true,
        data: { season: 5 } as any,
        meta: { timestamp: '', requestId: '' },
      });

      await useStatisticsStore.getState().fetchSeasons();

      expect(useStatisticsStore.getState().selectedSeason).toBe(5);
    });

    it('å–å¾—å¤±æ•—æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒè¨­å®šã•ã‚Œã‚‹', async () => {
      vi.mocked(statisticsApi.getSeasons).mockResolvedValue({
        success: false,
        error: { code: 'ERROR', message: 'å–å¾—å¤±æ•—' },
        meta: { timestamp: '', requestId: '' },
      });

      await useStatisticsStore.getState().fetchSeasons();

      expect(useStatisticsStore.getState().error).toBe('å–å¾—å¤±æ•—');
    });
  });

  describe('setSelectedSeason', () => {
    it('ã‚·ãƒ¼ã‚ºãƒ³é¸æŠã§selectedSeasonãŒæ›´æ–°ã•ã‚Œã‚‹', async () => {
      vi.mocked(statisticsApi.getStatistics).mockResolvedValue({
        success: true,
        data: { season: 3 } as any,
        meta: { timestamp: '', requestId: '' },
      });

      useStatisticsStore.getState().setSelectedSeason(3);

      expect(useStatisticsStore.getState().selectedSeason).toBe(3);
    });

    it('ã‚·ãƒ¼ã‚ºãƒ³é¸æŠã§çµ±è¨ˆãŒå†å–å¾—ã•ã‚Œã‚‹', async () => {
      vi.mocked(statisticsApi.getStatistics).mockResolvedValue({
        success: true,
        data: { season: 3, overall: { totalGames: 5 } } as any,
        meta: { timestamp: '', requestId: '' },
      });

      useStatisticsStore.getState().setSelectedSeason(3);

      // éåŒæœŸå‡¦ç†ã®å®Œäº†ã‚’å¾…ã¤
      await vi.waitFor(() => {
        expect(statisticsApi.getStatistics).toHaveBeenCalledWith(3);
      });
    });
  });

  describe('fetchStatisticsBySeason', () => {
    it('æŒ‡å®šã‚·ãƒ¼ã‚ºãƒ³ã®çµ±è¨ˆãŒå–å¾—ã•ã‚Œã‚‹', async () => {
      const mockStats = {
        season: 4,
        overall: { totalGames: 20, wins: 12, losses: 8, winRate: 60 },
        byMyDeck: [],
        byOpponentDeck: [],
        byTurn: { å…ˆæ”»: {}, å¾Œæ”»: {} },
      };

      vi.mocked(statisticsApi.getStatistics).mockResolvedValue({
        success: true,
        data: mockStats as any,
        meta: { timestamp: '', requestId: '' },
      });

      await useStatisticsStore.getState().fetchStatisticsBySeason(4);

      expect(useStatisticsStore.getState().statistics?.season).toBe(4);
      expect(useStatisticsStore.getState().isLoading).toBe(false);
    });
  });
});
```

---

## å®Œäº†æ¡ä»¶

- [ ] selectedSeasonçŠ¶æ…‹ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- [ ] availableSeasonsçŠ¶æ…‹ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- [ ] fetchSeasonsé–¢æ•°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] setSelectedSeasoné–¢æ•°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] fetchStatisticsBySeasoné–¢æ•°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§å–å¾—æ™‚ã«æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ãŒè‡ªå‹•é¸æŠã•ã‚Œã‚‹
- [ ] ã‚·ãƒ¼ã‚ºãƒ³å¤‰æ›´æ™‚ã«çµ±è¨ˆãŒè‡ªå‹•ã§å†å–å¾—ã•ã‚Œã‚‹
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦æˆåŠŸã™ã‚‹

---

## å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# TDDãƒ•ãƒ­ãƒ¼
/tsumiki:tdd-red           # ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
/tsumiki:tdd-green         # æœ€å°å®Ÿè£…ï¼ˆæˆåŠŸï¼‰
/tsumiki:tdd-refactor      # ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
/tsumiki:tdd-verify-complete  # å“è³ªç¢ºèª
```

---

## æ¤œè¨¼æ‰‹é †

1. `packages/frontend/src/store/statisticsStore.ts` ãŒæ‹¡å¼µã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
2. `packages/frontend/src/api/statisticsApi.ts` ã«APIé–¢æ•°ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. `pnpm test` ã§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã‹ç¢ºèª
4. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚·ãƒ¼ã‚ºãƒ³é¸æŠãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ç¢ºèª

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [æŠ€è¡“è¨­è¨ˆæ›¸ architecture.md 5.2](../../design/deck-management-extension/architecture.md)
- [TASK-0025: ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§å–å¾—å®Ÿè£…](./TASK-0025.md)
- [TASK-0026: ã‚·ãƒ¼ã‚ºãƒ³åˆ¥çµ±è¨ˆå–å¾—å®Ÿè£…](./TASK-0026.md)
