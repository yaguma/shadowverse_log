# TASK-0029: çµ±è¨ˆç”»é¢å¯¾æˆ¦å±¥æ­´ç™»éŒ²ãƒœã‚¿ãƒ³è¿½åŠ 

## ã‚¿ã‚¹ã‚¯æƒ…å ±

- **ã‚¿ã‚¹ã‚¯ID**: TASK-0029
- **ã‚¿ã‚¤ãƒ—**: TDD
- **æ¨å®šå·¥æ•°**: 2æ™‚é–“
- **ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±è¨ˆç”»é¢æ©Ÿèƒ½æ‹¡å¼µ
- **ä¿¡é ¼æ€§**: ğŸ”µï¼ˆREQ-EXT-201, REQ-EXT-202ã‚ˆã‚Šï¼‰
- **ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0028
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0030
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: [ ] æœªå®Œäº†

---

## æ¦‚è¦

çµ±è¨ˆç”»é¢ã«ã€Œå¯¾æˆ¦ã‚’è¨˜éŒ²ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã€çµ±è¨ˆç”»é¢ã‹ã‚‰ç›´æ¥å¯¾æˆ¦å±¥æ­´ã‚’ç™»éŒ²ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ç™»éŒ²æˆåŠŸå¾Œã¯çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«å†å–å¾—ã™ã‚‹ã€‚

---

## å®Ÿè£…å†…å®¹

### 1. çµ±è¨ˆç”»é¢ã¸ã®ç™»éŒ²ãƒœã‚¿ãƒ³è¿½åŠ 

`packages/frontend/src/pages/StatisticsPage.tsx` ã‚’æ›´æ–°:

```typescript
import { useEffect, useState } from 'react';
import { useStatisticsStore } from '@/store/statisticsStore';
import { SeasonSelector } from '@/components/statistics/SeasonSelector';
import { StatisticsOverview } from '@/components/statistics/StatisticsOverview';
import { DeckStatisticsTable } from '@/components/statistics/DeckStatisticsTable';
import { TurnStatisticsChart } from '@/components/statistics/TurnStatisticsChart';
import { BattleLogDialog } from '@/components/battle-log/BattleLogDialog';
import { PlusIcon } from '@heroicons/react/24/outline';

export const StatisticsPage = () => {
  const {
    statistics,
    isLoading,
    error,
    fetchSeasons,
    selectedSeason,
    fetchStatisticsBySeason
  } = useStatisticsStore();

  const [isDialogOpen, setIsDialogOpen] = useState(false);

  useEffect(() => {
    fetchSeasons();
  }, [fetchSeasons]);

  /**
   * å¯¾æˆ¦å±¥æ­´ç™»éŒ²æˆåŠŸæ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
   */
  const handleBattleLogSaved = () => {
    setIsDialogOpen(false);
    // çµ±è¨ˆã‚’å†å–å¾—
    if (selectedSeason !== null) {
      fetchStatisticsBySeason(selectedSeason);
    }
  };

  if (error) {
    return (
      <div className="container mx-auto px-4 py-6">
        <div className="bg-red-50 border border-red-200 rounded-md p-4">
          <p className="text-red-700">{error}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-6">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† */}
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold">çµ±è¨ˆ</h1>
        <div className="flex items-center gap-4">
          <SeasonSelector />
          <button
            onClick={() => setIsDialogOpen(true)}
            className="
              inline-flex items-center gap-2 px-4 py-2
              bg-blue-600 text-white text-sm font-medium rounded-md
              hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
              transition-colors
            "
          >
            <PlusIcon className="h-5 w-5" />
            å¯¾æˆ¦ã‚’è¨˜éŒ²
          </button>
        </div>
      </div>

      {/* çµ±è¨ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      {isLoading ? (
        <div className="flex items-center justify-center py-12">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <span className="ml-2 text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
      ) : statistics ? (
        <div className="space-y-8">
          <section>
            <h2 className="text-lg font-semibold mb-4">
              ã‚·ãƒ¼ã‚ºãƒ³ {selectedSeason} å…¨ä½“æˆç¸¾
            </h2>
            <StatisticsOverview statistics={statistics.overall} />
          </section>

          <section>
            <h2 className="text-lg font-semibold mb-4">ä½¿ç”¨ãƒ‡ãƒƒã‚­åˆ¥æˆç¸¾</h2>
            <DeckStatisticsTable data={statistics.byMyDeck} />
          </section>

          <section>
            <h2 className="text-lg font-semibold mb-4">ç›¸æ‰‹ãƒ‡ãƒƒã‚­åˆ¥æˆç¸¾</h2>
            <DeckStatisticsTable data={statistics.byOpponentDeck} />
          </section>

          <section>
            <h2 className="text-lg font-semibold mb-4">ã‚¿ãƒ¼ãƒ³åˆ¥æˆç¸¾</h2>
            <TurnStatisticsChart data={statistics.byTurn} />
          </section>
        </div>
      ) : (
        <div className="text-center py-12">
          <p className="text-gray-500 mb-4">çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <button
            onClick={() => setIsDialogOpen(true)}
            className="
              inline-flex items-center gap-2 px-4 py-2
              bg-blue-600 text-white text-sm font-medium rounded-md
              hover:bg-blue-700 transition-colors
            "
          >
            <PlusIcon className="h-5 w-5" />
            æœ€åˆã®å¯¾æˆ¦ã‚’è¨˜éŒ²ã™ã‚‹
          </button>
        </div>
      )}

      {/* å¯¾æˆ¦å±¥æ­´ç™»éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */}
      <BattleLogDialog
        isOpen={isDialogOpen}
        onClose={() => setIsDialogOpen(false)}
        onSaved={handleBattleLogSaved}
        defaultSeason={selectedSeason ?? undefined}
      />
    </div>
  );
};
```

### 2. BattleLogDialogã®æ‹¡å¼µï¼ˆdefaultSeasonãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¿½åŠ ï¼‰

`packages/frontend/src/components/battle-log/BattleLogDialog.tsx` ã«defaultSeasonãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ :

```typescript
interface BattleLogDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onSaved?: () => void;
  defaultSeason?: number; // çµ±è¨ˆç”»é¢ã‹ã‚‰å‘¼ã³å‡ºã—æ™‚ã«ç¾åœ¨é¸æŠä¸­ã®ã‚·ãƒ¼ã‚ºãƒ³ã‚’æ¸¡ã™
}

export const BattleLogDialog = ({
  isOpen,
  onClose,
  onSaved,
  defaultSeason
}: BattleLogDialogProps) => {
  // ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ã«defaultSeasonã‚’ä½¿ç”¨
  const [formData, setFormData] = useState({
    season: defaultSeason ?? getCurrentSeason(),
    // ... ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  });

  // defaultSeasonãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ›´æ–°
  useEffect(() => {
    if (defaultSeason !== undefined) {
      setFormData(prev => ({ ...prev, season: defaultSeason }));
    }
  }, [defaultSeason]);

  // ... æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯
};
```

### 3. çµ±è¨ˆæ›´æ–°ã®æœ€é©åŒ–

ç™»éŒ²æˆåŠŸå¾Œã®å†å–å¾—ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã€ã‚¹ãƒˆã‚¢ã«å°‚ç”¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ :

```typescript
// statisticsStore.ts ã«è¿½åŠ 
refreshCurrentStatistics: async () => {
  const { selectedSeason, fetchStatisticsBySeason } = get();
  if (selectedSeason !== null) {
    await fetchStatisticsBySeason(selectedSeason);
  }
},
```

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆVitestï¼‰

`packages/frontend/src/pages/__tests__/StatisticsPage.test.tsx`:

```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { StatisticsPage } from '../StatisticsPage';
import { useStatisticsStore } from '@/store/statisticsStore';

vi.mock('@/store/statisticsStore');
vi.mock('@/components/battle-log/BattleLogDialog', () => ({
  BattleLogDialog: ({ isOpen, onClose, onSaved }: any) =>
    isOpen ? (
      <div data-testid="battle-log-dialog">
        <button onClick={onClose}>é–‰ã˜ã‚‹</button>
        <button onClick={onSaved}>ä¿å­˜</button>
      </div>
    ) : null,
}));

describe('StatisticsPage - å¯¾æˆ¦å±¥æ­´ç™»éŒ²', () => {
  const mockFetchSeasons = vi.fn();
  const mockFetchStatisticsBySeason = vi.fn();

  beforeEach(() => {
    vi.clearAllMocks();
    vi.mocked(useStatisticsStore).mockReturnValue({
      statistics: {
        season: 5,
        overall: { totalGames: 10, wins: 6, losses: 4, winRate: 60 },
        byMyDeck: [],
        byOpponentDeck: [],
        byTurn: { å…ˆæ”»: {}, å¾Œæ”»: {} },
      },
      isLoading: false,
      error: null,
      fetchSeasons: mockFetchSeasons,
      selectedSeason: 5,
      fetchStatisticsBySeason: mockFetchStatisticsBySeason,
    } as any);
  });

  describe('å¯¾æˆ¦ã‚’è¨˜éŒ²ãƒœã‚¿ãƒ³', () => {
    it('å¯¾æˆ¦ã‚’è¨˜éŒ²ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      render(<StatisticsPage />);
      expect(screen.getByRole('button', { name: /å¯¾æˆ¦ã‚’è¨˜éŒ²/ })).toBeInTheDocument();
    });

    it('ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§BattleLogDialogãŒé–‹ã', () => {
      render(<StatisticsPage />);

      const button = screen.getByRole('button', { name: /å¯¾æˆ¦ã‚’è¨˜éŒ²/ });
      fireEvent.click(button);

      expect(screen.getByTestId('battle-log-dialog')).toBeInTheDocument();
    });
  });

  describe('ç™»éŒ²æˆåŠŸå¾Œã®çµ±è¨ˆæ›´æ–°', () => {
    it('ç™»éŒ²æˆåŠŸå¾Œã«çµ±è¨ˆãŒå†å–å¾—ã•ã‚Œã‚‹', async () => {
      render(<StatisticsPage />);

      // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
      fireEvent.click(screen.getByRole('button', { name: /å¯¾æˆ¦ã‚’è¨˜éŒ²/ }));

      // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒ¢ãƒƒã‚¯ãªã®ã§onSavedãŒå³å‘¼ã°ã‚Œã‚‹ï¼‰
      fireEvent.click(screen.getByText('ä¿å­˜'));

      await waitFor(() => {
        expect(mockFetchStatisticsBySeason).toHaveBeenCalledWith(5);
      });
    });

    it('ç™»éŒ²æˆåŠŸå¾Œã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ã‚‹', async () => {
      render(<StatisticsPage />);

      // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
      fireEvent.click(screen.getByRole('button', { name: /å¯¾æˆ¦ã‚’è¨˜éŒ²/ }));
      expect(screen.getByTestId('battle-log-dialog')).toBeInTheDocument();

      // ä¿å­˜
      fireEvent.click(screen.getByText('ä¿å­˜'));

      await waitFor(() => {
        expect(screen.queryByTestId('battle-log-dialog')).not.toBeInTheDocument();
      });
    });
  });

  describe('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆ', () => {
    it('æœ€åˆã®å¯¾æˆ¦ã‚’è¨˜éŒ²ã™ã‚‹ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      vi.mocked(useStatisticsStore).mockReturnValue({
        statistics: null,
        isLoading: false,
        error: null,
        fetchSeasons: mockFetchSeasons,
        selectedSeason: null,
        fetchStatisticsBySeason: mockFetchStatisticsBySeason,
      } as any);

      render(<StatisticsPage />);

      expect(screen.getByRole('button', { name: /æœ€åˆã®å¯¾æˆ¦ã‚’è¨˜éŒ²ã™ã‚‹/ })).toBeInTheDocument();
    });
  });
});
```

---

## å®Œäº†æ¡ä»¶

- [ ] çµ±è¨ˆç”»é¢ã«ã€Œå¯¾æˆ¦ã‚’è¨˜éŒ²ã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§BattleLogDialogãŒé–‹ã
- [ ] ç™»éŒ²æˆåŠŸå¾Œã«çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒå†å–å¾—ã•ã‚Œã‚‹
- [ ] ç™»éŒ²æˆåŠŸå¾Œã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ã‚‹
- [ ] çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆã«ã€Œæœ€åˆã®å¯¾æˆ¦ã‚’è¨˜éŒ²ã™ã‚‹ã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ç¾åœ¨é¸æŠä¸­ã®ã‚·ãƒ¼ã‚ºãƒ³ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦è¨­å®šã•ã‚Œã‚‹
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦æˆåŠŸã™ã‚‹

---

## å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# TDDãƒ•ãƒ­ãƒ¼
/tsumiki:tdd-red           # ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
/tsumiki:tdd-green         # æœ€å°å®Ÿè£…ï¼ˆæˆåŠŸï¼‰
/tsumiki:tdd-refactor      # ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
/tsumiki:tdd-verify-complete  # å“è³ªç¢ºèª
```

---

## æ¤œè¨¼æ‰‹é †

1. `packages/frontend/src/pages/StatisticsPage.tsx` ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
2. `pnpm test` ã§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã‹ç¢ºèª
3. æ‰‹å‹•ç¢ºèª:
   - çµ±è¨ˆç”»é¢ã§ã€Œå¯¾æˆ¦ã‚’è¨˜éŒ²ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§å¯¾æˆ¦å±¥æ­´ã‚’ç™»éŒ²
   - ç™»éŒ²å¾Œã«çµ±è¨ˆãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [è¦ä»¶å®šç¾© REQ-EXT-201, REQ-EXT-202](../../spec/deck-management-extension-requirements.md)
- [TASK-0028: çµ±è¨ˆç”»é¢ã‚·ãƒ¼ã‚ºãƒ³é¸æŠUIå®Ÿè£…](./TASK-0028.md)
