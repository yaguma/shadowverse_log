# TASK-0013: デッキ種別管理機能統合テスト

**タスクID**: TASK-0013
**タスクタイプ**: TDD
**推定工数**: 2時間
**フェーズ**: Phase 2 - デッキ種別管理機能
**信頼性レベル**: 🔵 *dataflow.md 1.1〜1.3より*

## 関連文書
- [技術設計書](../../design/deck-management-extension/README.md)
- [データフロー図](../../design/deck-management-extension/dataflow.md)
- [アーキテクチャ設計](../../design/deck-management-extension/architecture.md)

## タスク概要
デッキ種別管理機能の統合テストを実装する。追加・編集・削除の各フローが正常に動作すること、APIとStoreの連携が正しいことを検証する。

## 依存タスク
- **前提タスク**: [TASK-0012](TASK-0012.md) - DeckMasterDialogコンポーネント
- **後続タスク**: [TASK-0014](TASK-0014.md) - E2Eテスト

## 完了条件
- [ ] 追加→一覧表示の統合テストがパスすること
- [ ] 編集→一覧更新の統合テストがパスすること
- [ ] 削除→一覧更新の統合テストがパスすること
- [ ] 削除制約エラーの統合テストがパスすること
- [ ] APIとStoreの連携が正しいこと
- [ ] UIの状態遷移が正しいこと

---
## 実装詳細

### ファイル構成
```
packages/web/src/
├── __tests__/
│   └── integration/
│       └── deck-master-management.test.tsx  # 統合テスト（新規）
```

### テスト環境設定
```typescript
// モックサーバー設定（MSW使用）
import { setupServer } from 'msw/node';
import { rest } from 'msw';

const server = setupServer(
  rest.get('/api/deck-master', (req, res, ctx) => {
    // モックレスポンス
  }),
  rest.post('/api/deck-master', (req, res, ctx) => {
    // モックレスポンス
  }),
  // ...
);
```

### テスト対象フロー

#### 1. 追加フロー（dataflow.md 1.1）
```
ユーザー操作 → ダイアログ表示 → 入力 → 送信
    → API呼び出し → Store更新 → 一覧再表示
```

#### 2. 編集フロー（dataflow.md 1.2）
```
ユーザー操作 → ダイアログ表示（初期値あり） → 編集 → 送信
    → API呼び出し → Store更新 → 一覧再表示
```

#### 3. 削除フロー（dataflow.md 1.3）
```
ユーザー操作 → 確認ダイアログ → 確認
    → API呼び出し → Store更新 → 一覧再表示
```

#### 4. 削除制約エラーフロー
```
ユーザー操作 → 確認ダイアログ → 確認
    → API呼び出し → 409エラー → エラー表示
```

---
## 単体テスト要件

### テストファイル
`packages/web/src/__tests__/integration/deck-master-management.test.tsx`

### テストケース

#### 追加フロー
1. **追加ボタンクリック→ダイアログ表示→入力→登録→一覧に追加**
   - 操作: 追加ボタンクリック → className選択 → deckName入力 → 登録クリック
   - 期待: ダイアログが閉じる、一覧に新規データが表示される

2. **追加後のsortOrderが正しい**
   - 期待: 新規データのsortOrderが最大値+1

3. **追加中のローディング状態**
   - 期待: 送信中にローディング表示、完了後に非表示

#### 編集フロー
4. **編集ボタンクリック→ダイアログ表示（初期値）→編集→更新→一覧更新**
   - 操作: 編集ボタンクリック → deckName変更 → 更新クリック
   - 期待: ダイアログが閉じる、一覧のデータが更新される

5. **編集時classNameがdisabledで変更不可**
   - 期待: classNameフィールドがdisabled

6. **編集後updated_atが更新される**
   - 期待: 更新後のupdated_atが更新前より後

#### 削除フロー
7. **削除ボタンクリック→確認ダイアログ→削除→一覧から削除**
   - 操作: 削除ボタンクリック → 確認ダイアログで削除クリック
   - 期待: 一覧からデータが削除される

8. **削除確認でキャンセル→削除されない**
   - 操作: 削除ボタンクリック → 確認ダイアログでキャンセルクリック
   - 期待: データが削除されない

#### 削除制約エラー
9. **参照ありデータ削除→409エラー→エラー表示**
   - 操作: 参照ありデータの削除ボタンクリック → 確認 → 削除クリック
   - 期待: エラーメッセージ「対戦履歴で使用されているため削除できません」表示

10. **削除ボタンが参照ありでdisabled**
    - 期待: usageCount > 0 のデータの削除ボタンがdisabled

#### エラーハンドリング
11. **ネットワークエラー時にエラー表示**
    - 期待: エラーメッセージが表示される

12. **エラー後に再試行可能**
    - 期待: エラー後も操作可能、再試行で成功

---
## 実装手順

### Red Phase（失敗するテストを書く）
1. 統合テストファイル作成
2. MSWモックサーバー設定
3. 各フローのテストケース実装
4. テスト実行 → 失敗確認

### Green Phase（テストを通す最小実装）
1. 各コンポーネントの統合確認
2. Store連携の確認
3. API呼び出しフローの確認
4. テスト実行 → 成功確認

### Refactor Phase（リファクタリング）
1. テストヘルパー関数の共通化
2. モックデータファクトリーの作成
3. テストの可読性向上
4. テスト実行 → 成功確認

---
## 信頼性レベルサマリー

| 項目 | レベル | 出典 |
|------|--------|------|
| 追加フロー | 🔵 | dataflow.md 1.1 |
| 編集フロー | 🔵 | dataflow.md 1.2 |
| 削除フロー | 🔵 | dataflow.md 1.3 |
| 削除制約 | 🔵 | REQ-EXT-008, REQ-EXT-401 |
