# TASK-0030: çµ±è¨ˆç”»é¢E2Eãƒ†ã‚¹ãƒˆ

## ã‚¿ã‚¹ã‚¯æƒ…å ±

- **ã‚¿ã‚¹ã‚¯ID**: TASK-0030
- **ã‚¿ã‚¤ãƒ—**: TDD
- **æ¨å®šå·¥æ•°**: 2æ™‚é–“
- **ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±è¨ˆç”»é¢æ©Ÿèƒ½æ‹¡å¼µ
- **ä¿¡é ¼æ€§**: ğŸ”µ
- **ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0029
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0031
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: [ ] æœªå®Œäº†

---

## æ¦‚è¦

çµ±è¨ˆç”»é¢ã®æ©Ÿèƒ½æ‹¡å¼µã«å¯¾ã™ã‚‹E2Eãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚ã‚·ãƒ¼ã‚ºãƒ³é¸æŠæ©Ÿèƒ½ã¨çµ±è¨ˆç”»é¢ã‹ã‚‰ã®å¯¾æˆ¦å±¥æ­´ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã€ç™»éŒ²å¾Œã®çµ±è¨ˆæ›´æ–°ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã€‚

---

## å®Ÿè£…å†…å®¹

### 1. E2Eãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

`packages/frontend/e2e/statistics.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('çµ±è¨ˆç”»é¢', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/statistics');
  });

  test.describe('ã‚·ãƒ¼ã‚ºãƒ³é¸æŠ', () => {
    test('ã‚·ãƒ¼ã‚ºãƒ³é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
      await expect(page.locator('#season-select')).toBeVisible();
    });

    test('åˆæœŸè¡¨ç¤ºã§æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹', async ({ page }) => {
      // ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
      await page.waitForSelector('#season-select option');

      const select = page.locator('#season-select');
      const selectedValue = await select.inputValue();

      // æœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ï¼‰ã®å€¤ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      const firstOption = page.locator('#season-select option').first();
      const firstOptionValue = await firstOption.getAttribute('value');

      expect(selectedValue).toBe(firstOptionValue);
    });

    test('ã‚·ãƒ¼ã‚ºãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨çµ±è¨ˆãŒæ›´æ–°ã•ã‚Œã‚‹', async ({ page }) => {
      // ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
      await page.waitForSelector('#season-select option');

      // ç¾åœ¨ã®çµ±è¨ˆã‚’è¨˜éŒ²
      const initialGames = await page.locator('[data-testid="total-games"]').textContent();

      // åˆ¥ã®ã‚·ãƒ¼ã‚ºãƒ³ã‚’é¸æŠ
      const select = page.locator('#season-select');
      const options = page.locator('#season-select option');
      const optionCount = await options.count();

      if (optionCount > 1) {
        // 2ç•ªç›®ã®ã‚·ãƒ¼ã‚ºãƒ³ã‚’é¸æŠ
        await select.selectOption({ index: 1 });

        // çµ±è¨ˆãŒæ›´æ–°ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
        await page.waitForResponse((response) =>
          response.url().includes('/api/statistics') && response.status() === 200
        );

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
        await expect(page.locator('h2')).toContainText('ã‚·ãƒ¼ã‚ºãƒ³');
      }
    });

    test('ã‚·ãƒ¼ã‚ºãƒ³ãŒãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
      // å¯¾æˆ¦å±¥æ­´ãŒãªã„çŠ¶æ…‹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ãƒ¢ãƒƒã‚¯ï¼‰
      // ã“ã®ãƒ†ã‚¹ãƒˆã¯å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ã«ä¾å­˜ã™ã‚‹
    });
  });

  test.describe('å¯¾æˆ¦å±¥æ­´ç™»éŒ²', () => {
    test('å¯¾æˆ¦ã‚’è¨˜éŒ²ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
      await expect(page.getByRole('button', { name: /å¯¾æˆ¦ã‚’è¨˜éŒ²/ })).toBeVisible();
    });

    test('å¯¾æˆ¦ã‚’è¨˜éŒ²ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ã', async ({ page }) => {
      await page.click('button:has-text("å¯¾æˆ¦ã‚’è¨˜éŒ²")');

      // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      await expect(page.locator('[role="dialog"]')).toBeVisible();
    });

    test('å¯¾æˆ¦å±¥æ­´ã‚’ç™»éŒ²ã™ã‚‹ã¨çµ±è¨ˆãŒæ›´æ–°ã•ã‚Œã‚‹', async ({ page }) => {
      // åˆæœŸã®è©¦åˆæ•°ã‚’å–å¾—
      const initialGamesText = await page.locator('[data-testid="total-games"]').textContent();
      const initialGames = parseInt(initialGamesText ?? '0', 10);

      // å¯¾æˆ¦ã‚’è¨˜éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
      await page.click('button:has-text("å¯¾æˆ¦ã‚’è¨˜éŒ²")');
      await expect(page.locator('[role="dialog"]')).toBeVisible();

      // ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›
      await page.selectOption('select[name="myDeckId"]', { index: 1 });
      await page.selectOption('select[name="opponentDeckId"]', { index: 1 });
      await page.selectOption('select[name="turn"]', 'å…ˆæ”»');
      await page.selectOption('select[name="result"]', 'å‹ã¡');

      // ä¿å­˜
      await page.click('button:has-text("ä¿å­˜")');

      // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ã‚‹ã®ã‚’å¾…ã¤
      await expect(page.locator('[role="dialog"]')).not.toBeVisible();

      // çµ±è¨ˆãŒæ›´æ–°ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
      await page.waitForResponse((response) =>
        response.url().includes('/api/statistics') && response.status() === 200
      );

      // è©¦åˆæ•°ãŒå¢—ãˆã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      const newGamesText = await page.locator('[data-testid="total-games"]').textContent();
      const newGames = parseInt(newGamesText ?? '0', 10);
      expect(newGames).toBeGreaterThan(initialGames);
    });

    test('ç™»éŒ²å¾Œã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ã‚‹', async ({ page }) => {
      await page.click('button:has-text("å¯¾æˆ¦ã‚’è¨˜éŒ²")');
      await expect(page.locator('[role="dialog"]')).toBeVisible();

      // ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¦ä¿å­˜
      await page.selectOption('select[name="myDeckId"]', { index: 1 });
      await page.selectOption('select[name="opponentDeckId"]', { index: 1 });
      await page.selectOption('select[name="turn"]', 'å…ˆæ”»');
      await page.selectOption('select[name="result"]', 'å‹ã¡');
      await page.click('button:has-text("ä¿å­˜")');

      // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ã‚‹ã“ã¨ã‚’ç¢ºèª
      await expect(page.locator('[role="dialog"]')).not.toBeVisible();
    });

    test('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ã‚‹', async ({ page }) => {
      await page.click('button:has-text("å¯¾æˆ¦ã‚’è¨˜éŒ²")');
      await expect(page.locator('[role="dialog"]')).toBeVisible();

      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
      await page.click('button:has-text("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")');

      // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ã‚‹ã“ã¨ã‚’ç¢ºèª
      await expect(page.locator('[role="dialog"]')).not.toBeVisible();
    });
  });

  test.describe('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤º', () => {
    test('å…¨ä½“çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
      await expect(page.locator('[data-testid="statistics-overview"]')).toBeVisible();
    });

    test('ä½¿ç”¨ãƒ‡ãƒƒã‚­åˆ¥çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
      await expect(page.getByText('ä½¿ç”¨ãƒ‡ãƒƒã‚­åˆ¥æˆç¸¾')).toBeVisible();
    });

    test('ç›¸æ‰‹ãƒ‡ãƒƒã‚­åˆ¥çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
      await expect(page.getByText('ç›¸æ‰‹ãƒ‡ãƒƒã‚­åˆ¥æˆç¸¾')).toBeVisible();
    });

    test('ã‚¿ãƒ¼ãƒ³åˆ¥çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
      await expect(page.getByText('ã‚¿ãƒ¼ãƒ³åˆ¥æˆç¸¾')).toBeVisible();
    });
  });

  test.describe('ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹', () => {
    test('ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¯ã‚¹ãƒ”ãƒŠãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      await page.route('**/api/statistics/**', async (route) => {
        await new Promise((resolve) => setTimeout(resolve, 1000));
        await route.continue();
      });

      await page.goto('/statistics');

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ç¢ºèª
      await expect(page.locator('.animate-spin')).toBeVisible();
    });
  });
});
```

### 2. ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£è¿½åŠ 

`packages/frontend/e2e/fixtures/statistics-fixtures.ts`:

```typescript
import { test as base } from '@playwright/test';

interface StatisticsFixtures {
  seedStatisticsData: () => Promise<void>;
  clearStatisticsData: () => Promise<void>;
}

export const test = base.extend<StatisticsFixtures>({
  seedStatisticsData: async ({ page }, use) => {
    const seed = async () => {
      // APIã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      await page.request.post('/api/battle-logs', {
        data: {
          season: 5,
          date: '2025/01/01',
          myDeckId: 'd1',
          opponentDeckId: 'o1',
          turn: 'å…ˆæ”»',
          result: 'å‹ã¡',
        },
      });
    };
    await use(seed);
  },

  clearStatisticsData: async ({ page }, use) => {
    const clear = async () => {
      // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè£…ï¼‰
    };
    await use(clear);
  },
});

export { expect } from '@playwright/test';
```

### 3. ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

`packages/frontend/e2e/utils/statistics-helpers.ts`:

```typescript
import { Page } from '@playwright/test';

/**
 * å¯¾æˆ¦å±¥æ­´ã‚’ç™»éŒ²ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 */
export async function registerBattleLog(
  page: Page,
  options: {
    myDeckIndex?: number;
    opponentDeckIndex?: number;
    turn?: 'å…ˆæ”»' | 'å¾Œæ”»';
    result?: 'å‹ã¡' | 'è² ã‘';
  } = {}
): Promise<void> {
  const {
    myDeckIndex = 1,
    opponentDeckIndex = 1,
    turn = 'å…ˆæ”»',
    result = 'å‹ã¡',
  } = options;

  await page.click('button:has-text("å¯¾æˆ¦ã‚’è¨˜éŒ²")');
  await page.selectOption('select[name="myDeckId"]', { index: myDeckIndex });
  await page.selectOption('select[name="opponentDeckId"]', { index: opponentDeckIndex });
  await page.selectOption('select[name="turn"]', turn);
  await page.selectOption('select[name="result"]', result);
  await page.click('button:has-text("ä¿å­˜")');
  await page.waitForSelector('[role="dialog"]', { state: 'hidden' });
}

/**
 * ã‚·ãƒ¼ã‚ºãƒ³ã‚’é¸æŠã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 */
export async function selectSeason(page: Page, seasonIndex: number): Promise<void> {
  await page.selectOption('#season-select', { index: seasonIndex });
  await page.waitForResponse((response) =>
    response.url().includes('/api/statistics') && response.status() === 200
  );
}
```

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### E2Eãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | èª¬æ˜ | æœŸå¾…çµæœ |
|---|---|---|
| ã‚·ãƒ¼ã‚ºãƒ³é¸æŠè¡¨ç¤º | ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è¡¨ç¤º | ã‚·ãƒ¼ã‚ºãƒ³é¸æŠUIãŒè¡¨ç¤ºã•ã‚Œã‚‹ |
| åˆæœŸã‚·ãƒ¼ã‚ºãƒ³ | åˆæœŸé¸æŠçŠ¶æ…‹ | æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ |
| ã‚·ãƒ¼ã‚ºãƒ³åˆ‡ã‚Šæ›¿ãˆ | ã‚·ãƒ¼ã‚ºãƒ³å¤‰æ›´ | çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã‚‹ |
| å¯¾æˆ¦è¨˜éŒ²ãƒœã‚¿ãƒ³ | ãƒœã‚¿ãƒ³è¡¨ç¤º | ã€Œå¯¾æˆ¦ã‚’è¨˜éŒ²ã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ |
| ãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–‹é–‰ | ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ | ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹é–‰ã™ã‚‹ |
| å¯¾æˆ¦å±¥æ­´ç™»éŒ² | ç™»éŒ²ãƒ•ãƒ­ãƒ¼ | ç™»éŒ²æˆåŠŸå¾Œã«çµ±è¨ˆãŒæ›´æ–°ã•ã‚Œã‚‹ |
| çµ±è¨ˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤º | å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º | å…¨çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ |
| ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ | ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º | ã‚¹ãƒ”ãƒŠãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ |

---

## å®Œäº†æ¡ä»¶

- [ ] E2Eãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚·ãƒ¼ã‚ºãƒ³é¸æŠãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
- [ ] å¯¾æˆ¦å±¥æ­´ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
- [ ] ç™»éŒ²å¾Œã®çµ±è¨ˆæ›´æ–°ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
- [ ] ã™ã¹ã¦ã®E2Eãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹

---

## å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pnpm exec playwright test e2e/statistics.spec.ts

# UIãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
pnpm exec playwright test e2e/statistics.spec.ts --ui

# ãƒ˜ãƒƒãƒ‰ãƒ•ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
pnpm exec playwright test e2e/statistics.spec.ts --headed

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
pnpm exec playwright test e2e/statistics.spec.ts -g "ã‚·ãƒ¼ã‚ºãƒ³é¸æŠ"
```

---

## æ¤œè¨¼æ‰‹é †

1. `packages/frontend/e2e/statistics.spec.ts` ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
2. `pnpm exec playwright test e2e/statistics.spec.ts` ã§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã‹ç¢ºèª
3. ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªï¼ˆ`playwright-report/index.html`ï¼‰

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [TASK-0028: çµ±è¨ˆç”»é¢ã‚·ãƒ¼ã‚ºãƒ³é¸æŠUIå®Ÿè£…](./TASK-0028.md)
- [TASK-0029: çµ±è¨ˆç”»é¢å¯¾æˆ¦å±¥æ­´ç™»éŒ²ãƒœã‚¿ãƒ³è¿½åŠ ](./TASK-0029.md)
