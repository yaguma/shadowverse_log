# TASK-0028: çµ±è¨ˆç”»é¢ã‚·ãƒ¼ã‚ºãƒ³é¸æŠUIå®Ÿè£…

## ã‚¿ã‚¹ã‚¯æƒ…å ±

- **ã‚¿ã‚¹ã‚¯ID**: TASK-0028
- **ã‚¿ã‚¤ãƒ—**: TDD
- **æ¨å®šå·¥æ•°**: 2æ™‚é–“
- **ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±è¨ˆç”»é¢æ©Ÿèƒ½æ‹¡å¼µ
- **ä¿¡é ¼æ€§**: ğŸ”µï¼ˆdataflow.md 3.1ã€œ3.2ã‚ˆã‚Šï¼‰
- **ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0027
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0029
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: [ ] æœªå®Œäº†

---

## æ¦‚è¦

çµ±è¨ˆç”»é¢ã«ã‚·ãƒ¼ã‚ºãƒ³é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã€‚åˆæœŸè¡¨ç¤ºã§æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ã‚’é¸æŠã—ã€ã‚·ãƒ¼ã‚ºãƒ³å¤‰æ›´æ™‚ã«çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã™ã‚‹ã€‚

---

## å®Ÿè£…å†…å®¹

### 1. ã‚·ãƒ¼ã‚ºãƒ³ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ

`packages/frontend/src/components/statistics/SeasonSelector.tsx`:

```typescript
import { useStatisticsStore } from '@/store/statisticsStore';

export const SeasonSelector = () => {
  const {
    selectedSeason,
    availableSeasons,
    setSelectedSeason,
    isSeasonsLoading
  } = useStatisticsStore();

  const handleSeasonChange = (event: React.ChangeEvent<HTMLSelectElement>) => {
    const season = parseInt(event.target.value, 10);
    setSelectedSeason(season);
  };

  if (isSeasonsLoading) {
    return (
      <div className="flex items-center gap-2">
        <span className="text-sm text-gray-500">ã‚·ãƒ¼ã‚ºãƒ³èª­ã¿è¾¼ã¿ä¸­...</span>
      </div>
    );
  }

  if (availableSeasons.length === 0) {
    return (
      <div className="flex items-center gap-2">
        <span className="text-sm text-gray-500">ã‚·ãƒ¼ã‚ºãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</span>
      </div>
    );
  }

  return (
    <div className="flex items-center gap-2">
      <label htmlFor="season-select" className="text-sm font-medium text-gray-700">
        ã‚·ãƒ¼ã‚ºãƒ³:
      </label>
      <select
        id="season-select"
        value={selectedSeason ?? ''}
        onChange={handleSeasonChange}
        className="
          block w-32 px-3 py-2 text-sm
          bg-white border border-gray-300 rounded-md
          shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
        "
      >
        {availableSeasons.map((season) => (
          <option key={season} value={season}>
            ã‚·ãƒ¼ã‚ºãƒ³ {season}
          </option>
        ))}
      </select>
    </div>
  );
};
```

### 2. çµ±è¨ˆç”»é¢ã¸ã®çµ„ã¿è¾¼ã¿

`packages/frontend/src/pages/StatisticsPage.tsx` ã‚’æ›´æ–°:

```typescript
import { useEffect } from 'react';
import { useStatisticsStore } from '@/store/statisticsStore';
import { SeasonSelector } from '@/components/statistics/SeasonSelector';
import { StatisticsOverview } from '@/components/statistics/StatisticsOverview';
import { DeckStatisticsTable } from '@/components/statistics/DeckStatisticsTable';
import { TurnStatisticsChart } from '@/components/statistics/TurnStatisticsChart';

export const StatisticsPage = () => {
  const {
    statistics,
    isLoading,
    error,
    fetchSeasons,
    selectedSeason
  } = useStatisticsStore();

  useEffect(() => {
    // åˆå›ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§ã‚’å–å¾—ï¼ˆè‡ªå‹•ã§æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ã®çµ±è¨ˆã‚‚å–å¾—ã•ã‚Œã‚‹ï¼‰
    fetchSeasons();
  }, [fetchSeasons]);

  if (error) {
    return (
      <div className="container mx-auto px-4 py-6">
        <div className="bg-red-50 border border-red-200 rounded-md p-4">
          <p className="text-red-700">{error}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold">çµ±è¨ˆ</h1>
        <SeasonSelector />
      </div>

      {isLoading ? (
        <div className="flex items-center justify-center py-12">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <span className="ml-2 text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
      ) : statistics ? (
        <div className="space-y-8">
          {/* å…¨ä½“çµ±è¨ˆ */}
          <section>
            <h2 className="text-lg font-semibold mb-4">
              ã‚·ãƒ¼ã‚ºãƒ³ {selectedSeason} å…¨ä½“æˆç¸¾
            </h2>
            <StatisticsOverview statistics={statistics.overall} />
          </section>

          {/* ãƒ‡ãƒƒã‚­åˆ¥çµ±è¨ˆ */}
          <section>
            <h2 className="text-lg font-semibold mb-4">ä½¿ç”¨ãƒ‡ãƒƒã‚­åˆ¥æˆç¸¾</h2>
            <DeckStatisticsTable data={statistics.byMyDeck} />
          </section>

          {/* ç›¸æ‰‹ãƒ‡ãƒƒã‚­åˆ¥çµ±è¨ˆ */}
          <section>
            <h2 className="text-lg font-semibold mb-4">ç›¸æ‰‹ãƒ‡ãƒƒã‚­åˆ¥æˆç¸¾</h2>
            <DeckStatisticsTable data={statistics.byOpponentDeck} />
          </section>

          {/* ã‚¿ãƒ¼ãƒ³åˆ¥çµ±è¨ˆ */}
          <section>
            <h2 className="text-lg font-semibold mb-4">ã‚¿ãƒ¼ãƒ³åˆ¥æˆç¸¾</h2>
            <TurnStatisticsChart data={statistics.byTurn} />
          </section>
        </div>
      ) : (
        <div className="text-center py-12 text-gray-500">
          çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
        </div>
      )}
    </div>
  );
};
```

### 3. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ã‚¹ã‚±ãƒ«ãƒˆãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

`packages/frontend/src/components/statistics/StatisticsSkeleton.tsx`:

```typescript
export const StatisticsSkeleton = () => {
  return (
    <div className="space-y-8 animate-pulse">
      {/* å…¨ä½“çµ±è¨ˆã‚¹ã‚±ãƒ«ãƒˆãƒ³ */}
      <section>
        <div className="h-6 w-48 bg-gray-200 rounded mb-4"></div>
        <div className="grid grid-cols-4 gap-4">
          {[...Array(4)].map((_, i) => (
            <div key={i} className="bg-gray-100 rounded-lg p-4">
              <div className="h-4 w-16 bg-gray-200 rounded mb-2"></div>
              <div className="h-8 w-24 bg-gray-200 rounded"></div>
            </div>
          ))}
        </div>
      </section>

      {/* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚±ãƒ«ãƒˆãƒ³ */}
      <section>
        <div className="h-6 w-32 bg-gray-200 rounded mb-4"></div>
        <div className="border rounded-lg overflow-hidden">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="flex items-center gap-4 p-4 border-b last:border-b-0">
              <div className="h-4 w-32 bg-gray-200 rounded"></div>
              <div className="h-4 w-16 bg-gray-200 rounded"></div>
              <div className="h-4 w-16 bg-gray-200 rounded"></div>
            </div>
          ))}
        </div>
      </section>
    </div>
  );
};
```

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆVitestï¼‰

`packages/frontend/src/components/statistics/__tests__/SeasonSelector.test.tsx`:

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { SeasonSelector } from '../SeasonSelector';
import { useStatisticsStore } from '@/store/statisticsStore';

vi.mock('@/store/statisticsStore', () => ({
  useStatisticsStore: vi.fn(),
}));

describe('SeasonSelector', () => {
  const mockSetSelectedSeason = vi.fn();

  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('ã‚·ãƒ¼ã‚ºãƒ³é¸æŠè‚¢', () => {
    it('ã‚·ãƒ¼ã‚ºãƒ³é¸æŠè‚¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      vi.mocked(useStatisticsStore).mockReturnValue({
        selectedSeason: 5,
        availableSeasons: [5, 4, 3, 2, 1],
        setSelectedSeason: mockSetSelectedSeason,
        isSeasonsLoading: false,
      } as any);

      render(<SeasonSelector />);

      expect(screen.getByRole('combobox')).toBeInTheDocument();
      expect(screen.getByText('ã‚·ãƒ¼ã‚ºãƒ³ 5')).toBeInTheDocument();
      expect(screen.getByText('ã‚·ãƒ¼ã‚ºãƒ³ 1')).toBeInTheDocument();
    });

    it('åˆæœŸè¡¨ç¤ºã§æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹', () => {
      vi.mocked(useStatisticsStore).mockReturnValue({
        selectedSeason: 5,
        availableSeasons: [5, 4, 3],
        setSelectedSeason: mockSetSelectedSeason,
        isSeasonsLoading: false,
      } as any);

      render(<SeasonSelector />);

      const select = screen.getByRole('combobox') as HTMLSelectElement;
      expect(select.value).toBe('5');
    });
  });

  describe('ã‚·ãƒ¼ã‚ºãƒ³å¤‰æ›´', () => {
    it('ã‚·ãƒ¼ã‚ºãƒ³å¤‰æ›´ã§setSelectedSeasonãŒå‘¼ã°ã‚Œã‚‹', () => {
      vi.mocked(useStatisticsStore).mockReturnValue({
        selectedSeason: 5,
        availableSeasons: [5, 4, 3],
        setSelectedSeason: mockSetSelectedSeason,
        isSeasonsLoading: false,
      } as any);

      render(<SeasonSelector />);

      const select = screen.getByRole('combobox');
      fireEvent.change(select, { target: { value: '3' } });

      expect(mockSetSelectedSeason).toHaveBeenCalledWith(3);
    });
  });

  describe('ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹', () => {
    it('ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      vi.mocked(useStatisticsStore).mockReturnValue({
        selectedSeason: null,
        availableSeasons: [],
        setSelectedSeason: mockSetSelectedSeason,
        isSeasonsLoading: true,
      } as any);

      render(<SeasonSelector />);

      expect(screen.getByText('ã‚·ãƒ¼ã‚ºãƒ³èª­ã¿è¾¼ã¿ä¸­...')).toBeInTheDocument();
    });
  });

  describe('ã‚·ãƒ¼ã‚ºãƒ³ãªã—', () => {
    it('ã‚·ãƒ¼ã‚ºãƒ³ãŒãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      vi.mocked(useStatisticsStore).mockReturnValue({
        selectedSeason: null,
        availableSeasons: [],
        setSelectedSeason: mockSetSelectedSeason,
        isSeasonsLoading: false,
      } as any);

      render(<SeasonSelector />);

      expect(screen.getByText('ã‚·ãƒ¼ã‚ºãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“')).toBeInTheDocument();
    });
  });
});
```

### çµ±è¨ˆç”»é¢ãƒ†ã‚¹ãƒˆ

`packages/frontend/src/pages/__tests__/StatisticsPage.test.tsx`:

```typescript
import { render, screen, waitFor } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { StatisticsPage } from '../StatisticsPage';
import { useStatisticsStore } from '@/store/statisticsStore';

vi.mock('@/store/statisticsStore', () => ({
  useStatisticsStore: vi.fn(),
}));

vi.mock('@/components/statistics/SeasonSelector', () => ({
  SeasonSelector: () => <div data-testid="season-selector">SeasonSelector</div>,
}));

describe('StatisticsPage', () => {
  const mockFetchSeasons = vi.fn();

  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('ãƒã‚¦ãƒ³ãƒˆæ™‚ã«fetchSeasonsãŒå‘¼ã°ã‚Œã‚‹', async () => {
    vi.mocked(useStatisticsStore).mockReturnValue({
      statistics: null,
      isLoading: false,
      error: null,
      fetchSeasons: mockFetchSeasons,
      selectedSeason: null,
    } as any);

    render(<StatisticsPage />);

    await waitFor(() => {
      expect(mockFetchSeasons).toHaveBeenCalledTimes(1);
    });
  });

  it('SeasonSelectorãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
    vi.mocked(useStatisticsStore).mockReturnValue({
      statistics: null,
      isLoading: false,
      error: null,
      fetchSeasons: mockFetchSeasons,
      selectedSeason: null,
    } as any);

    render(<StatisticsPage />);

    expect(screen.getByTestId('season-selector')).toBeInTheDocument();
  });

  it('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
    vi.mocked(useStatisticsStore).mockReturnValue({
      statistics: {
        season: 5,
        overall: { totalGames: 100, wins: 60, losses: 40, winRate: 60 },
        byMyDeck: [],
        byOpponentDeck: [],
        byTurn: { å…ˆæ”»: {}, å¾Œæ”»: {} },
      },
      isLoading: false,
      error: null,
      fetchSeasons: mockFetchSeasons,
      selectedSeason: 5,
    } as any);

    render(<StatisticsPage />);

    expect(screen.getByText('ã‚·ãƒ¼ã‚ºãƒ³ 5 å…¨ä½“æˆç¸¾')).toBeInTheDocument();
  });
});
```

---

## å®Œäº†æ¡ä»¶

- [ ] ã‚·ãƒ¼ã‚ºãƒ³é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒçµ±è¨ˆç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] åˆæœŸè¡¨ç¤ºã§æœ€æ–°ã‚·ãƒ¼ã‚ºãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚·ãƒ¼ã‚ºãƒ³å¤‰æ›´ã§çµ±è¨ˆãŒå†å–å¾—ã•ã‚Œã‚‹
- [ ] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚·ãƒ¼ã‚ºãƒ³ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦æˆåŠŸã™ã‚‹

---

## å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# TDDãƒ•ãƒ­ãƒ¼
/tsumiki:tdd-red           # ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
/tsumiki:tdd-green         # æœ€å°å®Ÿè£…ï¼ˆæˆåŠŸï¼‰
/tsumiki:tdd-refactor      # ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
/tsumiki:tdd-verify-complete  # å“è³ªç¢ºèª
```

---

## æ¤œè¨¼æ‰‹é †

1. `packages/frontend/src/components/statistics/SeasonSelector.tsx` ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
2. `packages/frontend/src/pages/StatisticsPage.tsx` ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. `pnpm test` ã§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã‹ç¢ºèª
4. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚·ãƒ¼ã‚ºãƒ³é¸æŠãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹æ‰‹å‹•ç¢ºèª

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ dataflow.md 3.1ã€œ3.2](../../design/deck-management-extension/dataflow.md)
- [TASK-0027: StatisticsStoreæ‹¡å¼µ](./TASK-0027.md)
