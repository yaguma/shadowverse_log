# TASK-0014: デッキ種別管理E2Eテスト

**タスクID**: TASK-0014
**タスクタイプ**: TDD
**推定工数**: 2時間
**フェーズ**: Phase 2 - デッキ種別管理機能
**信頼性レベル**: 🔵

## 関連文書
- [技術設計書](../../design/deck-management-extension/README.md)
- [データフロー図](../../design/deck-management-extension/dataflow.md)
- [要件定義](../../design/deck-management-extension/requirements.md)

## タスク概要
Playwrightを使用したデッキ種別管理機能のE2Eテストを実装する。ユーザー操作フロー全体が正常に動作すること、エッジケースが適切に処理されることを検証する。

## 依存タスク
- **前提タスク**: [TASK-0013](TASK-0013.md) - 統合テスト
- **後続タスク**: [TASK-0015](TASK-0015.md) - Phase 3開始

## 完了条件
- [ ] デッキ種別追加E2Eテストがパスすること
- [ ] デッキ種別編集E2Eテストがパスすること
- [ ] デッキ種別削除E2Eテストがパスすること
- [ ] 削除制約エラーE2Eテストがパスすること
- [ ] ユーザー操作フロー全体が動作すること

---
## 実装詳細

### ファイル構成
```
packages/e2e/
├── tests/
│   └── deck-master/
│       ├── deck-master-add.spec.ts     # 追加テスト（新規）
│       ├── deck-master-edit.spec.ts    # 編集テスト（新規）
│       └── deck-master-delete.spec.ts  # 削除テスト（新規）
├── fixtures/
│   └── deck-master.ts                  # テストフィクスチャ（新規）
└── pages/
    └── DeckMasterPage.ts               # Page Object（新規）
```

### Page Objectパターン
```typescript
// DeckMasterPage.ts
export class DeckMasterPage {
  constructor(private page: Page) {}

  async goto() {
    await this.page.goto('/deck-master');
  }

  async clickAddButton() {
    await this.page.click('[data-testid="add-deck-master-button"]');
  }

  async fillClassName(className: string) {
    await this.page.selectOption('[data-testid="class-name-select"]', className);
  }

  async fillDeckName(deckName: string) {
    await this.page.fill('[data-testid="deck-name-input"]', deckName);
  }

  async submitForm() {
    await this.page.click('[data-testid="submit-button"]');
  }

  async getDeckMasterItems() {
    return this.page.locator('[data-testid="deck-master-item"]');
  }

  async clickEditButton(index: number) {
    await this.page.click(`[data-testid="edit-button-${index}"]`);
  }

  async clickDeleteButton(index: number) {
    await this.page.click(`[data-testid="delete-button-${index}"]`);
  }

  async confirmDelete() {
    await this.page.click('[data-testid="confirm-delete-button"]');
  }

  async cancelDelete() {
    await this.page.click('[data-testid="cancel-delete-button"]');
  }
}
```

### テストデータ準備
```typescript
// fixtures/deck-master.ts
export const testDeckMasters = [
  {
    id: 'test-uuid-1',
    className: 'ウィッチ',
    deckName: '秘術ウィッチ',
    sortOrder: 1,
    usageCount: 0,  // 削除可能
  },
  {
    id: 'test-uuid-2',
    className: 'ドラゴン',
    deckName: '原初ドラゴン',
    sortOrder: 2,
    usageCount: 10,  // 削除不可
  },
];
```

---
## E2Eテスト要件

### deck-master-add.spec.ts

#### 正常系
1. **デッキ種別追加 - 正常フロー**
   ```typescript
   test('デッキ種別を正常に追加できる', async ({ page }) => {
     const deckMasterPage = new DeckMasterPage(page);
     await deckMasterPage.goto();

     // 追加ボタンクリック
     await deckMasterPage.clickAddButton();

     // フォーム入力
     await deckMasterPage.fillClassName('ウィッチ');
     await deckMasterPage.fillDeckName('テストデッキ');

     // 送信
     await deckMasterPage.submitForm();

     // 結果確認
     await expect(page.locator('text=テストデッキ')).toBeVisible();
   });
   ```

2. **追加後に一覧が更新される**

3. **連続追加が可能**

#### 異常系
4. **デッキ名空で登録不可**

5. **デッキ名51文字で登録不可**

6. **クラス名未選択で登録不可**

### deck-master-edit.spec.ts

#### 正常系
7. **デッキ種別編集 - 正常フロー**
   ```typescript
   test('デッキ種別を正常に編集できる', async ({ page }) => {
     const deckMasterPage = new DeckMasterPage(page);
     await deckMasterPage.goto();

     // 編集ボタンクリック
     await deckMasterPage.clickEditButton(0);

     // フォーム編集
     await deckMasterPage.fillDeckName('編集後デッキ名');

     // 送信
     await deckMasterPage.submitForm();

     // 結果確認
     await expect(page.locator('text=編集後デッキ名')).toBeVisible();
   });
   ```

8. **編集時にクラス名が変更不可（disabled）**

9. **編集キャンセルで変更されない**

#### 異常系
10. **デッキ名空で更新不可**

### deck-master-delete.spec.ts

#### 正常系
11. **デッキ種別削除 - 正常フロー**
    ```typescript
    test('デッキ種別を正常に削除できる', async ({ page }) => {
      const deckMasterPage = new DeckMasterPage(page);
      await deckMasterPage.goto();

      // 削除ボタンクリック
      await deckMasterPage.clickDeleteButton(0);

      // 確認ダイアログで削除
      await deckMasterPage.confirmDelete();

      // 結果確認
      await expect(page.locator('text=秘術ウィッチ')).not.toBeVisible();
    });
    ```

12. **削除キャンセルで削除されない**

#### 異常系
13. **参照ありデータは削除ボタンがdisabled**

14. **参照ありデータ削除で409エラー表示**
    - （APIレベルで確認、UIでは削除ボタンdisabledで防止）

---
## 実装手順

### Red Phase（失敗するテストを書く）
1. E2Eテストファイル作成
2. Page Object作成
3. テストフィクスチャ作成
4. テストケース実装
5. テスト実行 → 失敗確認

### Green Phase（テストを通す最小実装）
1. data-testid属性をコンポーネントに追加
2. E2E用のテストDB設定
3. テストデータのシード処理
4. テスト実行 → 成功確認

### Refactor Phase（リファクタリング）
1. Page Objectの共通化
2. テストヘルパー関数の整理
3. CI/CDパイプライン設定
4. テスト実行 → 成功確認

---
## 補足事項

### テスト環境
- ローカル開発サーバー起動が必要
- テスト用DBを使用（本番DBとは分離）
- テスト前後でデータクリーンアップ

### CI/CD考慮
- GitHub Actionsでの実行設定
- ヘッドレスモードでの実行
- スクリーンショット/動画の保存（失敗時）

### アクセシビリティ
- 適切なdata-testid属性の付与
- セマンティックなHTML構造
- キーボード操作対応

---
## 信頼性レベルサマリー

| 項目 | レベル | 出典 |
|------|--------|------|
| 追加フロー | 🔵 | dataflow.md 1.1 |
| 編集フロー | 🔵 | dataflow.md 1.2 |
| 削除フロー | 🔵 | dataflow.md 1.3 |
| 削除制約 | 🔵 | REQ-EXT-008, REQ-EXT-401 |
| E2Eテストパターン | 🔵 | Playwright Best Practices |
