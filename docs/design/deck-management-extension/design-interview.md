# デッキ管理機能拡張 設計ヒアリング記録

**作成日**: 2025-01-26
**関連要件ヒアリング**: [interview-record.md](../../spec/deck-management-extension/interview-record.md)

**【信頼性レベル凡例】**:
- 🔵 **青信号**: ユーザヒアリング・設計文書を参考にした確実な決定
- 🟡 **黄信号**: ユーザヒアリング・設計文書から妥当な推測による決定
- 🔴 **赤信号**: ユーザヒアリング・設計文書にない推測による決定

---

## ヒアリング目的

技術設計フェーズにおいて、既存要件ヒアリング結果を踏まえた上で、実装方針の詳細を確定するための追加ヒアリングを実施した。

---

## 設計決定事項

### Q1: API設計方針 🔵

**質問日時**: 2025-01-26
**カテゴリ**: アーキテクチャ決定

**質問**: 新規APIエンドポイントの設計方針はどうするか？

**選択肢**:
1. 既存パターン踏襲（推奨）- 既存の/api/deck-master, /api/my-decksエンドポイントにCRUD操作を追加する
2. 新規エンドポイント作成 - /api/deck-master/manage, /api/my-decks/manageなど専用エンドポイントを新設する

**回答**: **既存パターン踏襲（推奨）**

**決定理由**:
- 既存のREST APIパターンとの一貫性を維持
- クライアント側の変更を最小化
- HTTPメソッド（GET/POST/PUT/DELETE）で操作を区別するRESTful設計を継続

**設計への影響**:
- `/api/deck-master` に POST（追加）、PUT（更新）、DELETE（削除）を追加
- `/api/my-decks` に POST（追加）、DELETE（削除）を追加
- 既存のGETエンドポイントはそのまま維持

---

### Q2: コンポーネント再利用方針 🔵

**質問日時**: 2025-01-26
**カテゴリ**: フロントエンド設計

**質問**: 統計画面の対戦履歴登録ダイアログは、既存コンポーネントをどのように再利用するか？

**選択肢**:
1. 完全再利用（推奨）- BattleLogDialogコンポーネントをそのまま統計画面でもimportして使用
2. 共通化抽出 - ダイアログの共通部分を抽出して新しい共通コンポーネントを作成

**回答**: **完全再利用（推奨）**

**決定理由**:
- 要件定義（REQ-EXT-202）で「一覧画面と同じダイアログを使用」と明記されている
- コードの重複を避け、保守性を向上
- 機能追加時の変更箇所を最小化

**設計への影響**:
- `BattleLogDialog` コンポーネントをそのまま `StatisticsPage` でimport
- ダイアログ表示/非表示の状態管理は各画面で個別に管理
- 登録成功時のコールバックで各画面固有の処理（統計データ更新等）を実行

---

## 既存ヒアリング結果の設計反映

以下は、要件定義フェーズのヒアリング（interview-record.md）から設計に反映した事項の一覧である。

### 反映事項1: クラス名選択肢 🔵

**元ヒアリング**: Q1 - デッキ種別（DeckMaster）のクラス名一覧
**回答**: 今あるすべて

**設計反映**:
- `CLASS_NAMES` 定数として8クラス（エルフ、ロイヤル、ウィッチ、ドラゴン、ネクロマンサー、ヴァンパイア、ビショップ、ネメシス）を定義
- ドロップダウン選択肢として使用
- 将来の拡張性を考慮し、定数として管理

---

### 反映事項2: deckId参照方式 🔵

**元ヒアリング**: Q2 - 使用デッキのclassId参照フィールド
**回答**: 表示はclassName、登録データはid

**設計反映**:
- MyDeck追加画面のクラス選択UIは `className` を表示
- 選択時に `DeckMaster.id` を `deckId` として保存
- 一覧表示時は `deckId` → `DeckMaster` JOIN でクラス名を取得

---

### 反映事項3: シーズン選択無制限 🔵

**元ヒアリング**: Q3 - シーズン選択肢の上限
**回答**: 無制限

**設計反映**:
- `/api/statistics/seasons` エンドポイントでは `SELECT DISTINCT season` で全シーズンを取得
- フロントエンドのドロップダウンに上限を設けない
- ページネーションは不要（シーズン数は数十程度を想定）

---

### 反映事項4: 対戦履歴登録ダイアログ共通化 🔵

**元ヒアリング**: Q4 - 統計画面での対戦履歴登録UI
**回答**: 同じダイアログ

**設計反映**:
- `BattleLogDialog` コンポーネントを統計画面でもimport
- `onSuccess` コールバックで統計データの再取得をトリガー

---

### 反映事項5: 相手デッキソート方式 🔵

**元ヒアリング**: Q5 - 対戦履歴の表示順対象
**回答**: 相手デッキの選択肢

**設計反映**:
- `/api/deck-master?includeUsage=true` で使用履歴付きデータを取得
- SQLで `last_used_date DESC, sort_order ASC` でソート
- 対戦履歴が0件の場合は `sort_order` のみでソート

---

### 反映事項6: レイアウト改善対象 🔵

**元ヒアリング**: Q6 - 横並びレイアウトの対象
**回答**: 登録ダイアログ

**設計反映**:
- `BattleLogDialog` のフォームレイアウトを変更
- シーズン選択と対戦日入力を `flex` で横並び配置
- レスポンシブ対応（モバイルでは縦並び）

---

### 反映事項7: デッキコードバリデーション 🔵

**元ヒアリング**: Q7 - デッキコードのバリデーション
**回答**: バリデーション不要

**設計反映**:
- `deckCode` フィールドは `z.string().optional()` で定義
- 空文字列も許容
- 最大長の制限のみ設定（1000文字程度）

---

### 反映事項8: テーブル構造維持 🔵

**元ヒアリング**: Q8 - 使用デッキのテーブル構造
**回答**: 既存テーブルを拡張せずにできる想定

**設計反映**:
- `my_decks` テーブルのスキーマは変更なし
- 既存の `deck_id` カラムを `DeckMaster.id` 参照として使用
- マイグレーション不要

---

### 反映事項9: デッキ種別編集範囲 🔵

**元ヒアリング**: Q9 - デッキ種別の編集範囲
**回答**: deckNameのみ編集可

**設計反映**:
- `PUT /api/deck-master/:id` リクエストボディには `deckName` のみ
- フロントエンド編集ダイアログでは `className` フィールドを `disabled` 表示
- className変更が必要な場合は削除→再登録のフローを案内

---

### 反映事項10: 削除機能の提供 🔵

**元ヒアリング**: Q10 - 削除機能の要否
**回答**: 両方削除可

**設計反映**:
- `DELETE /api/deck-master/:id` エンドポイント追加
- `DELETE /api/my-decks/:id` エンドポイント追加
- 参照チェック（battle_logs）を削除前に実施
- 参照がある場合は 409 Conflict で拒否

---

## 追加設計決定事項

### 決定事項A: 削除確認ダイアログ 🟡

**カテゴリ**: UX設計

**決定内容**: 削除操作前に確認ダイアログを表示

**決定理由**:
- 誤操作防止
- 一般的なUXパターン

**設計への影響**:
- 削除ボタンクリック時に確認ダイアログを表示
- 「削除する」「キャンセル」の選択肢を提供

---

### 決定事項B: 空リストメッセージ 🔵

**カテゴリ**: UX設計

**元要件**: REQ-EXT-501, REQ-EXT-502

**決定内容**:
- デッキ種別が0件: 「デッキ種別が登録されていません」
- 使用デッキが0件: 「使用デッキが登録されていません」

**設計への影響**:
- 各一覧コンポーネントに `emptyMessage` props を追加
- 空配列時に `EmptyState` コンポーネントを表示

---

### 決定事項C: sortOrder自動採番方式 🔵

**カテゴリ**: データ設計

**決定内容**: 新規追加時は `MAX(sort_order) + 1` で採番

**決定理由**:
- 要件定義で自動採番と明記
- 手動変更機能は Won't Have（対象外）

**設計への影響**:
- POST処理で最大値を取得してインクリメント
- 並行挿入時の競合は許容（厳密な連番は不要）

---

## 信頼性レベルサマリー

- 🔵 青信号: 14件 (93%)
- 🟡 黄信号: 1件 (7%)
- 🔴 赤信号: 0件 (0%)

**品質評価**: 高品質（ほぼすべての設計決定がユーザヒアリングに基づく）

---

## 更新履歴

- **2025-01-26**: 初版作成（tsumiki:kairo-design により生成）
