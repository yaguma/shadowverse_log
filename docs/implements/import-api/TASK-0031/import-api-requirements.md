# TASK-0031: ã‚¤ãƒ³ãƒãƒ¼ãƒˆAPIå®Ÿè£… - è¦ä»¶å®šç¾©æ›¸

## æ¦‚è¦

Cloudflare Workersä¸Šã§Honoãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆAPIã®å®Ÿè£…ã€‚JSON/CSVå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã€‚

**ä½œæˆæ—¥**: 2025-11-30
**ã‚¿ã‚¹ã‚¯ID**: TASK-0031
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 6æ™‚é–“

---

## 1. æ©Ÿèƒ½ã®æ¦‚è¦ï¼ˆEARSè¦ä»¶å®šç¾©æ›¸ãƒ»è¨­è¨ˆæ–‡æ›¸ãƒ™ãƒ¼ã‚¹ï¼‰

- ğŸ”µ **æ©Ÿèƒ½æ¦‚è¦**: JSON/CSVå½¢å¼ã®å¯¾æˆ¦å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹REST API
- ğŸ”µ **è§£æ±ºã™ã‚‹å•é¡Œ**: æ—¢å­˜ã®JSON/CSVãƒ‡ãƒ¼ã‚¿ã‚’D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’å¯èƒ½ã«ã™ã‚‹
- ğŸ”µ **æƒ³å®šãƒ¦ãƒ¼ã‚¶ãƒ¼**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆReact SPAï¼‰
- ğŸ”µ **ã‚·ã‚¹ãƒ†ãƒ å†…ã§ã®ä½ç½®ã¥ã‘**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆCloudflare Workersï¼‰
- **å‚ç…§ã—ãŸEARSè¦ä»¶**: REQ-035
- **å‚ç…§ã—ãŸè¨­è¨ˆæ–‡æ›¸**:
  - api-endpoints-cloudflare.mdï¼ˆAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜ ã‚»ã‚¯ã‚·ãƒ§ãƒ³4.1ï¼‰
  - cloudflare-migration-phase2-part3-i.mdï¼ˆã‚¿ã‚¹ã‚¯è©³ç´°ï¼‰

---

## 2. å…¥åŠ›ãƒ»å‡ºåŠ›ã®ä»•æ§˜ï¼ˆEARSæ©Ÿèƒ½è¦ä»¶ãƒ»TypeScriptå‹å®šç¾©ãƒ™ãƒ¼ã‚¹ï¼‰

### 2.1 å‹å®šç¾©

#### ImportFormatå‹ ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

```typescript
export type ImportFormat = 'json' | 'csv'
```

#### ImportRequestå‹ ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

```typescript
export interface ImportRequest {
  format: ImportFormat
  data: string  // JSONæ–‡å­—åˆ—ã¾ãŸã¯CSVæ–‡å­—åˆ—
}
```

#### ImportResponseå‹ ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

```typescript
export interface ImportResponse {
  imported: number   // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸä»¶æ•°
  skipped: number    // ã‚¹ã‚­ãƒƒãƒ—ä»¶æ•°ï¼ˆé‡è¤‡ãªã©ï¼‰
  errors?: string[]  // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—
}
```

#### ImportBattleLogInputå‹ ğŸŸ¡ *æ—¢å­˜ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰æ¨æ¸¬*

```typescript
export interface ImportBattleLogInput {
  id?: string                // ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
  date: string               // YYYY-MM-DDå½¢å¼
  battleType: BattleType
  rank: Rank
  group: string
  myDeckId: string
  turn: Turn
  result: BattleResult
  opponentDeckId: string
}
```

### 2.2 APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### POST /api/import ğŸ”µ *REQ-035, api-endpoints-cloudflare.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³4.1ã‚ˆã‚Š*

**èª¬æ˜**: JSON/CSVå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**:

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | å¿…é ˆ | èª¬æ˜ | ä¿¡é ¼æ€§ |
|---|---|---|---|---|
| `format` | "json" \| "csv" | Yes | ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ | ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š* |
| `data` | string | Yes | ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ | ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š* |

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ (JSON)**:

```http
POST /api/import
Content-Type: application/json

{
  "format": "json",
  "data": "[{\"date\":\"2025-01-24\",\"battleType\":\"ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ\",\"rank\":\"ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰\",\"group\":\"AAA\",\"myDeckId\":\"deck_001\",\"turn\":\"å…ˆæ”»\",\"result\":\"å‹ã¡\",\"opponentDeckId\":\"deck_master_002\"}]"
}
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ (CSV)**:

```http
POST /api/import
Content-Type: application/json

{
  "format": "csv",
  "data": "date,battleType,rank,group,myDeckId,turn,result,opponentDeckId\n2025-01-24,ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ,ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰,AAA,deck_001,å…ˆæ”»,å‹ã¡,deck_master_002"
}
```

**æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹** (200 OK):

```json
{
  "success": true,
  "data": {
    "imported": 5,
    "skipped": 2,
    "errors": []
  },
  "meta": {
    "timestamp": "2025-01-24T12:34:56.789Z",
    "requestId": "uuid-v4"
  }
}
```

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹** (400 Bad Request):

```json
{
  "success": false,
  "error": {
    "code": "INVALID_FORMAT",
    "message": "ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã™"
  },
  "meta": {
    "timestamp": "2025-01-24T12:34:56.789Z",
    "requestId": "uuid-v4"
  }
}
```

---

## 3. åˆ¶ç´„æ¡ä»¶ï¼ˆEARSéæ©Ÿèƒ½è¦ä»¶ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆãƒ™ãƒ¼ã‚¹ï¼‰

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ ğŸ”µ *api-endpoints-cloudflare.mdã‚ˆã‚Š*

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ç›®æ¨™ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  |
|---|---|
| POST /api/import | < 500ms |

### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¦ä»¶ ğŸ”µ *REQ-401, REQ-402ã‚ˆã‚Š*

- æ—¥ä»˜ã¯`YYYY-MM-DD`å½¢å¼ã§ã‚ã‚‹ã“ã¨
- æœªæ¥ã®æ—¥ä»˜ã¯å…¥åŠ›ä¸å¯
- ã™ã¹ã¦ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å…¥åŠ›å¿…é ˆ
- Enumå€¤ã¯å®šç¾©ã•ã‚ŒãŸå€¤ã®ã¿è¨±å¯
- CSVã®å ´åˆã€å¿…é ˆãƒ˜ãƒƒãƒ€ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã“ã¨

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ ğŸ”µ *storage-design-cloudflare.mdã‚ˆã‚Š*

```sql
CHECK (battle_type IN ('ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ', 'å¯¾æˆ¦å°', 'ãƒ­ãƒ“ãƒ¼å¤§ä¼š'))
CHECK (rank IN ('ã‚µãƒ•ã‚¡ã‚¤ã‚¢', 'ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰', 'ãƒ«ãƒ“ãƒ¼', 'ãƒˆãƒ‘ãƒ¼ã‚º', '-'))
CHECK (turn IN ('å…ˆæ”»', 'å¾Œæ”»'))
CHECK (result IN ('å‹ã¡', 'è² ã‘'))
```

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ¶ç´„ ğŸ”µ *architecture-cloudflare.mdã‚ˆã‚Š*

- Cloudflare Workers V8 Isolatesç’°å¢ƒã§ã®å‹•ä½œ
- Hono ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä½¿ç”¨
- Cloudflare D1ï¼ˆSQLiteï¼‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½¿ç”¨
- Zod ã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- D1 batch APIã‚’ä½¿ç”¨ã—ãŸä¸€æ‹¬INSERT

---

## 4. æƒ³å®šã•ã‚Œã‚‹ä½¿ç”¨ä¾‹ï¼ˆEARSEdgeã‚±ãƒ¼ã‚¹ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼‰

### åŸºæœ¬çš„ãªä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ ğŸ”µ *REQ-035ã‚ˆã‚Š*

1. **JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ãƒ­ãƒ¼**
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ï¼ˆformat: "json"ï¼‰
   - JSONæ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹
   - å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’Zodã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - D1ã«ä¸€æ‹¬INSERTï¼ˆINSERT OR IGNOREï¼‰
   - ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœã‚’è¿”å´

2. **CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ãƒ­ãƒ¼**
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ï¼ˆformat: "csv"ï¼‰
   - CSVã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ + ãƒ‡ãƒ¼ã‚¿è¡Œï¼‰
   - å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’Zodã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - D1ã«ä¸€æ‹¬INSERTï¼ˆINSERT OR IGNOREï¼‰
   - ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœã‚’è¿”å´

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ ğŸŸ¡ *EDGE-xxx, è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

| ã‚±ãƒ¼ã‚¹ | æœŸå¾…å‹•ä½œ |
|---|---|
| ç©ºã®JSONãƒ‡ãƒ¼ã‚¿ï¼ˆ`[]`ï¼‰ | æˆåŠŸï¼ˆimported: 0ï¼‰ |
| ç©ºã®CSVãƒ‡ãƒ¼ã‚¿ | 400 Bad Requestï¼ˆCSVãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ï¼‰ |
| ä¸æ­£ãªJSONå½¢å¼ | 400 Bad Requestï¼ˆJSONå½¢å¼ãŒä¸æ­£ã§ã™ï¼‰ |
| CSVãƒ˜ãƒƒãƒ€ãƒ¼ä¸è¶³ | 400 Bad Requestï¼ˆå¿…é ˆãƒ˜ãƒƒãƒ€ãƒ¼ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼‰ |
| æœªæ¥æ—¥ä»˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ | ãã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚¨ãƒ©ãƒ¼ã€ä»–ã¯æˆåŠŸ |
| é‡è¤‡ID | INSERT OR IGNOREã§ã‚¹ã‚­ãƒƒãƒ— |
| ä¸æ­£ãªEnumå€¤ | ãã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚¨ãƒ©ãƒ¼ã€ä»–ã¯æˆåŠŸ |
| 1000ä»¶ä»¥ä¸Šã®å¤§é‡ãƒ‡ãƒ¼ã‚¿ | æ­£å¸¸å‡¦ç†ï¼ˆD1 batchã§åŠ¹ç‡çš„ã«å‡¦ç†ï¼‰ |

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ ğŸŸ¡ *EDGE-001, EDGE-002ã‚ˆã‚Š*

| ã‚±ãƒ¼ã‚¹ | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ |
|---|---|---|
| formatæœªæŒ‡å®š | 400 | INVALID_REQUEST |
| dataæœªæŒ‡å®š | 400 | INVALID_REQUEST |
| ä¸æ­£ãªformatå€¤ | 400 | INVALID_FORMAT |
| JSONå½¢å¼ã‚¨ãƒ©ãƒ¼ | 400 | INVALID_FORMAT |
| CSVãƒ˜ãƒƒãƒ€ãƒ¼ä¸è¶³ | 400 | INVALID_FORMAT |
| D1æ¥ç¶šã‚¨ãƒ©ãƒ¼ | 500 | INTERNAL_ERROR |

---

## 5. EARSè¦ä»¶ãƒ»è¨­è¨ˆæ–‡æ›¸ã¨ã®å¯¾å¿œé–¢ä¿‚

### å‚ç…§ã—ãŸãƒ¦ãƒ¼ã‚¶ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

- US-035: æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸã„

### å‚ç…§ã—ãŸæ©Ÿèƒ½è¦ä»¶

| è¦ä»¶ID | å†…å®¹ | å¯¾å¿œAPI |
|---|---|---|
| REQ-035 | JSON/CSVå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ | POST /api/import |

### å‚ç…§ã—ãŸéæ©Ÿèƒ½è¦ä»¶

| è¦ä»¶ID | å†…å®¹ |
|---|---|
| NFR-001 | ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚é–“3ç§’ä»¥å†… |
| NFR-003 | 1,000ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¿«é©ã«å‡¦ç† |
| NFR-103 | ã™ã¹ã¦ã®å¤–éƒ¨å…¥åŠ›ã«å¯¾ã—ã¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
| NFR-301 | TypeScript strict mode |

### å‚ç…§ã—ãŸè¨­è¨ˆæ–‡æ›¸

| æ–‡æ›¸ | å‚ç…§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ |
|---|---|
| api-endpoints-cloudflare.md | 4. ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆ4.1ï¼‰ |
| cloudflare-migration-phase2-part3-i.md | TASK-0031 |

---

## 6. å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ import.ts           # ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢é€£å‹å®šç¾©
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ parser.ts           # JSON/CSVãƒ‘ãƒ¼ã‚µãƒ¼
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ importService.ts    # ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚µãƒ¼ãƒ“ã‚¹ï¼ˆD1ç‰ˆï¼‰
â”‚   â””â”€â”€ routes/
â”‚       â””â”€â”€ import.ts           # ã‚¤ãƒ³ãƒãƒ¼ãƒˆAPIãƒ«ãƒ¼ãƒˆ
â””â”€â”€ tests/
    â”œâ”€â”€ utils/
    â”‚   â””â”€â”€ parser.test.ts
    â”œâ”€â”€ services/
    â”‚   â””â”€â”€ importService.test.ts
    â””â”€â”€ routes/
        â””â”€â”€ import.test.ts
```

---

## 7. å“è³ªåˆ¤å®š

### âœ… é«˜å“è³ª

- **è¦ä»¶ã®æ›–æ˜§ã•**: ãªã—ï¼ˆEARSè¦ä»¶ãƒ»è¨­è¨ˆæ–‡æ›¸ã‹ã‚‰æ˜ç¢ºï¼‰
- **å…¥å‡ºåŠ›å®šç¾©**: å®Œå…¨ï¼ˆå‹å®šç¾©ãƒ»APIä»•æ§˜ãŒæ˜ç¢ºï¼‰
- **åˆ¶ç´„æ¡ä»¶**: æ˜ç¢ºï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»DBåˆ¶ç´„ãŒå®šç¾©æ¸ˆã¿ï¼‰
- **å®Ÿè£…å¯èƒ½æ€§**: ç¢ºå®Ÿï¼ˆè¨­è¨ˆæ–‡æ›¸ã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚ã‚Šï¼‰

---

## 8. æ›´æ–°å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|---|---|---|
| 1.0.0 | 2025-11-30 | åˆç‰ˆä½œæˆ |

---

**æ¬¡ã®ãŠå‹§ã‚ã‚¹ãƒ†ãƒƒãƒ—**: `/tdd-testcases` ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æ´—ã„å‡ºã—ã‚’è¡Œã„ã¾ã™ã€‚
