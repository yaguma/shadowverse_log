# TASK-0031: インポートAPI実装 - テストケース一覧

## 概要

インポートAPI実装のためのテストケース一覧。

**作成日**: 2025-11-30
**タスクID**: TASK-0031
**要件定義書**: [import-api-requirements.md](./import-api-requirements.md)

---

## テストケース一覧

### 1. パーサーテスト（utils/parser.test.ts）

#### 1.1 JSON パーサー

| TC-ID | テストケース名 | 入力 | 期待結果 | 優先度 |
|---|---|---|---|---|
| TC-001 | 正常系: 単一オブジェクトJSONをパースできる | 有効なJSON（1件） | BattleLog配列（1件） | 高 |
| TC-002 | 正常系: 配列JSONをパースできる | 有効なJSON配列（3件） | BattleLog配列（3件） | 高 |
| TC-003 | 正常系: 空配列をパースできる | `[]` | 空配列 | 中 |
| TC-004 | 異常系: 不正なJSON形式でエラー | `{invalid json}` | Error: JSON形式が不正です | 高 |
| TC-005 | 異常系: null値でエラー | `null` | Error: JSONデータは配列である必要があります | 中 |
| TC-006 | 異常系: オブジェクトでエラー | `{}` | Error: JSONデータは配列である必要があります | 中 |

#### 1.2 CSV パーサー

| TC-ID | テストケース名 | 入力 | 期待結果 | 優先度 |
|---|---|---|---|---|
| TC-007 | 正常系: 有効なCSVをパースできる | 有効なCSV（ヘッダー+3行） | BattleLog配列（3件） | 高 |
| TC-008 | 正常系: ヘッダーのみのCSVをパースできる | ヘッダー行のみ | 空配列 | 中 |
| TC-009 | 異常系: 空文字列でエラー | `` | Error: CSVデータが空です | 高 |
| TC-010 | 異常系: ヘッダー不足でエラー | 一部ヘッダーのみ | Error: 必須ヘッダーが不足しています | 高 |
| TC-011 | 異常系: カラム数不一致でエラー情報を返す | カラム数が異なる行 | エラー詳細にカラム不一致情報 | 中 |
| TC-012 | 正常系: 空白行をスキップできる | 空白行を含むCSV | 空白行を除いた配列 | 中 |

---

### 2. インポートサービステスト（services/importService.test.ts）

#### 2.1 JSON インポート

| TC-ID | テストケース名 | 入力 | 期待結果 | 優先度 |
|---|---|---|---|---|
| TC-013 | 正常系: JSON形式のデータをインポートできる | 有効なJSON（3件） | imported: 3, skipped: 0 | 高 |
| TC-014 | 正常系: 重複IDはスキップされる | 重複IDを含むJSON | imported: 2, skipped: 1 | 高 |
| TC-015 | 正常系: IDなしのレコードは自動生成される | ID省略のJSON | imported: 1（ID自動生成） | 高 |
| TC-016 | 異常系: バリデーションエラーのレコードはカウントされる | 不正データ含むJSON | errors > 0 | 高 |
| TC-017 | 正常系: 空配列でも成功 | `[]` | imported: 0, skipped: 0 | 中 |

#### 2.2 CSV インポート

| TC-ID | テストケース名 | 入力 | 期待結果 | 優先度 |
|---|---|---|---|---|
| TC-018 | 正常系: CSV形式のデータをインポートできる | 有効なCSV（3件） | imported: 3, skipped: 0 | 高 |
| TC-019 | 正常系: 重複IDはスキップされる | 重複IDを含むCSV | imported: 2, skipped: 1 | 中 |
| TC-020 | 異常系: バリデーションエラーのレコードはカウントされる | 未来日付含むCSV | errors > 0 | 高 |

#### 2.3 バリデーション

| TC-ID | テストケース名 | 入力 | 期待結果 | 優先度 |
|---|---|---|---|---|
| TC-021 | 異常系: 未来日付はエラー | 未来の日付 | エラー詳細に日付エラー | 高 |
| TC-022 | 異常系: 不正な対戦タイプはエラー | "不正な対戦タイプ" | エラー詳細に対戦タイプエラー | 高 |
| TC-023 | 異常系: 必須フィールド未入力はエラー | myDeckId省略 | エラー詳細に必須エラー | 高 |
| TC-024 | 異常系: 日付形式不正はエラー | "2025/01/24" | エラー詳細に日付形式エラー | 中 |

---

### 3. インポートAPIルートテスト（routes/import.test.ts）

#### 3.1 リクエストバリデーション

| TC-ID | テストケース名 | 入力 | 期待結果 | 優先度 |
|---|---|---|---|---|
| TC-025 | 異常系: format未指定で400エラー | format省略 | 400, INVALID_REQUEST | 高 |
| TC-026 | 異常系: data未指定で400エラー | data省略 | 400, INVALID_REQUEST | 高 |
| TC-027 | 異常系: 不正なformat値で400エラー | format: "xml" | 400, INVALID_FORMAT | 高 |
| TC-028 | 正常系: format=jsonで成功 | format: "json", 有効データ | 200, success: true | 高 |
| TC-029 | 正常系: format=csvで成功 | format: "csv", 有効データ | 200, success: true | 高 |

#### 3.2 レスポンス形式

| TC-ID | テストケース名 | 入力 | 期待結果 | 優先度 |
|---|---|---|---|---|
| TC-030 | 正常系: 成功レスポンスに必要なフィールドが含まれる | 有効なリクエスト | success, data.imported, data.skipped, meta | 高 |
| TC-031 | 異常系: エラーレスポンスに必要なフィールドが含まれる | 不正なリクエスト | success: false, error.code, error.message, meta | 高 |
| TC-032 | 正常系: metaにtimestampとrequestIdが含まれる | 有効なリクエスト | meta.timestamp, meta.requestId | 中 |

#### 3.3 エラーハンドリング

| TC-ID | テストケース名 | 入力 | 期待結果 | 優先度 |
|---|---|---|---|---|
| TC-033 | 異常系: JSON形式エラーで400エラー | format: "json", 不正JSON | 400, INVALID_FORMAT | 高 |
| TC-034 | 異常系: CSVヘッダー不足で400エラー | format: "csv", ヘッダー不足 | 400, INVALID_FORMAT | 高 |
| TC-035 | 異常系: D1エラーで500エラー | D1接続失敗 | 500, INTERNAL_ERROR | 中 |

---

### 4. 統合テスト（integration/import.test.ts）

| TC-ID | テストケース名 | 入力 | 期待結果 | 優先度 |
|---|---|---|---|---|
| TC-036 | E2E: JSONインポート後にデータが取得できる | JSON → GET | インポートしたデータが取得可能 | 高 |
| TC-037 | E2E: CSVインポート後にデータが取得できる | CSV → GET | インポートしたデータが取得可能 | 高 |
| TC-038 | E2E: 大量データ（100件）をインポートできる | 100件のJSON | 全件インポート成功 | 中 |
| TC-039 | E2E: 部分成功でもエラー件数が返る | 一部不正データ | imported + errors = 総件数 | 中 |

---

## テストケース優先度別サマリー

| 優先度 | 件数 | 説明 |
|---|---|---|
| 高 | 25 | 必須テスト（リリースブロッカー） |
| 中 | 14 | 推奨テスト（品質向上） |
| **合計** | **39** | - |

---

## テスト実装順序

### Phase 1: 単体テスト（パーサー）
1. TC-001 〜 TC-006: JSONパーサー
2. TC-007 〜 TC-012: CSVパーサー

### Phase 2: 単体テスト（サービス）
3. TC-013 〜 TC-017: JSONインポート
4. TC-018 〜 TC-020: CSVインポート
5. TC-021 〜 TC-024: バリデーション

### Phase 3: 単体テスト（ルート）
6. TC-025 〜 TC-029: リクエストバリデーション
7. TC-030 〜 TC-032: レスポンス形式
8. TC-033 〜 TC-035: エラーハンドリング

### Phase 4: 統合テスト
9. TC-036 〜 TC-039: E2Eテスト

---

## 更新履歴

| バージョン | 日付 | 変更内容 |
|---|---|---|
| 1.0.0 | 2025-11-30 | 初版作成 |

---

**次のお勧めステップ**: `/tdd-red` で失敗するテストを実装します。
