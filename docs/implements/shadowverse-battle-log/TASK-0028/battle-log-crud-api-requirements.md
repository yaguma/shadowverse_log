# TASK-0028: å¯¾æˆ¦å±¥æ­´CRUD APIå®Ÿè£… - è¦ä»¶å®šç¾©æ›¸

## æ¦‚è¦

Cloudflare Workersä¸Šã§Honoãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ãŸå¯¾æˆ¦å±¥æ­´CRUD APIã®å®Ÿè£…ã€‚D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã€Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã™ã‚‹ã€‚

**ä½œæˆæ—¥**: 2025-11-30
**ã‚¿ã‚¹ã‚¯ID**: TASK-0028
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 10æ™‚é–“

---

## 1. æ©Ÿèƒ½ã®æ¦‚è¦ï¼ˆEARSè¦ä»¶å®šç¾©æ›¸ãƒ»è¨­è¨ˆæ–‡æ›¸ãƒ™ãƒ¼ã‚¹ï¼‰

- ğŸ”µ **æ©Ÿèƒ½æ¦‚è¦**: å¯¾æˆ¦å±¥æ­´ã®ä½œæˆï¼ˆPOSTï¼‰ã€å–å¾—ï¼ˆGETï¼‰ã€å‰Šé™¤ï¼ˆDELETEï¼‰ã‚’æä¾›ã™ã‚‹REST API
- ğŸ”µ **è§£æ±ºã™ã‚‹å•é¡Œ**: å¯¾æˆ¦å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã¨CRUDæ“ä½œã‚’æä¾›ã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿æ“ä½œã‚’å¯èƒ½ã«ã™ã‚‹
- ğŸ”µ **æƒ³å®šãƒ¦ãƒ¼ã‚¶ãƒ¼**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆReact SPAï¼‰
- ğŸ”µ **ã‚·ã‚¹ãƒ†ãƒ å†…ã§ã®ä½ç½®ã¥ã‘**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆCloudflare Workersï¼‰
- **å‚ç…§ã—ãŸEARSè¦ä»¶**: REQ-001, REQ-002, REQ-009, REQ-010
- **å‚ç…§ã—ãŸè¨­è¨ˆæ–‡æ›¸**:
  - api-endpoints-cloudflare.mdï¼ˆAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜ï¼‰
  - architecture-cloudflare.mdï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆï¼‰
  - storage-design-cloudflare.mdï¼ˆD1ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆï¼‰

---

## 2. å…¥åŠ›ãƒ»å‡ºåŠ›ã®ä»•æ§˜ï¼ˆEARSæ©Ÿèƒ½è¦ä»¶ãƒ»TypeScriptå‹å®šç¾©ãƒ™ãƒ¼ã‚¹ï¼‰

### 2.1 å‹å®šç¾©

#### BattleLogå‹ ğŸ”µ *æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒ»è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

```typescript
export type BattleType = 'ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ' | 'å¯¾æˆ¦å°' | 'ãƒ­ãƒ“ãƒ¼å¤§ä¼š'
export type Rank = 'ã‚µãƒ•ã‚¡ã‚¤ã‚¢' | 'ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰' | 'ãƒ«ãƒ“ãƒ¼' | 'ãƒˆãƒ‘ãƒ¼ã‚º' | '-'
export type Group = 'A' | 'AA' | 'AAA' | 'Master' | '-'
export type Turn = 'å…ˆæ”»' | 'å¾Œæ”»'
export type BattleResult = 'å‹ã¡' | 'è² ã‘'

export interface BattleLog {
  id: string
  date: string           // YYYY-MM-DDå½¢å¼
  battleType: BattleType
  rank: Rank
  group: Group
  myDeckId: string
  turn: Turn
  result: BattleResult
  opponentDeckId: string
  createdAt?: string
  updatedAt?: string
}
```

#### CreateBattleLogRequestå‹ ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

```typescript
export interface CreateBattleLogRequest {
  date?: string           // çœç•¥æ™‚ã¯ä»Šæ—¥ã®æ—¥ä»˜
  battleType: BattleType
  rank: Rank
  group: Group
  myDeckId: string
  turn: Turn
  result: BattleResult
  opponentDeckId: string
}
```

### 2.2 APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### GET /api/battle-logs ğŸ”µ *REQ-009, api-endpoints-cloudflare.mdã‚ˆã‚Š*

**èª¬æ˜**: å¯¾æˆ¦å±¥æ­´ä¸€è¦§å–å¾—

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `limit` | number | No | 100 | å–å¾—ä»¶æ•°ï¼ˆæœ€å¤§1000ï¼‰ |
| `offset` | number | No | 0 | ã‚¹ã‚­ãƒƒãƒ—ä»¶æ•° |
| `sortBy` | string | No | "date" | ã‚½ãƒ¼ãƒˆã‚­ãƒ¼ |
| `sortOrder` | "asc" \| "desc" | No | "desc" | ã‚½ãƒ¼ãƒˆé † |

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": {
    "battleLogs": [...],
    "total": 84,
    "limit": 100,
    "offset": 0
  },
  "meta": {
    "timestamp": "2025-01-24T12:34:56.789Z",
    "requestId": "uuid-v4"
  }
}
```

#### POST /api/battle-logs ğŸ”µ *REQ-001, REQ-002, api-endpoints-cloudflare.mdã‚ˆã‚Š*

**èª¬æ˜**: å¯¾æˆ¦å±¥æ­´ç™»éŒ²

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**: `CreateBattleLogRequest`

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹** (201 Created):
```json
{
  "success": true,
  "data": {
    "battleLog": {...}
  },
  "meta": {
    "timestamp": "2025-01-24T12:34:56.789Z",
    "requestId": "uuid-v4"
  }
}
```

#### DELETE /api/battle-logs/:id ğŸ”µ *REQ-010, api-endpoints-cloudflare.mdã‚ˆã‚Š*

**èª¬æ˜**: å¯¾æˆ¦å±¥æ­´å‰Šé™¤

**ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**: `id` - å‰Šé™¤å¯¾è±¡ã®å¯¾æˆ¦å±¥æ­´ID

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹** (200 OK):
```json
{
  "success": true,
  "data": { "deletedId": "log_xxx" },
  "meta": {
    "timestamp": "2025-01-24T12:34:56.789Z",
    "requestId": "uuid-v4"
  }
}
```

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹** (404 Not Found):
```json
{
  "success": false,
  "error": {
    "code": "BATTLE_LOG_NOT_FOUND",
    "message": "æŒ‡å®šã•ã‚ŒãŸå¯¾æˆ¦å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
  },
  "meta": {...}
}
```

---

## 3. åˆ¶ç´„æ¡ä»¶ï¼ˆEARSéæ©Ÿèƒ½è¦ä»¶ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆãƒ™ãƒ¼ã‚¹ï¼‰

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ ğŸ”µ *api-endpoints-cloudflare.mdã‚ˆã‚Š*

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ç›®æ¨™ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  |
|---|---|
| GET /api/battle-logs | < 100ms |
| POST /api/battle-logs | < 50ms |
| DELETE /api/battle-logs/:id | < 50ms |

### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¦ä»¶ ğŸ”µ *REQ-401, REQ-402ã‚ˆã‚Š*

- æ—¥ä»˜ã¯`YYYY-MM-DD`å½¢å¼ã§ã‚ã‚‹ã“ã¨
- æœªæ¥ã®æ—¥ä»˜ã¯å…¥åŠ›ä¸å¯
- ã™ã¹ã¦ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å…¥åŠ›å¿…é ˆ
- Enumå€¤ã¯å®šç¾©ã•ã‚ŒãŸå€¤ã®ã¿è¨±å¯

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ ğŸ”µ *storage-design-cloudflare.mdã‚ˆã‚Š*

```sql
CHECK (battle_type IN ('ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ', 'å¯¾æˆ¦å°', 'ãƒ­ãƒ“ãƒ¼å¤§ä¼š'))
CHECK (rank IN ('ã‚µãƒ•ã‚¡ã‚¤ã‚¢', 'ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰', 'ãƒ«ãƒ“ãƒ¼', 'ãƒˆãƒ‘ãƒ¼ã‚º', '-'))
CHECK (turn IN ('å…ˆæ”»', 'å¾Œæ”»'))
CHECK (result IN ('å‹ã¡', 'è² ã‘'))
```

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ¶ç´„ ğŸ”µ *architecture-cloudflare.mdã‚ˆã‚Š*

- Cloudflare Workers V8 Isolatesç’°å¢ƒã§ã®å‹•ä½œ
- Hono ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä½¿ç”¨
- Cloudflare D1ï¼ˆSQLiteï¼‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½¿ç”¨
- Zod ã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

---

## 4. æƒ³å®šã•ã‚Œã‚‹ä½¿ç”¨ä¾‹ï¼ˆEARSEdgeã‚±ãƒ¼ã‚¹ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼‰

### åŸºæœ¬çš„ãªä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ ğŸ”µ *REQ-001, REQ-002ã‚ˆã‚Š*

1. **å¯¾æˆ¦å±¥æ­´ç™»éŒ²ãƒ•ãƒ­ãƒ¼**
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
   - Zodã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - D1ã«INSERT
   - ä½œæˆã•ã‚ŒãŸå¯¾æˆ¦å±¥æ­´ã‚’è¿”å´

2. **å¯¾æˆ¦å±¥æ­´ä¸€è¦§å–å¾—ãƒ•ãƒ­ãƒ¼**
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰GETãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
   - D1ã‹ã‚‰SELECTï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
   - ä¸€è¦§ã¨ç·ä»¶æ•°ã‚’è¿”å´

3. **å¯¾æˆ¦å±¥æ­´å‰Šé™¤ãƒ•ãƒ­ãƒ¼**
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰DELETEãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
   - D1ã‹ã‚‰DELETE
   - å‰Šé™¤çµæœã‚’è¿”å´

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ ğŸŸ¡ *EDGE-xxx, api-endpoints-cloudflare.mdã‚ˆã‚Š*

| ã‚±ãƒ¼ã‚¹ | æœŸå¾…å‹•ä½œ |
|---|---|
| æœªæ¥æ—¥ä»˜ã®ç™»éŒ² | 400 Bad Request + ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æœªå…¥åŠ› | 400 Bad Request + ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| ä¸æ­£ãªEnumå€¤ | 400 Bad Request + ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| å­˜åœ¨ã—ãªã„IDã®å‰Šé™¤ | 404 Not Found |
| ãƒ‡ãƒ¼ã‚¿0ä»¶æ™‚ã®ä¸€è¦§å–å¾— | ç©ºé…åˆ—ã‚’è¿”å´ï¼ˆtotal: 0ï¼‰ |

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ ğŸŸ¡ *EDGE-001, EDGE-002ã‚ˆã‚Š*

| ã‚±ãƒ¼ã‚¹ | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ |
|---|---|---|
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ | 400 | VALIDATION_ERROR |
| ãƒªã‚½ãƒ¼ã‚¹æœªç™ºè¦‹ | 404 | BATTLE_LOG_NOT_FOUND |
| D1æ¥ç¶šã‚¨ãƒ©ãƒ¼ | 500 | INTERNAL_ERROR |

---

## 5. EARSè¦ä»¶ãƒ»è¨­è¨ˆæ–‡æ›¸ã¨ã®å¯¾å¿œé–¢ä¿‚

### å‚ç…§ã—ãŸãƒ¦ãƒ¼ã‚¶ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

- US-001: å¯¾æˆ¦å±¥æ­´ã‚’ç™»éŒ²ã—ãŸã„
- US-002: å¯¾æˆ¦å±¥æ­´ã‚’ä¸€è¦§è¡¨ç¤ºã—ãŸã„
- US-003: å¯¾æˆ¦å±¥æ­´ã‚’å‰Šé™¤ã—ãŸã„

### å‚ç…§ã—ãŸæ©Ÿèƒ½è¦ä»¶

| è¦ä»¶ID | å†…å®¹ | å¯¾å¿œAPI |
|---|---|---|
| REQ-001 | ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å½¢å¼ã§å¯¾æˆ¦å±¥æ­´ã®æ–°è¦ç™»éŒ²æ©Ÿèƒ½ã‚’æä¾› | POST /api/battle-logs |
| REQ-002 | 8é …ç›®ã‚’å¯¾æˆ¦å±¥æ­´ã¨ã—ã¦è¨˜éŒ² | POST /api/battle-logs |
| REQ-009 | å¯¾æˆ¦å±¥æ­´ã‚’ä¸€è¦§å½¢å¼ã§è¡¨ç¤º | GET /api/battle-logs |
| REQ-010 | ä¸€è¦§ã‹ã‚‰å„å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½ | DELETE /api/battle-logs/:id |

### å‚ç…§ã—ãŸéæ©Ÿèƒ½è¦ä»¶

| è¦ä»¶ID | å†…å®¹ |
|---|---|
| NFR-001 | ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚é–“3ç§’ä»¥å†… |
| NFR-003 | 1,000ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¿«é©ã«å‡¦ç† |
| NFR-103 | ã™ã¹ã¦ã®å¤–éƒ¨å…¥åŠ›ã«å¯¾ã—ã¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
| NFR-301 | TypeScript strict mode |

### å‚ç…§ã—ãŸEdgeã‚±ãƒ¼ã‚¹

| ã‚±ãƒ¼ã‚¹ID | å†…å®¹ |
|---|---|
| EDGE-001 | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| EDGE-002 | D1æ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç† |
| EDGE-101 | å¯¾æˆ¦å±¥æ­´0ä»¶ã®å ´åˆã®è¡¨ç¤º |

### å‚ç…§ã—ãŸè¨­è¨ˆæ–‡æ›¸

| æ–‡æ›¸ | å‚ç…§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ |
|---|---|
| api-endpoints-cloudflare.md | 1. å¯¾æˆ¦å±¥æ­´ç®¡ç†ï¼ˆ1.1-1.3ï¼‰ |
| architecture-cloudflare.md | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆã€ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ |
| storage-design-cloudflare.md | D1ã‚¹ã‚­ãƒ¼ãƒã€CRUDæ“ä½œä¾‹ |

---

## 6. å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
workers/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ battleLog.ts        # å‹å®šç¾©
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ validation.ts       # Zodã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ battleLogService.ts # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â””â”€â”€ routes/
â”‚       â””â”€â”€ battle-logs.ts      # APIãƒ«ãƒ¼ãƒˆ
â””â”€â”€ tests/
    â”œâ”€â”€ services/
    â”‚   â””â”€â”€ battleLogService.test.ts
    â””â”€â”€ routes/
        â””â”€â”€ battle-logs.test.ts
```

---

## 7. å“è³ªåˆ¤å®š

### âœ… é«˜å“è³ª

- **è¦ä»¶ã®æ›–æ˜§ã•**: ãªã—ï¼ˆEARSè¦ä»¶ãƒ»è¨­è¨ˆæ–‡æ›¸ã‹ã‚‰æ˜ç¢ºï¼‰
- **å…¥å‡ºåŠ›å®šç¾©**: å®Œå…¨ï¼ˆå‹å®šç¾©ãƒ»APIä»•æ§˜ãŒæ˜ç¢ºï¼‰
- **åˆ¶ç´„æ¡ä»¶**: æ˜ç¢ºï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»DBåˆ¶ç´„ãŒå®šç¾©æ¸ˆã¿ï¼‰
- **å®Ÿè£…å¯èƒ½æ€§**: ç¢ºå®Ÿï¼ˆè¨­è¨ˆæ–‡æ›¸ã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚ã‚Šï¼‰

---

## 8. æ›´æ–°å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|---|---|---|
| 1.0.0 | 2025-11-30 | åˆç‰ˆä½œæˆ |

---

**æ¬¡ã®ãŠå‹§ã‚ã‚¹ãƒ†ãƒƒãƒ—**: `/tdd-testcases` ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æ´—ã„å‡ºã—ã‚’è¡Œã„ã¾ã™ã€‚
