# TASK-0028: 対戦履歴CRUD API実装 - テストケース定義書

## 概要

Cloudflare Workers上でHonoフレームワークを使用した対戦履歴CRUD APIのテストケース定義。

**作成日**: 2025-11-30
**タスクID**: TASK-0028
**参照要件定義書**: [battle-log-crud-api-requirements.md](./battle-log-crud-api-requirements.md)

---

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript 5.7+
  - **言語選択の理由**: tech-stack.mdで定義済み、型安全性を確保
  - **テストに適した機能**: 型推論によるテストデータの安全性確保
- **テストフレームワーク**: Vitest 2.x
  - **フレームワーク選択の理由**: package.jsonで定義済み、Vite/Honoとの親和性が高い
  - **テスト実行環境**: Node.js + Miniflare（Cloudflare Workers互換環境）
- 🔵 信頼性レベル: 青信号（tech-stack.md、workers/package.jsonより）

---

## テストカテゴリ

### カテゴリ1: BattleLogService 単体テスト

サービス層のビジネスロジックをテスト

### カテゴリ2: APIルート 統合テスト

Honoルートハンドラの動作をテスト

### カテゴリ3: Zodバリデーション テスト

入力バリデーションの動作をテスト

---

## 1. 正常系テストケース（基本的な動作）

### TC-001: 対戦履歴の正常登録（全項目指定）

- **テスト名**: 必須項目をすべて指定した対戦履歴が正しく作成される
  - **何をテストするか**: POST /api/battle-logs が有効な8項目のデータを受け取り、D1に保存してレスポンスを返すこと
  - **期待される動作**: バリデーション成功 → UUID生成 → D1にINSERT → 201レスポンス返却
- **入力値**:
  ```json
  {
    "date": "2025-01-24",
    "battleType": "ランクマッチ",
    "rank": "ダイアモンド",
    "group": "AAA",
    "myDeckId": "deck_001",
    "turn": "先攻",
    "result": "勝ち",
    "opponentDeckId": "deck_master_002"
  }
  ```
  - **入力データの意味**: 典型的なランクマッチの対戦結果
- **期待される結果**:
  - HTTPステータス: 201 Created
  - レスポンスボディ: `{ success: true, data: { battleLog: {...} }, meta: {...} }`
  - battleLog.id: UUID形式
  - battleLog.date: "2025-01-24"
- **テストの目的**: REQ-001, REQ-002（対戦履歴の新規登録）の確認
- 🔵 信頼性レベル: 青信号（api-endpoints-cloudflare.md、requirements.mdより）

---

### TC-002: 日付省略時に今日の日付が自動設定される

- **テスト名**: dateフィールド省略時に今日の日付が自動補完される
  - **何をテストするか**: dateフィールドなしでPOSTリクエストを送信した場合、今日の日付がデフォルト値として設定されること
  - **期待される動作**: Zodスキーマのデフォルト値処理により今日の日付が補完される
- **入力値**:
  ```json
  {
    "battleType": "対戦台",
    "rank": "ルビー",
    "group": "A",
    "myDeckId": "deck_002",
    "turn": "後攻",
    "result": "負け",
    "opponentDeckId": "deck_master_005"
  }
  ```
  - **入力データの意味**: 対戦直後に日付を入力せずに記録するケース
- **期待される結果**:
  - HTTPステータス: 201 Created
  - battleLog.date: テスト実行日（YYYY-MM-DD形式）
- **テストの目的**: REQ-002（dateフィールドのデフォルト値）の確認
- 🔵 信頼性レベル: 青信号（api-endpoints-cloudflare.mdより）

---

### TC-003: 対戦履歴一覧取得（デフォルトパラメータ）

- **テスト名**: デフォルトパラメータで対戦履歴一覧が取得できる
  - **何をテストするか**: GET /api/battle-logs がクエリパラメータなしで呼び出された場合、デフォルト値（limit=100, offset=0, sortBy=date, sortOrder=desc）で動作すること
  - **期待される動作**: D1からSELECT → 一覧と総件数を返却
- **入力値**: クエリパラメータなし
- **期待される結果**:
  ```json
  {
    "success": true,
    "data": {
      "battleLogs": [...],
      "total": 84,
      "limit": 100,
      "offset": 0
    },
    "meta": {...}
  }
  ```
- **テストの目的**: REQ-009（対戦履歴一覧取得）の確認
- 🔵 信頼性レベル: 青信号（api-endpoints-cloudflare.mdより）

---

### TC-004: 対戦履歴一覧取得（ページネーション）

- **テスト名**: ページネーションパラメータで対戦履歴一覧が取得できる
  - **何をテストするか**: limit, offsetパラメータが正しく適用されること
  - **期待される動作**: 指定されたlimit, offsetでD1クエリが実行される
- **入力値**: `?limit=10&offset=20`
- **期待される結果**:
  - data.limit: 10
  - data.offset: 20
  - data.battleLogs.length: 最大10件
- **テストの目的**: ページネーション機能の確認
- 🟡 信頼性レベル: 黄信号（一般的なAPIページネーションパターンより）

---

### TC-005: 対戦履歴一覧取得（ソート指定）

- **テスト名**: ソートパラメータで対戦履歴一覧の並び順が変わる
  - **何をテストするか**: sortBy, sortOrderパラメータが正しく適用されること
  - **期待される動作**: 指定されたソート条件でD1クエリが実行される
- **入力値**: `?sortBy=date&sortOrder=asc`
- **期待される結果**:
  - data.battleLogs: 日付昇順でソートされている
- **テストの目的**: ソート機能の確認
- 🔵 信頼性レベル: 青信号（api-endpoints-cloudflare.mdより）

---

### TC-006: 対戦履歴の正常削除

- **テスト名**: 存在する対戦履歴が正しく削除できる
  - **何をテストするか**: DELETE /api/battle-logs/:id が存在するIDで呼び出された場合、D1から削除して200レスポンスを返すこと
  - **期待される動作**: D1からDELETE → 削除成功 → 200レスポンス返却
- **入力値**: `/api/battle-logs/existing-uuid-123`
- **期待される結果**:
  - HTTPステータス: 200 OK
  - レスポンスボディ: `{ success: true, data: { deletedId: "existing-uuid-123" }, meta: {...} }`
- **テストの目的**: REQ-010（対戦履歴削除）の確認
- 🔵 信頼性レベル: 青信号（api-endpoints-cloudflare.mdより）

---

## 2. 異常系テストケース（エラーハンドリング）

### TC-101: 未来日付の登録エラー

- **テスト名**: 未来の日付を指定した場合にバリデーションエラーが返る
  - **エラーケースの概要**: 未来の日付（明日以降）を指定した対戦履歴の登録
  - **エラー処理の重要性**: データ整合性を保つため、未来の日付は論理的に不正
- **入力値**:
  ```json
  {
    "date": "2099-12-31",
    "battleType": "ランクマッチ",
    "rank": "ダイアモンド",
    "group": "AAA",
    "myDeckId": "deck_001",
    "turn": "先攻",
    "result": "勝ち",
    "opponentDeckId": "deck_master_002"
  }
  ```
  - **不正な理由**: 未来の日付は対戦が発生していないため登録不可
- **期待される結果**:
  - HTTPステータス: 400 Bad Request
  - error.code: "VALIDATION_ERROR"
  - error.message: "未来の日付は入力できません"
- **テストの目的**: REQ-401（未来日付のエラー処理）の確認
- 🔵 信頼性レベル: 青信号（requirements.mdより）

---

### TC-102: 不正な日付形式のエラー

- **テスト名**: 不正な日付形式の場合にバリデーションエラーが返る
  - **エラーケースの概要**: YYYY-MM-DD以外の日付形式
  - **エラー処理の重要性**: 日付形式の統一性を確保
- **入力値**:
  ```json
  {
    "date": "2025/01/24",
    "battleType": "ランクマッチ",
    ...
  }
  ```
  - **不正な理由**: スラッシュ区切りはYYYY-MM-DD形式に違反
- **期待される結果**:
  - HTTPステータス: 400 Bad Request
  - error.code: "VALIDATION_ERROR"
  - error.message: "日付はYYYY-MM-DD形式で入力してください"
- **テストの目的**: 日付形式バリデーションの確認
- 🔵 信頼性レベル: 青信号（requirements.md、タスク定義書より）

---

### TC-103: 必須フィールド未入力エラー（battleType）

- **テスト名**: battleTypeが未入力の場合にバリデーションエラーが返る
  - **エラーケースの概要**: 必須フィールドのbattleTypeを省略
  - **エラー処理の重要性**: REQ-004で全項目必須と定義
- **入力値**:
  ```json
  {
    "date": "2025-01-24",
    "rank": "ダイアモンド",
    "group": "AAA",
    "myDeckId": "deck_001",
    "turn": "先攻",
    "result": "勝ち",
    "opponentDeckId": "deck_master_002"
  }
  ```
- **期待される結果**:
  - HTTPステータス: 400 Bad Request
  - error.code: "VALIDATION_ERROR"
- **テストの目的**: REQ-402（必須項目バリデーション）の確認
- 🔵 信頼性レベル: 青信号（requirements.mdより）

---

### TC-104: 不正なEnum値エラー（battleType）

- **テスト名**: 不正なbattleType値の場合にバリデーションエラーが返る
  - **エラーケースの概要**: 定義されていないbattleType値を指定
  - **エラー処理の重要性**: データ整合性を保つ
- **入力値**:
  ```json
  {
    "date": "2025-01-24",
    "battleType": "フリーマッチ",
    ...
  }
  ```
  - **不正な理由**: "フリーマッチ"は定義されたEnum値に含まれない
- **期待される結果**:
  - HTTPステータス: 400 Bad Request
  - error.code: "VALIDATION_ERROR"
  - error.message: "対戦タイプが不正です"
- **テストの目的**: Enum値バリデーションの確認
- 🔵 信頼性レベル: 青信号（タスク定義書Zodスキーマより）

---

### TC-105: 不正なEnum値エラー（rank）

- **テスト名**: 不正なrank値の場合にバリデーションエラーが返る
  - **エラーケースの概要**: 定義されていないrank値を指定
- **入力値**:
  ```json
  {
    "date": "2025-01-24",
    "battleType": "ランクマッチ",
    "rank": "プラチナ",
    ...
  }
  ```
- **期待される結果**:
  - HTTPステータス: 400 Bad Request
  - error.message: "ランクが不正です"
- **テストの目的**: Enum値バリデーションの確認
- 🔵 信頼性レベル: 青信号（タスク定義書より）

---

### TC-106: 不正なEnum値エラー（turn）

- **テスト名**: 不正なturn値の場合にバリデーションエラーが返る
  - **エラーケースの概要**: 定義されていないturn値を指定
- **入力値**:
  ```json
  {
    "turn": "引き分け",
    ...
  }
  ```
- **期待される結果**:
  - HTTPステータス: 400 Bad Request
  - error.message: "ターンが不正です"
- **テストの目的**: Enum値バリデーションの確認
- 🔵 信頼性レベル: 青信号（タスク定義書より）

---

### TC-107: 不正なEnum値エラー（result）

- **テスト名**: 不正なresult値の場合にバリデーションエラーが返る
  - **エラーケースの概要**: 定義されていないresult値を指定
- **入力値**:
  ```json
  {
    "result": "引き分け",
    ...
  }
  ```
- **期待される結果**:
  - HTTPステータス: 400 Bad Request
  - error.message: "対戦結果が不正です"
- **テストの目的**: Enum値バリデーションの確認
- 🔵 信頼性レベル: 青信号（タスク定義書より）

---

### TC-108: 存在しないIDの削除エラー

- **テスト名**: 存在しない対戦履歴IDを削除しようとした場合に404エラーが返る
  - **エラーケースの概要**: D1に存在しないIDでDELETEリクエスト
  - **エラー処理の重要性**: リソースの存在確認を適切に行う
- **入力値**: `/api/battle-logs/non-existent-uuid`
- **期待される結果**:
  - HTTPステータス: 404 Not Found
  - error.code: "BATTLE_LOG_NOT_FOUND"
  - error.message: "指定された対戦履歴が見つかりません"
- **テストの目的**: 存在しないリソースの削除エラー処理の確認
- 🔵 信頼性レベル: 青信号（api-endpoints-cloudflare.mdより）

---

### TC-109: 空のリクエストボディエラー

- **テスト名**: 空のリクエストボディで登録しようとした場合にエラーが返る
  - **エラーケースの概要**: POSTリクエストにボディがない
- **入力値**: `{}` または空
- **期待される結果**:
  - HTTPステータス: 400 Bad Request
  - error.code: "VALIDATION_ERROR"
- **テストの目的**: 空リクエストのエラー処理の確認
- 🟡 信頼性レベル: 黄信号（一般的なAPIエラーハンドリングより）

---

## 3. 境界値テストケース

### TC-201: 最小値のlimitパラメータ

- **テスト名**: limit=1で対戦履歴一覧が1件だけ取得できる
  - **境界値の意味**: limitの最小有効値
- **入力値**: `?limit=1`
- **期待される結果**:
  - data.battleLogs.length: 1
  - data.limit: 1
- **テストの目的**: 境界値（最小limit）での動作確認
- 🟡 信頼性レベル: 黄信号（境界値テストの一般的なパターンより）

---

### TC-202: 最大値のlimitパラメータ

- **テスト名**: limit=1000で対戦履歴一覧が最大1000件取得できる
  - **境界値の意味**: limitの最大有効値（api-endpoints-cloudflare.mdで定義）
- **入力値**: `?limit=1000`
- **期待される結果**:
  - data.limit: 1000
- **テストの目的**: 境界値（最大limit）での動作確認
- 🔵 信頼性レベル: 青信号（api-endpoints-cloudflare.mdより）

---

### TC-203: limit=0の場合

- **テスト名**: limit=0で空の配列が返る（またはエラー）
  - **境界値の意味**: 0は特殊なケース
- **入力値**: `?limit=0`
- **期待される結果**:
  - data.battleLogs: 空配列
  - または400エラー（実装による）
- **テストの目的**: 境界値（limit=0）での動作確認
- 🟡 信頼性レベル: 黄信号（実装依存のため要確認）

---

### TC-204: データ0件時の一覧取得

- **テスト名**: 対戦履歴が0件の場合に空配列が返る
  - **境界値の意味**: データが存在しない状態
- **入力値**: クエリパラメータなし（データ0件の状態）
- **期待される結果**:
  ```json
  {
    "success": true,
    "data": {
      "battleLogs": [],
      "total": 0,
      "limit": 100,
      "offset": 0
    }
  }
  ```
- **テストの目的**: EDGE-101（データ0件時の動作）の確認
- 🔵 信頼性レベル: 青信号（requirements.mdより）

---

### TC-205: 空文字のmyDeckIdエラー

- **テスト名**: myDeckIdが空文字の場合にバリデーションエラーが返る
  - **境界値の意味**: 空文字は最小長エラー
- **入力値**:
  ```json
  {
    "myDeckId": "",
    ...
  }
  ```
- **期待される結果**:
  - HTTPステータス: 400 Bad Request
  - error.message: "マイデッキIDは必須です"
- **テストの目的**: 空文字バリデーションの確認
- 🔵 信頼性レベル: 青信号（タスク定義書Zodスキーマより）

---

### TC-206: 日付境界値（今日の日付）

- **テスト名**: 今日の日付で対戦履歴が正常に登録できる
  - **境界値の意味**: 有効な日付の最大値（未来日付の直前）
- **入力値**:
  ```json
  {
    "date": "[今日の日付]",
    ...
  }
  ```
- **期待される結果**:
  - HTTPステータス: 201 Created
- **テストの目的**: 日付境界値（今日）での動作確認
- 🔵 信頼性レベル: 青信号（要件定義書より）

---

## テストケースサマリー

### 正常系（6件）

| ID | テスト名 | 対応要件 | 信頼性 |
|----|---------|---------|--------|
| TC-001 | 対戦履歴の正常登録（全項目指定） | REQ-001, REQ-002 | 🔵 |
| TC-002 | 日付省略時に今日の日付が自動設定 | REQ-002 | 🔵 |
| TC-003 | 対戦履歴一覧取得（デフォルトパラメータ） | REQ-009 | 🔵 |
| TC-004 | 対戦履歴一覧取得（ページネーション） | - | 🟡 |
| TC-005 | 対戦履歴一覧取得（ソート指定） | REQ-009 | 🔵 |
| TC-006 | 対戦履歴の正常削除 | REQ-010 | 🔵 |

### 異常系（9件）

| ID | テスト名 | 対応要件 | 信頼性 |
|----|---------|---------|--------|
| TC-101 | 未来日付の登録エラー | REQ-401 | 🔵 |
| TC-102 | 不正な日付形式のエラー | - | 🔵 |
| TC-103 | 必須フィールド未入力エラー（battleType） | REQ-402 | 🔵 |
| TC-104 | 不正なEnum値エラー（battleType） | - | 🔵 |
| TC-105 | 不正なEnum値エラー（rank） | - | 🔵 |
| TC-106 | 不正なEnum値エラー（turn） | - | 🔵 |
| TC-107 | 不正なEnum値エラー（result） | - | 🔵 |
| TC-108 | 存在しないIDの削除エラー | - | 🔵 |
| TC-109 | 空のリクエストボディエラー | - | 🟡 |

### 境界値（6件）

| ID | テスト名 | 対応要件 | 信頼性 |
|----|---------|---------|--------|
| TC-201 | 最小値のlimitパラメータ | - | 🟡 |
| TC-202 | 最大値のlimitパラメータ | - | 🔵 |
| TC-203 | limit=0の場合 | - | 🟡 |
| TC-204 | データ0件時の一覧取得 | EDGE-101 | 🔵 |
| TC-205 | 空文字のmyDeckIdエラー | - | 🔵 |
| TC-206 | 日付境界値（今日の日付） | - | 🔵 |

---

## 品質判定

### ✅ 高品質

- **テストケース分類**: 正常系6件・異常系9件・境界値6件 = 計21件で網羅
- **期待値定義**: 各テストケースの期待値が具体的に定義されている
- **技術選択**: TypeScript + Vitest で確定
- **実装可能性**: 既存のbackendテストパターンを参考に実現可能

---

## 更新履歴

| バージョン | 日付 | 変更内容 |
|---|---|---|
| 1.0.0 | 2025-11-30 | 初版作成 |

---

**次のお勧めステップ**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。
