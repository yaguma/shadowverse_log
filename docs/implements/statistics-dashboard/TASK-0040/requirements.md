# TASK-0040: 認証フロー実装 - 要件定義書

## 概要

Cloudflare Accessを使用した認証フロー（フロントエンドとバックエンドの連携）を実装する。

## 対象要件

| 要件ID | 要件名 | 信頼性 |
|--------|--------|--------|
| REQ-703 | JWTトークン検証 | 🔵 |
| REQ-704 | ユーザーデータ分離 | 🔵 |

## 機能要件

### FR-001: 認証コンテキスト (AuthContext)

フロントエンドで認証状態を管理するReactコンテキストを実装する。

**受け入れ基準**:
- [ ] 認証状態（isAuthenticated）を管理できる
- [ ] ユーザー情報（id, email）を保持できる
- [ ] login関数でCloudflare Accessログインページにリダイレクトできる
- [ ] logout関数でログアウト処理ができる
- [ ] getToken関数でCF-AuthorizationクッキーからJWTを取得できる

**🔵 信頼性レベル: 青信号（タスクファイルの設計に基づく）**

### FR-002: ログインボタンコンポーネント

認証状態に応じてログイン/ログアウトボタンを表示するコンポーネント。

**受け入れ基準**:
- [ ] 未認証時: ログインボタンを表示
- [ ] 認証済み時: ユーザーメールアドレスとログアウトボタンを表示
- [ ] ボタンクリックで適切なアクションを実行

**🔵 信頼性レベル: 青信号（タスクファイルの設計に基づく）**

### FR-003: Protected Route

認証が必要なルートをガードするコンポーネント。

**受け入れ基準**:
- [ ] 認証済みユーザーのみがアクセスできる
- [ ] 未認証ユーザーは/loginにリダイレクトされる

**🔵 信頼性レベル: 青信号（タスクファイルの設計に基づく）**

### FR-004: API Clientトークン付加

APIリクエスト時にJWTトークンを自動的に付加する。

**受け入れ基準**:
- [ ] CF-Access-JWT-Assertionヘッダーにトークンを付加
- [ ] トークンが取得できない場合はヘッダーを付加しない
- [ ] 401レスポンス時に適切にハンドリングする

**🔵 信頼性レベル: 青信号（タスクファイルの設計に基づく）**

### FR-005: バックエンド認証ミドルウェア有効化

バックエンドで認証ミドルウェアを有効化し、ユーザー識別を行う。

**受け入れ基準**:
- [ ] /api/*エンドポイントで認証を要求
- [ ] 特定パス（/api/health, /api/deck-master等）は認証スキップ
- [ ] 認証済みユーザーのIDをコンテキストに設定

**🔵 信頼性レベル: 青信号（既存実装あり、有効化のみ）**

### FR-006: D1 Databaseユーザー分離

データベースクエリでユーザーIDによるデータ分離を実装する。

**受け入れ基準**:
- [ ] battle_logsテーブルのクエリにuser_id条件を追加
- [ ] 新規データ作成時にuser_idを保存
- [ ] 他ユーザーのデータにアクセスできない

**🔵 信頼性レベル: 青信号（タスクファイルの設計に基づく）**

## 非機能要件

### NFR-001: セキュリティ

- JWTトークンはHTTPSのみで送信
- XSS対策: ReactのCSP設定
- トークンの有効期限チェック

### NFR-002: パフォーマンス

- 認証チェックは非同期で実行
- JWKSはキャッシュして再利用（既存実装済み）

### NFR-003: ユーザビリティ

- 認証状態の変化はリアルタイムでUIに反映
- エラー時は適切なメッセージを表示

## 技術仕様

### フロントエンド

| 項目 | 技術/ライブラリ |
|------|----------------|
| フレームワーク | React 19.x |
| 言語 | TypeScript 5.7+ |
| 状態管理 | React Context API |
| ルーティング | React Router v7 |

### バックエンド

| 項目 | 技術/ライブラリ |
|------|----------------|
| フレームワーク | Hono |
| 言語 | TypeScript |
| JWT検証 | jose |
| 認証 | Cloudflare Access |

## ファイル構成

```
frontend/src/
├── auth/
│   ├── AuthContext.tsx        # 認証コンテキスト
│   ├── AuthContext.test.tsx   # テスト
│   └── index.ts               # エクスポート
├── components/
│   └── auth/
│       ├── LoginButton.tsx       # ログインボタン
│       ├── LoginButton.test.tsx  # テスト
│       ├── ProtectedRoute.tsx    # 保護ルート
│       ├── ProtectedRoute.test.tsx # テスト
│       └── index.ts              # エクスポート
└── api/
    └── client.ts              # API Clientにトークン付加追加

backend/src/
└── index.ts                   # 認証ミドルウェア有効化
```

## 依存関係

- TASK-0039: Cloudflare Access認証設定（完了済み）

## 制約条件

- Cloudflare Accessの無料枠（50ユーザー/月）を使用
- 本番環境でのみ認証を有効化（開発環境ではスキップ可能）
