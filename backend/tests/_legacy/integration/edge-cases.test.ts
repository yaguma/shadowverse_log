/**
 * ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
 *
 * ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯: Jest 29.7.0 + ts-jest
 * ãƒ†ã‚¹ãƒˆå¯¾è±¡: ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã¨å¢ƒç•Œæ¡ä»¶
 *
 * ğŸ”µ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®šç¾©æ›¸: docs/implements/Shadowverse Battle Log - å¯¾æˆ¦å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ /TASK-0013/Shadowverse Battle Log - å¯¾æˆ¦å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ -testcases.md
 * ğŸ”µ è¦ä»¶å®šç¾©æ›¸: docs/implements/Shadowverse Battle Log - å¯¾æˆ¦å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ /TASK-0013/Shadowverse Battle Log - å¯¾æˆ¦å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ -requirements.md
 */

import { BattleLogService } from '../../src/services/battleLogService';
import { ImportService } from '../../src/services/importService';
import { BlobStorageClient } from '../../src/storage/blobStorageClient';

// BlobStorageClient ã®ãƒ¢ãƒƒã‚¯
jest.mock('../../src/storage/blobStorageClient');

describe('ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆ', () => {
  let battleLogService: BattleLogService;
  let importService: ImportService;
  let mockBlobClient: jest.Mocked<BlobStorageClient>;

  // =============================================================================
  // ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  // =============================================================================

  beforeEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ãƒ¢ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ä¸€è²«ã—ãŸãƒ†ã‚¹ãƒˆæ¡ä»¶ã‚’ä¿è¨¼
    // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: å‰ã®ãƒ†ã‚¹ãƒˆã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã€ãƒ¢ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ãƒªã‚»ãƒƒãƒˆ
    jest.clearAllMocks();

    // BlobStorageClient ã®ãƒ¢ãƒƒã‚¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    mockBlobClient = new BlobStorageClient('', '') as jest.Mocked<BlobStorageClient>;

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¢ãƒƒã‚¯å®Ÿè£…
    mockBlobClient.getBattleLogs = jest.fn().mockResolvedValue([]);
    mockBlobClient.saveBattleLogs = jest.fn().mockResolvedValue(undefined);

    // ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    battleLogService = new BattleLogService(mockBlobClient);
    importService = new ImportService(mockBlobClient);
  });

  afterEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã«ãƒ¢ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    // ã€çŠ¶æ…‹å¾©å…ƒã€‘: æ¬¡ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã€ãƒ¢ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
    jest.restoreAllMocks();
  });

  // =============================================================================
  // 1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  // =============================================================================

  describe('TC-EDGE-001: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', () => {
    /**
     * ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³æ™‚ã®å …ç‰¢æ€§ã‚’æ¤œè¨¼
     * ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: Azure Blob Storageæ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
     * ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿæ™‚ã‚‚ã‚·ã‚¹ãƒ†ãƒ ãŒå®‰å…¨ã«å‹•ä½œã™ã‚‹ã“ã¨
     * ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é»„ä¿¡å·ï¼ˆtestcases.md Lines 866-895ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã¯æ¨æ¸¬ï¼‰
     */
    test('Blob Storageæ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™', async () => {
      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹ãƒ¢ãƒƒã‚¯ã‚’è¨­å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: Azure Blob Storageã¸ã®æ¥ç¶šãŒ30ç§’ä»¥ä¸Šã‹ã‹ã‚‹çŠ¶æ…‹ã‚’æ¨¡æ“¬

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ¢ãƒƒã‚¯ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹
      // ã€å‡¦ç†å†…å®¹ã€‘: getBattleLogs() ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã‚ˆã†ã«è¨­å®š
      mockBlobClient.getBattleLogs.mockImplementation(async () => {
        // 30ç§’ä»¥ä¸Šå¾…æ©Ÿã—ã¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’æ¨¡æ“¬ï¼ˆå®Ÿéš›ã«ã¯ã™ãã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ï¼‰
        throw new Error('Request timeout');
      });

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: TIMEOUTã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹

      // TODO: BattleLogService.getBattleLogs() ãƒ¡ã‚½ãƒƒãƒ‰ã¯ç¾åœ¨å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“
      // ã“ã®ãƒ†ã‚¹ãƒˆã¯TypeScriptã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šå¤±æ•—ã—ã¾ã™ï¼ˆRedãƒ•ã‚§ãƒ¼ã‚ºã®ç›®çš„ï¼‰

      // ã€Greenãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…ã™ã¹ãå†…å®¹ã€‘:
      // - BattleLogService.getBattleLogs() ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…
      // - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…

      // await expect(
      //   battleLogService.getBattleLogs({
      //     startDate: '2025-11-01',
      //     endDate: '2025-11-04',
      //     limit: 10,
      //     offset: 0,
      //   })
      // ).rejects.toThrow('timeout');

      expect(mockBlobClient.getBattleLogs).toBeDefined(); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¢ãƒƒã‚¯ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ ğŸ”µ
    });

    test('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ã®å‹•ä½œã‚’æ¤œè¨¼
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ä¸€æ™‚çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼å¾Œã®ãƒªãƒˆãƒ©ã‚¤å‹•ä½œ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ä¸€æ™‚çš„ãªéšœå®³ã«å¯¾ã™ã‚‹è€æ€§ã‚’æŒã¤ã“ã¨
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é»„ä¿¡å·ï¼ˆrequirements.md Lines 519-536ã§è¨€åŠã€ãƒªãƒˆãƒ©ã‚¤å›æ•°ã¯æ¨æ¸¬ï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æœ€åˆã¯å¤±æ•—ã—ã€ãƒªãƒˆãƒ©ã‚¤ã§æˆåŠŸã™ã‚‹ãƒ¢ãƒƒã‚¯ã‚’è¨­å®š
      let attemptCount = 0;
      mockBlobClient.getBattleLogs.mockImplementation(async () => {
        attemptCount++;
        if (attemptCount === 1) {
          // 1å›ç›®ã¯å¤±æ•—
          throw new Error('Network error');
        }
        // 2å›ç›®ä»¥é™ã¯æˆåŠŸ
        return [];
      });

      // TODO: ç¾åœ¨ã®å®Ÿè£…ã«ã¯ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ãŒãªã„ãŸã‚ã€ã“ã®ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã—ã¾ã™
      // Greenãƒ•ã‚§ãƒ¼ã‚ºã§ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„

      // ã€æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ã€‘: ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€1å›ç›®ã®ã‚¨ãƒ©ãƒ¼ã§å¤±æ•—

      // TODO: BattleLogService.getBattleLogs() ãƒ¡ã‚½ãƒƒãƒ‰ã¯ç¾åœ¨å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“
      expect(attemptCount).toBe(0); // ã€ç¢ºèªå†…å®¹ã€‘: ã¾ã å‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ ğŸ”µ
      // ã€ç¢ºèªå†…å®¹ã€‘: ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ãŒæœªå®Ÿè£…ã®ãŸã‚ã€å®Ÿè£…å¾Œã«ã“ã®ãƒ†ã‚¹ãƒˆã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ ğŸ”´

      // ã€Greenãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…ã™ã¹ãå†…å®¹ã€‘:
      // - ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ã®å®Ÿè£…ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
      // - ãƒªãƒˆãƒ©ã‚¤å›æ•°ã®è¨­å®šï¼ˆä¾‹: 3å›ï¼‰
      // - ãƒªãƒˆãƒ©ã‚¤é–“éš”ã®è¨­å®šï¼ˆä¾‹: 100ms, 200ms, 400msï¼‰
    });
  });

  // =============================================================================
  // 2. ä¸¦åˆ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†
  // =============================================================================

  describe('TC-EDGE-002: ä¸¦åˆ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†', () => {
    /**
     * ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ä¸¦åˆ—å‡¦ç†ã®å®‰å…¨æ€§ã‚’æ¤œè¨¼
     * ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: è¤‡æ•°ã®ç™»éŒ²ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã¦ã‚‚æ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
     * ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã§ã‚‚ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãŒä¿ãŸã‚Œã‚‹ã“ã¨
     * ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é»„ä¿¡å·ï¼ˆtestcases.md Lines 897-922ã€ä¸¦åˆ—å‡¦ç†ã®è©³ç´°ã¯æ¨æ¸¬ï¼‰
     */
    test('è¤‡æ•°ã®ç™»éŒ²ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã¦ã‚‚æ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å®Ÿé‹ç”¨ã§ã®åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: 3ã¤ã®ç•°ãªã‚‹å¯¾æˆ¦å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦åˆ—ã§ç™»éŒ²

      const testData = [
        {
          date: '2025-11-04',
          battleType: 'ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ' as const,
          rank: 'ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰' as const,
          group: 'AA' as const,
          myDeckId: 'deck-001',
          turn: 'å…ˆæ”»' as const,
          result: 'å‹ã¡' as const,
          opponentDeckId: 'deck-101',
        },
        {
          date: '2025-11-04',
          battleType: 'ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ' as const,
          rank: 'ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰' as const,
          group: 'AA' as const,
          myDeckId: 'deck-002',
          turn: 'å¾Œæ”»' as const,
          result: 'è² ã‘' as const,
          opponentDeckId: 'deck-102',
        },
        {
          date: '2025-11-04',
          battleType: 'å¯¾æˆ¦å°' as const,
          rank: '-' as const,
          group: '-' as const,
          myDeckId: 'deck-003',
          turn: 'å…ˆæ”»' as const,
          result: 'å‹ã¡' as const,
          opponentDeckId: 'deck-103',
        },
      ];

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: 3ã¤ã®ç™»éŒ²ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: Promise.all() ã‚’ä½¿ç”¨ã—ã¦ä¸¦åˆ—å®Ÿè¡Œ
      const promises = testData.map((data) => battleLogService.createBattleLog(data));

      const results = await Promise.all(promises);

      // ã€çµæœæ¤œè¨¼ã€‘: ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 3ã¤ã®çµæœãŒã™ã¹ã¦è¿”ã•ã‚Œã‚‹
      expect(results).toBeDefined(); // ã€ç¢ºèªå†…å®¹ã€‘: çµæœãŒè¿”ã•ã‚Œã‚‹ ğŸ”µ
      expect(results.length).toBe(3); // ã€ç¢ºèªå†…å®¹ã€‘: 3ã¤ã®çµæœãŒè¿”ã•ã‚Œã‚‹ ğŸ”µ

      // ã€è¿½åŠ æ¤œè¨¼ã€‘: ç”Ÿæˆã•ã‚Œã‚‹IDãŒé‡è¤‡ã—ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
      const ids = results.map((r) => r.id);
      const uniqueIds = new Set(ids);
      expect(uniqueIds.size).toBe(3); // ã€ç¢ºèªå†…å®¹ã€‘: IDãŒé‡è¤‡ã—ã¦ã„ãªã„ ğŸŸ¡

      // ã€è¿½åŠ æ¤œè¨¼ã€‘: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      results.forEach((result, index) => {
        expect(result.id).toBeDefined(); // ã€ç¢ºèªå†…å®¹ã€‘: IDãŒç”Ÿæˆã•ã‚Œã‚‹ ğŸ”µ
        expect(result.battleType).toBe(testData[index]?.battleType); // ã€ç¢ºèªå†…å®¹ã€‘: å¯¾æˆ¦ã‚¿ã‚¤ãƒ—ãŒä¿å­˜ã•ã‚Œã‚‹ ğŸ”µ
        expect(result.result).toBe(testData[index]?.result); // ã€ç¢ºèªå†…å®¹ã€‘: å¯¾æˆ¦çµæœãŒä¿å­˜ã•ã‚Œã‚‹ ğŸ”µ
      });
    });

    test('ä¸¦åˆ—å®Ÿè¡Œæ™‚ã®ãƒ‡ãƒ¼ã‚¿ç«¶åˆãŒç™ºç”Ÿã—ãªã„', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ‡ãƒ¼ã‚¿ç«¶åˆã®é˜²æ­¢ã‚’æ¤œè¨¼
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: åŒä¸€æ—¥ä»˜ã®è¤‡æ•°ç™»éŒ²ã§IDç”ŸæˆãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: IDç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ãŒä¸¦åˆ—å®Ÿè¡Œã«å¯¾å¿œã—ã¦ã„ã‚‹ã“ã¨
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é»„ä¿¡å·ï¼ˆrequirements.md Lines 554-580ã§è¨€åŠï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: åŒä¸€æ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’10ä»¶ä¸¦åˆ—ç™»éŒ²
      const sameDate = '2025-11-04';
      const testData = Array.from({ length: 10 }, (_, i) => ({
        date: sameDate,
        battleType: 'ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ' as const,
        rank: 'ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰' as const,
        group: 'AA' as const,
        myDeckId: `deck-${String(i).padStart(3, '0')}`,
        turn: 'å…ˆæ”»' as const,
        result: 'å‹ã¡' as const,
        opponentDeckId: 'deck-101',
      }));

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: 10ä»¶ã®ç™»éŒ²ã‚’ä¸¦åˆ—å®Ÿè¡Œ
      const promises = testData.map((data) => battleLogService.createBattleLog(data));
      const results = await Promise.all(promises);

      // ã€çµæœæ¤œè¨¼ã€‘: IDãŒé‡è¤‡ã—ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
      const ids = results.map((r) => r.id);
      const uniqueIds = new Set(ids);
      expect(uniqueIds.size).toBe(10); // ã€ç¢ºèªå†…å®¹ã€‘: 10å€‹ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDãŒç”Ÿæˆã•ã‚Œã‚‹ ğŸŸ¡
      expect(ids.length).toBe(10); // ã€ç¢ºèªå†…å®¹ã€‘: 10ä»¶ã™ã¹ã¦ãŒç™»éŒ²ã•ã‚Œã‚‹ ğŸ”µ

      // ã€è¿½åŠ æ¤œè¨¼ã€‘: IDã®å½¢å¼ãŒæ­£ã—ã„ã“ã¨ã‚’ç¢ºèª
      // ã€IDå½¢å¼ã€‘: log_YYYYMMDD_NNN_timestamp_microseconds_randomï¼ˆä¸¦åˆ—å®Ÿè¡Œå¯¾å¿œï¼‰
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é»„ä¿¡å·ï¼ˆIDå½¢å¼ã¯ä¸¦åˆ—å®Ÿè¡Œå¯¾å¿œã®ãŸã‚æ‹¡å¼µï¼‰
      ids.forEach((id) => {
        expect(id).toMatch(/^log_\d{8}_\d{3}_\d+_\d+_[a-z0-9]{6}$/); // ã€ç¢ºèªå†…å®¹ã€‘: IDãŒä¸¦åˆ—å®Ÿè¡Œå¯¾å¿œå½¢å¼ ğŸŸ¡
      });
    });
  });

  // =============================================================================
  // 3. å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  // =============================================================================

  describe('TC-EDGE-003: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆ1000ä»¶ï¼‰', () => {
    /**
     * ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®æ€§èƒ½ã‚’æ¤œè¨¼
     * ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: 1000ä»¶ã®å¯¾æˆ¦å±¥æ­´ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã‚‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè¨±å®¹ç¯„å›²å†…
     * ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã‚‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã›ãšå‡¦ç†ã§ãã‚‹ã“ã¨
     * ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é»„ä¿¡å·ï¼ˆtestcases.md Lines 924-955ã€1000ä»¶ã¨ã„ã†æ•°å€¤ã¯å®Ÿç”¨çš„ãªæ¨æ¸¬ï¼‰
     */
    test('1000ä»¶ã®å¯¾æˆ¦å±¥æ­´ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã‚‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè¨±å®¹ç¯„å›²å†…', async () => {
      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å¹´é–“ã®ãƒ—ãƒ¬ã‚¤å±¥æ­´ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹æƒ³å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: 1000ä»¶ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ

      const largeData = Array.from({ length: 1000 }, (_, i) => ({
        date: '2025-11-04',
        battleType: 'ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ',
        rank: 'ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰',
        group: 'AA',
        myDeckId: `deck-${String(i % 10).padStart(3, '0')}`,
        turn: i % 2 === 0 ? 'å…ˆæ”»' : 'å¾Œæ”»',
        result: i % 3 === 0 ? 'å‹ã¡' : 'è² ã‘',
        opponentDeckId: `deck-${String(i % 20).padStart(3, '0')}`,
      }));

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: 1000ä»¶ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: ImportService.importFromJson() ã‚’å‘¼ã³å‡ºã—
      const startTime = Date.now();

      const importResult = await importService.importFromJson(JSON.stringify(largeData));

      const endTime = Date.now();
      const processingTime = endTime - startTime;

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒæˆåŠŸã—ã€å‡¦ç†æ™‚é–“ãŒè¨±å®¹ç¯„å›²å†…ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 1000ä»¶ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã€10ç§’ä»¥å†…ã«å‡¦ç†ãŒå®Œäº†ã™ã‚‹
      expect(importResult).toBeDefined(); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœãŒè¿”ã•ã‚Œã‚‹ ğŸ”µ
      expect(importResult.imported).toBe(1000); // ã€ç¢ºèªå†…å®¹ã€‘: 1000ä»¶ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸ ğŸŸ¡
      expect(importResult.errors).toBe(0); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ä»¶æ•°ãŒ0 ğŸ”µ
      expect(processingTime).toBeLessThan(10000); // ã€ç¢ºèªå†…å®¹ã€‘: å‡¦ç†æ™‚é–“ãŒ10ç§’ä»¥å†… ğŸŸ¡
    });

    test('å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒé©åˆ‡', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®é˜²æ­¢ã‚’æ¤œè¨¼
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†å¾Œã‚‚ãƒ¡ãƒ¢ãƒªãŒé©åˆ‡ã«è§£æ”¾ã•ã‚Œã‚‹ã“ã¨
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒåˆ¶å¾¡ã•ã‚Œã¦ã„ã‚‹ã“ã¨
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é»„ä¿¡å·ï¼ˆè¦ä»¶å®šç¾©ã«æ˜è¨˜ãªã—ã€å®Ÿç”¨çš„ãªæ¨æ¸¬ï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°å›ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      const largeData = Array.from({ length: 500 }, () => ({
        date: '2025-11-04',
        battleType: 'ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ',
        rank: 'ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰',
        group: 'AA',
        myDeckId: 'deck-001',
        turn: 'å…ˆæ”»',
        result: 'å‹ã¡',
        opponentDeckId: 'deck-101',
      }));

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: 2å›ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ
      const result1 = await importService.importFromJson(JSON.stringify(largeData));

      const result2 = await importService.importFromJson(JSON.stringify(largeData));

      // ã€çµæœæ¤œè¨¼ã€‘: ä¸¡æ–¹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(result1.imported).toBe(500); // ã€ç¢ºèªå†…å®¹ã€‘: 1å›ç›®ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒæˆåŠŸ ğŸ”µ
      expect(result2.imported).toBe(500); // ã€ç¢ºèªå†…å®¹ã€‘: 2å›ç›®ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒæˆåŠŸ ğŸ”µ

      // ã€ãƒ¡ãƒ¢ãƒªæ¤œè¨¼ã€‘: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒç•°å¸¸ã«å¢—åŠ ã—ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
      // Note: Node.jsã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯ã¯ç’°å¢ƒä¾å­˜ã®ãŸã‚ã€å®Ÿè£…æ™‚ã«æ¤œè¨
      const memoryUsage = process.memoryUsage();
      expect(memoryUsage.heapUsed).toBeLessThan(500 * 1024 * 1024); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ’ãƒ¼ãƒ—ä½¿ç”¨é‡ãŒ500MBæœªæº€ ğŸŸ¡
    });

    test('å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®ãƒãƒƒãƒå‡¦ç†', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒãƒƒãƒå‡¦ç†ã®åŠ¹ç‡æ€§ã‚’æ¤œè¨¼
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: 1000ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒé©åˆ‡ãªãƒãƒƒãƒã‚µã‚¤ã‚ºã§å‡¦ç†ã•ã‚Œã‚‹ã“ã¨
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ãªãƒãƒƒãƒå‡¦ç†ãŒè¡Œã‚ã‚Œã‚‹ã“ã¨
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é»„ä¿¡å·ï¼ˆãƒãƒƒãƒå‡¦ç†ã®è©³ç´°ã¯è¦ä»¶å®šç¾©ã«æ˜è¨˜ãªã—ï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: 1000ä»¶ã®CSVãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
      const csvHeader = 'date,battleType,rank,group,myDeckId,turn,result,opponentDeckId';
      const csvRows = Array.from(
        { length: 1000 },
        (_, i) =>
          `2025-11-04,ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ,ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰,AA,deck-${i % 10},å…ˆæ”»,${i % 2 === 0 ? 'å‹ã¡' : 'è² ã‘'},deck-${i % 20}`
      );
      const csvData = [csvHeader, ...csvRows].join('\n');

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ
      const importResult = await importService.importFromCsv(csvData);

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(importResult.imported).toBe(1000); // ã€ç¢ºèªå†…å®¹ã€‘: 1000ä»¶ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸ ğŸŸ¡
      expect(importResult.errors).toBe(0); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ä»¶æ•°ãŒ0 ğŸ”µ

      // ã€Greenãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…ã™ã¹ãå†…å®¹ã€‘:
      // - ãƒãƒƒãƒã‚µã‚¤ã‚ºã®è¨­å®šï¼ˆä¾‹: 100ä»¶ã”ã¨ï¼‰
      // - ãƒãƒƒãƒå‡¦ç†ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
      // - ãƒãƒƒãƒé–“ã®ãƒ¡ãƒ¢ãƒªè§£æ”¾
    });
  });

  // =============================================================================
  // 4. ãã®ä»–ã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
  // =============================================================================

  describe('TC-EDGE-004: ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†', () => {
    /**
     * ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ç‰¹æ®Šæ–‡å­—ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’æ¤œè¨¼
     * ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒ‡ãƒƒã‚­åã«ç‰¹æ®Šæ–‡å­—ãŒå«ã¾ã‚Œã‚‹å ´åˆã®å‡¦ç†
     * ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ç‰¹æ®Šæ–‡å­—ãŒæ­£ã—ãã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¦ä¿å­˜ã•ã‚Œã‚‹ã“ã¨
     * ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é»„ä¿¡å·ï¼ˆè¦ä»¶å®šç¾©ã«æ˜è¨˜ãªã—ã€å®Ÿç”¨çš„ãªæ¨æ¸¬ï¼‰
     */
    test('ãƒ‡ãƒƒã‚­åã«ç‰¹æ®Šæ–‡å­—ãŒå«ã¾ã‚Œã¦ã‚‚æ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€ãƒ‡ãƒƒã‚­åã‚’ç”¨æ„
      const specialCharData = {
        date: '2025-11-04',
        battleType: 'ãƒ©ãƒ³ã‚¯ãƒãƒƒãƒ' as const,
        rank: 'ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰' as const,
        group: 'AA' as const,
        myDeckId: 'deck-"test"<script>alert(1)</script>',
        turn: 'å…ˆæ”»' as const,
        result: 'å‹ã¡' as const,
        opponentDeckId: 'deck-101',
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€ãƒ‡ãƒ¼ã‚¿ã§ç™»éŒ²
      const result = await battleLogService.createBattleLog(specialCharData);

      // ã€çµæœæ¤œè¨¼ã€‘: ç‰¹æ®Šæ–‡å­—ãŒã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¦ä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(result).toBeDefined(); // ã€ç¢ºèªå†…å®¹ã€‘: ç™»éŒ²ãŒæˆåŠŸã™ã‚‹ ğŸ”µ
      expect(result.myDeckId).toContain('test'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ‡ãƒƒã‚­åãŒä¿å­˜ã•ã‚Œã‚‹ ğŸŸ¡
      // XSSæ”»æ’ƒã®é˜²æ­¢
      expect(result.myDeckId).not.toContain('<script>'); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ãŒã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã‚‹ ğŸŸ¡
    });
  });
});
